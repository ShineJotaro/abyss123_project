<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>abyss_123çš„é¤å…è¯„é‰´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'best': '#10b981', // Emerald 500
                        'good': '#3b82f6', // Blue 500
                        'caneat': '#f59e0b', // Amber 500
                        'bad': '#ef4444', // Red 500
                        'primary-blue': '#3b82f6',
                        'ai-sparkle': '#f97316', // Orange 500
                        'useful': '#6366f1', // Indigo 500
                        'admin-red': '#dc2626', // Red 600
                    }
                }
            }
        }
    </script>
    <style>
        .loading-hidden { display: none; }
        /* å¯¼èˆªä¸‹æ‹‰èœå•æ ·å¼ */
        .dropdown-menu {
            transition: all 0.3s ease-out;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
        }
        .dropdown-hover:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* å³ä¸‹è§’å›ºå®šæŒ‰é’® */
        .admin-entry-btn {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans min-h-screen">

    <div id="terms-and-conditions-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-8 transform transition-all">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">æœåŠ¡æ¡æ¬¾ä¸å…è´£å£°æ˜ / Terms & Conditions and Disclaimer</h2>
            
            <div class="text-sm text-gray-700 space-y-4 mb-6 pr-4">

                <h3 class="font-semibold text-lg text-primary-blue mt-4">æ ¸å¿ƒå…è´£å£°æ˜ (Core Disclaimer)</h3>
                <p class="font-medium text-red-600 border-l-4 border-red-500 pl-3 py-1 bg-red-50/50">
                    **é‡è¦å£°æ˜:** ä»¥ä¸Šæ‰€æœ‰æ¨èå†…å®¹ä»…ä»¥æˆ‘ï¼ˆabyss_123ï¼‰**åƒåˆ°é£Ÿç‰©çš„å½“ä¸‹ä¸ºæ ‡å‡†**ã€‚æˆ‘ä»¬ä¸å¯¹é¤å…åç»­çš„è¿›æ­¥æˆ–é€€æ­¥æ‰€å¯¼è‡´çš„é—®é¢˜æ‰¿æ‹…ä»»ä½•è´£ä»»ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºé£Ÿç‰©ä¸­æ¯’ã€é£Ÿç‰©å£å‘³ä¸ä½³æˆ–æ‚¨è®¤ä¸ºæˆ‘æœªæ¨èä½†å®é™…å¾ˆç¾å‘³çš„é£Ÿç‰©ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯¹ç”¨æˆ·æˆ–é¤å…å¯¹å½¼æ­¤çš„æ€¨è¨€ã€è¡ŒåŠ¨æˆ–ä»»ä½•æ³•å¾‹è´£ä»»ä¸è´Ÿè´£ä»»ã€‚æ‚¨å¿…é¡»æ¥å—æ­¤æ¡æ¬¾æ‰èƒ½ç»§ç»­ä½¿ç”¨æœ¬ç½‘ç«™ã€‚
                </p>

                <p class="font-medium text-red-600 border-l-4 
border-red-500 pl-3 py-1 bg-red-50/50">
                    **Crucial Disclaimer:** All recommendations herein are based **solely on the quality of the food at the moment I (abyss_123) consumed it**.
                    We are not responsible for any issues arising from the restaurant's subsequent improvement or deterioration, including but not limited to food poisoning, bad taste, or highly-rated food that I did not recommend.
                    Furthermore, we are not liable for any user or restaurant grievances, actions, or legal matters directed at each other.
                    You must accept this term to proceed.
                </p>

                <h3 class="font-semibold text-lg text-gray-700 mt-6">æ ‡å‡†æœåŠ¡æ¡æ¬¾ (Standard Terms of Service)</h3>
                <p>
                    **Cookie æ”¿ç­–:** æœ¬ç½‘ç«™ä½¿ç”¨ Cookieï¼ˆæˆ–æœ¬åœ°å­˜å‚¨ï¼‰æ¥å­˜å‚¨æ‚¨çš„åå¥½è®¾ç½®å’Œä¼šè¯çŠ¶æ€ï¼ˆåŒ…æ‹¬æ‚¨æ¥å—æ­¤æ¡æ¬¾çš„çŠ¶æ€ï¼‰ã€‚é€šè¿‡ä½¿ç”¨æœ¬ç½‘ç«™ï¼Œæ‚¨åŒæ„æˆ‘ä»¬æ ¹æ®æˆ‘ä»¬çš„ Cookie æ”¿ç­–ä½¿ç”¨ Cookieã€‚
                </p>
           
                <p>
                    **éšç§æ”¿ç­–:** æˆ‘ä»¬é‡è§†æ‚¨çš„éšç§ã€‚æˆ‘ä»¬ä»…æ”¶é›†å’Œä½¿ç”¨ä¸ºæä¾›åŸºæœ¬æœåŠ¡ï¼ˆå¦‚ç”¨æˆ·è®¤è¯ã€ç‚¹èµåŠŸèƒ½ï¼‰æ‰€å¿…éœ€çš„æ•°æ®ï¼Œä¾‹å¦‚æ‚¨çš„ Google ç”¨æˆ·IDã€‚æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼ˆå¦‚è¯„è®ºæˆ–å›¾ç‰‡ï¼‰ä¸ä¼šè¢«å…¬å¼€åˆ†äº«ç»™ç¬¬ä¸‰æ–¹ï¼Œé™¤éæ³•å¾‹è¦æ±‚ã€‚
                </p>
                <p>
                    **ä½¿ç”¨é™åˆ¶:** æ‚¨åŒæ„ä¸ä»¥ä»»ä½•éæ³•ã€æœ‰å®³æˆ–ä¾µçŠ¯ä»–äººæƒåˆ©çš„æ–¹å¼ä½¿ç”¨æœ¬ç½‘ç«™ã€‚
                </p>

   
                <h3 class="font-semibold text-lg text-gray-700 mt-6">Standard Terms of Service</h3>
                <p>
                    **Cookie Policy:** This site uses cookies (or local storage) to store your preferences and session status (including your acceptance of these terms).
                    By using this site, you consent to our use of cookies in accordance with our Cookie Policy.
                </p>
                <p>
                    **Privacy Policy:** We value your privacy.
                    We only collect and use data necessary for providing essential services (such as user authentication, and like features), such as your Google User ID.
                    Your personal information (such as comments or images) will not be publicly shared with third parties unless required by law.
                </p>
                <p>
                    **Use Restrictions:** You agree not to use this site in any manner that is unlawful, harmful, or infringes upon the rights of others.
                </p>
            </div>

            <div class="flex justify-end space-x-4 border-t pt-4">
                <button id="decline-terms-btn" class="px-6 py-2 text-base font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    ä¸æ¥å—å¹¶é€€å‡º (Decline & Exit)
                </button>
      
                <button id="accept-terms-btn" class="px-6 py-2 text-base font-medium text-white bg-primary-blue rounded-lg hover:bg-blue-600 transition">
                    æˆ‘æ¥å—æ¡æ¬¾ (I Accept the Terms)
                </button>
            </div>
        </div>
    </div>

    <div id="loading-indicator" class="fixed inset-0 bg-white/70 flex items-center justify-center z-50 hidden">
   
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        
            </svg>
            <p class="mt-2 text-sm text-primary-blue">åº”ç”¨åˆå§‹åŒ–ä¸­...</p>
        </div>
    </div>

    <header class="bg-white shadow-md sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
             
                    <div class="text-xl font-bold text-gray-900">abyss_123çš„é¤å…è¯„é‰´</div>
                </div>
                <div class="flex items-center space-x-4">
                    <nav id="region-nav" class="flex space-x-4 no-scrollbar overflow-x-auto py-2">
                        <p class="text-gray-400 text-sm">åŠ è½½åœ°åŒº...</p>
   
                    </nav>
                    <button id="auth-button" class="px-4 py-2 rounded-lg text-sm font-medium text-white bg-primary-blue hover:bg-blue-600 transition duration-150 whitespace-nowrap">
                        ä½¿ç”¨ Gmail ç™»å½•
                    </button>
     
                </div>
            </div>
        </div>
    </header>

    <div id="app-container" class="max-w-4xl mx-auto p-4 sm:p-8 opacity-0 transition-opacity duration-500 hidden">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">æˆ‘çš„é¤å…è¯„é‰´</h1>
            <p class="text-gray-500">è®°å½•æˆ‘çš„ç”¨é¤ä½“éªŒï¼Œå¹¶ä½¿ç”¨ AI æ€»ç»“ã€‚</p>
           
            <div id="user-info" class="mt-4 text-sm bg-gray-100 p-2 rounded-lg shadow-inner">
                <p class="text-gray-600">
                    å½“å‰ç”¨æˆ·ID: <span id="current-user-id" class="font-mono font-semibold text-gray-800">åŠ è½½ä¸­...</span>
                    <span id="owner-status" class="ml-2 px-2 py-0.5 rounded-full text-xs font-medium"></span>
                </p>
       
                <button id="manage-regions-btn" class="mt-2 text-sm text-primary-blue hover:text-blue-600 font-medium hidden">
                    ç®¡ç†å›½å®¶/å·å±
                </button>
            </div>

            <button id="show-rating-standard-btn" class="mt-3 px-4 py-2 rounded-lg text-sm font-medium text-white bg-indigo-500 hover:bg-indigo-600 transition duration-150">
                è¯„åˆ†æ ‡å‡†è¯´æ˜
            </button>
            </header>

        <section id="add-review-section" class="mb-10 bg-white p-6 rounded-xl shadow-lg border border-gray-100 hidden">
           
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">æ·»åŠ æ–°è®°å½• (æ”¯æŒå›¾ç‰‡)</h2>
            <form id="add-review-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="review-country" class="block text-sm font-medium text-gray-700">å›½å®¶/åœ°åŒº</label>
                        <select id="review-country" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue transition bg-white">
                            <option value="">é€‰æ‹©å›½å®¶/åœ°åŒº</option>
                            </select>
                    </div>
                    <div>
                        <label for="review-state" class="block text-sm font-medium text-gray-700">å·å±/åŸå¸‚</label>
                        <select id="review-state" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue transition bg-white" disabled>
                            <option value="">å…ˆé€‰æ‹©å›½å®¶/åœ°åŒº</option>
                            </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="restaurant-name" class="block text-sm font-medium text-gray-700">é¤å…åç§°</label>
         
                        <input type="text" id="restaurant-name" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue transition">
                    </div>
                    <div>
                        <label for="address" class="block text-sm font-medium text-gray-700">åœ°å€ (å¯é€‰)</label>
  
                        <input type="text" id="address" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue transition" placeholder="é¤å…çš„å…·ä½“åœ°å€">
                    </div>
                </div>
                
             
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="category" class="block text-sm font-medium text-gray-700">ç±»åˆ«</label>
                        <select id="category" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue transition bg-white">
       
                            <option value="">é€‰æ‹©ç±»åˆ«</option>
                            <option value="ä¸­é¤">ä¸­é¤</option>
                            <option value="è¥¿é¤">è¥¿é¤</option>
                    
                            <option value="æ—¥éŸ©æ–™ç†">æ—¥éŸ©æ–™ç†</option>
                            <option value="å’–å•¡å…/ç”œå“">å’–å•¡å…/ç”œå“</option>
                            <option value="å¿«é¤/å°åƒ">å¿«é¤/å°åƒ</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
    
                        </select>
                    </div>
                    <div>
                        <label for="status" class="block text-sm font-medium text-gray-700">è¯„åˆ†çŠ¶æ€</label>
           
                        <select id="status" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue transition bg-white">
                            <option value="">é€‰æ‹©è¯„åˆ†</option>
                            <option value="Best">Best ğŸ˜† (æœ€ä½³)</option>
              
                            <option value="Good">Good ğŸ˜ (ä¸é”™)</option>
                            <option value="Can eat">Can eat ğŸ™‚ (å¯ä»¥åƒ)</option>
                            <option value="Bad">Bad ğŸ˜  (å·®è¯„)</option>
                   
                        </select>
                    </div>
                </div>

                <div>
                    <label for="comment" class="block text-sm font-medium text-gray-700">è¯„è®º/ç®€è¿°</label>
                  
                    <textarea id="comment" rows="3" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue transition"></textarea>
                </div>

                <div>
                    <label for="image-upload" class="block text-sm font-medium text-gray-700">ä¸Šä¼ å›¾ç‰‡ (å¯é€‰ï¼ŒPNG/JPG)</label>
                    <input type="file" id="image-upload" accept="image/png, image/jpeg" class="mt-1 block 
w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-blue/10 file:text-primary-blue hover:file:bg-primary-blue/20">
                </div>

                <button type="submit" id="submit-btn" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-primary-blue hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-blue transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    <span id="btn-text">æ·»åŠ è®°å½•</span>
            
                </button>
                <p id="error-message" class="text-sm text-bad mt-2 hidden"></p>
            </form>
        </section>

        <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4 border-b pb-2">æˆ‘çš„ç”¨é¤è®°å½•</h2>

            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-3 sm:space-y-0">
   
                <div id="filter-buttons" class="flex space-x-2 flex-wrap">
                    </div>
                <p id="total-count" class="text-sm text-gray-500">æ€»å…± 0 æ¡è®°å½•</p>
            </div>

            <div id="reviews-list" class="space-y-4">
                
                <p id="empty-message" class="text-center text-gray-400 p-8 border-2 border-dashed rounded-lg hidden">
                    ä¸»äººè¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•è®°å½•ï¼
                </p>
            </div>
        </section>

         <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 hidden items-center justify-center p-4" aria-modal="true" role="dialog">
            <div id="modal-content-container" class="bg-white 
rounded-lg shadow-xl w-full max-w-lg p-6 transform transition-all">
                <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 focus:outline-none" aria-label="Close modal" onclick="document.getElementById('custom-modal').classList.add('hidden');
document.getElementById('custom-modal').classList.remove('flex');">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <h3 id="modal-title" class="text-lg font-bold text-gray-900 mb-4 border-b pb-2"></h3>
                <div id="modal-body">
        
                    <p id="modal-content" class="text-sm text-gray-600 mb-6"></p>
                </div>
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="modal-cancel-btn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition hidden">
                 
                        å…³é—­
                    </button>
                    <button id="modal-confirm-btn" class="px-4 py-2 text-sm font-medium text-white bg-primary-blue rounded-lg hover:bg-blue-600 transition">
                        ç¡®å®š
                   
                    </button>
                </div>
            </div>
        </div>

        <div id="region-manager-content" class="hidden">
            <div class="space-y-4">
                <form id="add-region-form" class="space-y-2 border p-3 rounded-lg bg-gray-50">
                  
                    <p class="font-semibold text-gray-700">æ·»åŠ æ–°çš„å›½å®¶/å·å±</p>
                    <div class="flex space-x-2">
                        <input type="text" id="new-country" required placeholder="å›½å®¶ (å¦‚: MY)" class="w-1/3 rounded-lg border-gray-300 shadow-sm p-2 text-sm">
                        <input type="text" id="new-state" required placeholder="å·å±/åŸå¸‚ (å¦‚: KL)" class="w-1/3 rounded-lg border-gray-300 shadow-sm p-2 text-sm">
  
                        <button type="submit" class="w-1/3 py-2 text-sm font-medium text-useful rounded-lg hover:bg-indigo-600 transition">æ·»åŠ </button>
                    </div>
                </form>

                <div class="border p-3 rounded-lg bg-white">
            
                    <p class="font-semibold text-gray-700 mb-2 border-b pb-1">å·²æ·»åŠ çš„åœ°åŒº</p>
                    <div id="region-list-modal" class="max-h-60 overflow-y-auto space-y-1">
                        <p class="text-sm text-gray-400">æš‚æ— åœ°åŒºä¿¡æ¯ã€‚</p>
                    </div>
                </div>
 
            </div>
        </div>
        
        <div id="admin-login-content" class="hidden">
            <form id="admin-login-form" class="space-y-4">
                <p class="text-sm text-gray-600">è¯·ä½¿ç”¨ç®¡ç†å‘˜é‚®ç®±å’Œå¯†ç è¿›è¡Œç™»å½•ã€‚</p>
                <div>
               
                    <label for="admin-email" class="block text-sm font-medium text-gray-700">ç®¡ç†å‘˜é‚®ç®± (Gmail)</label>
                    <input type="email" id="admin-email" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-admin-red focus:border-admin-red transition">
                </div>
                <div>
                    <label for="admin-password" class="block text-sm 
font-medium text-gray-700">å¯†ç </label>
                    <input type="password" id="admin-password" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-admin-red focus:border-admin-red transition">
                </div>
                <button type="submit" id="admin-submit-btn" class="w-full py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-admin-red hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-admin-red transition duration-150 ease-in-out">
             
                        ç™»å½•ä¸ºç®¡ç†å‘˜
                </button>
                <p id="admin-error-message" class="text-sm text-bad mt-2 hidden text-center"></p>
            </form>
        </div>


    </div>

    <div class="max-w-7xl mx-auto p-4 sm:p-8 mt-12">
        <div class="ads-container p-4 bg-gray-100 rounded-xl text-center">
         
            <p class="text-sm text-gray-500 mb-2">å¹¿å‘ŠèµåŠ©å•†å†…å®¹</p>
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9923429709566940"
                crossorigin="anonymous"></script>
            <ins class="adsbygoogle"
                style="display:block;
min-height: 100px;"
                data-ad-format="autorelaxed"
                data-ad-client="ca-pub-9923429709566940"
                data-ad-slot="7327876978"></ins>
            <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
       
        </div>
    </div>
    
    <button id="admin-login-entry" class="admin-entry-btn px-4 py-2 rounded-full text-xs font-medium text-white bg-gray-700 hover:bg-gray-800 shadow-lg transition duration-150">
        ç®¡ç†å‘˜å…¥å£
    </button>

    <script type="module">
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, collection, 
            query, orderBy, onSnapshot, where,
            addDoc, deleteDoc, doc, setDoc, updateDoc, getDocs,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getStorage, ref, uploadBytes, getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        // è®¾ç½® Firebase æ—¥å¿—çº§åˆ«
        setLogLevel('Debug');
        // --- å…¨å±€é…ç½®å’Œå˜é‡ ---
        let db, auth, storage, userId = null;
        let isOwner = false;
        let isLoggedIn = false; 
        let reviews = [];
        let likesMap = {};
        // { reviewId: count, ... }
        let currentFilter = 'All'; // 'All', 'Best', 'Good', 'Can eat', 'Bad'
        let currentRegionFilter = { countryCode: 'All', stateName: 'All' }; // { countryCode: 'MY', stateName: 'KL' }
        let allRegions = []; // å­˜å‚¨æ‰€æœ‰åœ°åŒºä¿¡æ¯
        
        // --- æ ¸å¿ƒé…ç½®å’Œå˜é‡ ---
        // **è¯·ç¡®ä¿æ‚¨çš„ç®¡ç†å‘˜è´¦æˆ·çš„ UID ä¸æ­¤ OWNER_ID åŒ¹é…**
        const OWNER_ID = '02949447418893306369';
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const API_KEY = "";
        // ç”± Canvas è¿è¡Œæ—¶æä¾›
        const GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025';
        
        // é»˜è®¤åœ°åŒºåˆ—è¡¨ (æ–°å¢)
        const DEFAULT_REGIONS = [
            // Malaysia (MY) States and Federal Territories
            { country: 'MY', state: 'Johor', sortOrder: 1 },
            { country: 'MY', state: 'Kedah', sortOrder: 2 },
            { country: 'MY', state: 'Kelantan', sortOrder: 3 },
            { country: 'MY', state: 'Melaka', sortOrder: 4 },
            { country: 'MY', state: 'Negeri Sembilan', sortOrder: 5 },
            { country: 'MY', state: 'Pahang', sortOrder: 6 },
            { country: 'MY', state: 'Perak', sortOrder: 7 },
            { country: 'MY', state: 'Perlis', sortOrder: 8 },
            { country: 'MY', state: 'Pulau Pinang', sortOrder: 9 },
            { country: 'MY', state: 'Sabah', sortOrder: 10 },
            { country: 'MY', state: 'Sarawak', sortOrder: 11 },
            { country: 'MY', state: 'Selangor', sortOrder: 12 },
            { country: 'MY', state: 'Terengganu', sortOrder: 13 },
            { country: 'MY', state: 'Kuala Lumpur', sortOrder: 14 },
            { country: 'MY', state: 'Putrajaya', sortOrder: 15 },
            { country: 'MY', state: 'Labuan', sortOrder: 16 },
            // Singapore (SG)
            { country: 'SG', state: 'Singapore', sortOrder: 100 },
        ];


        // è¯„åˆ†é…ç½®æ˜ å°„
        const RATING_CONFIG = {
            'Best': { emoji: 'ğŸ˜†', color: 'bg-best', text: 'æœ€ä½³' },
            'Good': { emoji: 'ğŸ˜', color: 'bg-good', text: 'ä¸é”™' },
            'Can eat': { emoji: 'ğŸ™‚', color: 'bg-caneat', text: 'å¯ä»¥åƒ' },
            'Bad': { emoji: 'ğŸ˜ ', color: 'bg-bad', text: 'å·®è¯„' },
            'All': { emoji: '', color: 'bg-primary-blue', text: 'å…¨éƒ¨' }
        };

        // --- è¯„åˆ†æ ‡å‡†è¯´æ˜å†…å®¹ (æ–°å¢) ---
        const RATING_EXPLANATION_HTML = `
            <div class="space-y-4">
                <h3 class="text-xl font-bold text-gray-900 border-b pb-2">é¤å…è¯„åˆ†æ ‡å‡†è¯´æ˜</h3>
                <p class="text-sm text-gray-700">
                    æœ¬é¤å…çš„è¯„åˆ†ç³»ç»Ÿåˆ†ä¸ºå››ä¸ªç­‰çº§ï¼š<span class="font-semibold text-best">æœ€ä½³ (Best)</span>ã€<span class="font-semibold text-good">ä¸é”™ (Good)</span>ã€<span class="font-semibold text-caneat">å¯ä»¥åƒ (Can eat)</span> å’Œ <span class="font-semibold text-bad">å·®è¯„ (Bad)</span>ã€‚è¿™äº›è¯„åˆ†æ˜¯åŸºäºä½œè€…ï¼ˆabyss_123ï¼‰çš„ä¸ªäººä½“éªŒå’Œåˆ¤æ–­ï¼Œ<span class="font-bold text-indigo-700">å¹¶ä¸æ€»æ˜¯ä»£è¡¨é¤å…çš„æ•´ä½“æ°´å¹³</span>ã€‚
                </p>
                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1 ml-4">
                    <li>**æœ€ä½³ (Best):** é€šå¸¸æŒ‡é¤å…çš„æŸé“èœå“æˆ–æŸæ–¹é¢ï¼ˆå¦‚åˆ›æ„ã€é£Ÿæè´¨é‡ï¼‰è¾¾åˆ°äº†è¶…è¶Šå…¶ä»–åŒç±»é¤å…çš„**å“è¶Šæ°´å¹³**ã€‚</li>
                    <li>**å·®è¯„ (Bad):** æœªå¿…æ˜¯ç¯å¢ƒæˆ–é£Ÿç‰©æœ¬èº«å­˜åœ¨ä¸¥é‡é—®é¢˜ã€‚<span class="font-medium text-red-500">æœ‰æ—¶å¯èƒ½æ˜¯æŒ‡æœåŠ¡ä½“éªŒæå·®ã€æ€§ä»·æ¯”è¿‡ä½ã€æˆ–æŸé“é£Ÿç‰©ä¸¥é‡ä¸ç¬¦åˆæœŸæœ›ã€‚</span></li>
                </ul>
                <p class="font-bold text-sm text-red-600 mt-3">
                    æœ€ç»ˆæ ‡å‡†: ä¸€åˆ‡è¯„åˆ†ç»†èŠ‚å’ŒåŸå› ï¼Œè¯·ä»¥è¯„è®ºæ ä¸­çš„**è¯¦ç»†æ–‡å­—æè¿°**ä¸ºå‡†ã€‚è¯·å‹¿ä»…å‡­æ˜Ÿçº§åˆ¤æ–­é¤å…ã€‚
                </p>
                
                <h3 class="text-xl font-bold text-gray-900 border-b pb-2 pt-4">Rating Standard Explanation</h3>
                <p class="text-sm text-gray-700">
                    The restaurant rating system is divided into four levels: <span class="font-semibold text-best">Best</span>, <span class="font-semibold text-good">Good</span>, <span class="font-semibold text-caneat">Can eat</span>, and <span class="font-semibold text-bad">Bad</span>. These ratings are based on the author's (abyss_123) personal experience and judgment, and <span class="font-bold text-indigo-700">do not always reflect the restaurant's overall quality</span>.
                </p>
                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1 ml-4">
                    <li>**Best:** Usually indicates that a specific dish or aspect of the restaurant (e.g., creativity, ingredient quality) has reached an **excellent level** that surpasses other comparable restaurants.</li>
                    <li>**Bad:** This does not necessarily mean the environment or food is severely problematic. <span class="font-medium text-red-500">It can sometimes refer to an extremely poor service experience, exceptionally low value for money, or a specific dish that severely failed expectations.</span></li>
                </ul>
                <p class="font-bold text-sm text-red-600 mt-3">
                    Final Criterion: The detailed written description in the **comments column** is the definitive source for all rating specifics and reasons. Please do not judge the restaurant solely based on the star rating.
                </p>
            </div>
        `;

        
        // --- Firestore è·¯å¾„æ„é€  ---
        function getReviewsCollection() {
            return collection(db, 'artifacts', APP_ID, 'users', OWNER_ID, 'recommendations');
        }
        function getRegionsCollection() {
            return collection(db, 'artifacts', APP_ID, 'users', OWNER_ID, 'regions');
        }
        function getLikesCollection() {
            return collection(db, 'artifacts', APP_ID, 'public', 'data', 'reviewLikes');
        }
        function getLikeDocRef(reviewId) {
            // Document ID uses both review ID and user ID to ensure uniqueness per like
            return doc(db, 'artifacts', APP_ID, 'public', 'data', 'reviewLikes', `${reviewId}_${userId}`);
        }

        // --- æ ¸å¿ƒå·¥å…·å‡½æ•° ---

        // æ¨¡æ€æ¡†å‡½æ•°
        function showModal(title, content, onConfirm, showCancel = false, isTemplate = false) {
            const modal = document.getElementById('custom-modal');
            const contentContainer = document.getElementById('modal-content-container');
            const modalBody = document.getElementById('modal-body');
            document.getElementById('modal-title').textContent = title;
            const confirmBtn = document.getElementById('modal-confirm-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const closeBtn = document.getElementById('modal-close-btn');

            // åŒºåˆ†å†…å®¹æ˜¯çº¯æ–‡æœ¬è¿˜æ˜¯ HTML æ¨¡æ¿
            if (isTemplate) {
                document.getElementById('modal-content').classList.add('hidden');
                modalBody.innerHTML = content;
                contentContainer.classList.add('max-w-xl'); // æ¨¡æ¿å¯èƒ½éœ€è¦æ›´å®½
            } else {
                document.getElementById('modal-content').textContent = content;
                document.getElementById('modal-content').classList.remove('hidden');
                modalBody.innerHTML = ''; // æ¸…ç©ºæ¨¡æ¿
                contentContainer.classList.remove('max-w-xl');
            }

            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                if (onConfirm) onConfirm();
            };
            
            closeBtn.onclick = () => {
                 modal.classList.add('hidden');
                 modal.classList.remove('flex');
            };

            if (showCancel) {
                cancelBtn.textContent = isTemplate ?
                'å…³é—­' : 'å–æ¶ˆ';
                cancelBtn.classList.remove('hidden');
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                };
                if (!onConfirm) {
                    confirmBtn.classList.add('hidden');
                // å¦‚æœæ²¡æœ‰ç¡®è®¤æ“ä½œï¼Œéšè—ç¡®è®¤æŒ‰é’®
                } else {
                    confirmBtn.classList.remove('hidden');
                }
            } else {
                cancelBtn.classList.add('hidden');
                confirmBtn.classList.remove('hidden');
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // å¦‚æœæ˜¯æ¨¡æ¿ï¼Œéœ€è¦é‡æ–°ç»‘å®šæ¨¡æ¿ä¸­çš„äº‹ä»¶
            if (isTemplate) {
                if (title === 'åœ°åŒºç®¡ç†') {
                    bindRegionManagerEvents();
                } else if (title === 'ç®¡ç†å‘˜ç™»å½•') {
                    bindAdminLoginEvents();
                }
            }
        }
        
        // --- è®¤è¯å‡½æ•° ---

        // (1) æ™®é€šç”¨æˆ·/ç®¡ç†å‘˜ Google ç™»å½• (æ— éœ€å¯†ç )
        async function handleGoogleSignIn() {
            try {
                const provider = new GoogleAuthProvider();
                // å¼ºåˆ¶é€‰æ‹© Google è´¦æˆ·
                provider.setCustomParameters({
                    prompt: 'select_account'
                });
                await signInWithPopup(auth, provider);
                // Auth state change listener will handle UI update
            } catch (error) {
                console.error("Google ç™»å½•å¤±è´¥:", error);
                showModal('ç™»å½•å¤±è´¥', `æ— æ³•é€šè¿‡ Google ç™»å½•: ${error.message}`, null);
            }
        }
        
        // (2) ä¸“é—¨çš„ç®¡ç†å‘˜ Email/Password ç™»å½• (å¸¦å¯†ç )
        function handleAdminLoginEntry() {
            showModal('ç®¡ç†å‘˜ç™»å½•', document.getElementById('admin-login-content').innerHTML, null, true, true);
            // éšè—ç¡®è®¤æŒ‰é’®ï¼Œåªä¿ç•™å…³é—­å’Œè¡¨å•æäº¤
            document.getElementById('modal-confirm-btn').classList.add('hidden');
        }

        function bindAdminLoginEvents() {
            const form = document.getElementById('admin-login-form');
            form.onsubmit = handleAdminLoginSubmit;
        }

        async function handleAdminLoginSubmit(e) {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorEl = document.getElementById('admin-error-message');
            const submitBtn = document.getElementById('admin-submit-btn');

            errorEl.classList.add('hidden');
            submitBtn.disabled = true;
            submitBtn.textContent = 'ç™»å½•ä¸­...';

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                if (userCredential.user.uid === OWNER_ID) {
                    // æˆåŠŸç™»å½•ä¸”æ˜¯ç®¡ç†å‘˜
                    showModal('ç™»å½•æˆåŠŸ', 'æ‚¨å·²æˆåŠŸä»¥ç®¡ç†å‘˜èº«ä»½ç™»å½•ã€‚', null);
                    document.getElementById('custom-modal').classList.add('hidden');
                    document.getElementById('custom-modal').classList.remove('flex');
                } else {
                    // æˆåŠŸç™»å½•ä½†ä¸æ˜¯æŒ‡å®šçš„ç®¡ç†å‘˜
                    await signOut(auth);
                    errorEl.textContent = 'æ­¤è´¦å·éæŒ‡å®šç®¡ç†å‘˜è´¦å·ã€‚';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                console.error("ç®¡ç†å‘˜ç™»å½•å¤±è´¥:", error);
                errorEl.textContent = 'ç™»å½•å¤±è´¥: é‚®ç®±æˆ–å¯†ç ä¸æ­£ç¡®ã€‚';
                errorEl.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ç™»å½•ä¸ºç®¡ç†å‘˜';
            }
        }


        async function handleSignOut() {
            try {
                await signOut(auth);
                // é€€å‡ºç™»å½•åï¼Œé‡æ–°ä»¥åŒ¿åç”¨æˆ·èº«ä»½ç™»å½•ï¼Œä»¥ä¿æŒ userId å­˜åœ¨
                await signInAnonymously(auth);
                // Auth state change listener will handle UI update
            } catch (error) {
                console.error("é€€å‡ºç™»å½•å¤±è´¥:", error);
                showModal('é€€å‡ºå¤±è´¥', `é€€å‡ºç™»å½•å¤±è´¥: ${error.message}`, null);
            }
        }


        // --- åœ°åŒºç®¡ç†å‡½æ•° (æ–°å¢/ä¿®æ”¹) ---

        /**
         * åˆå§‹åŒ–é»˜è®¤åœ°åŒºï¼šå¦‚æœåœ°åŒºåˆ—è¡¨ä¸ºç©ºï¼Œåˆ™ä» DEFAULT_REGIONS å¯¼å…¥
         */
        async function initializeDefaultRegions() {
            try {
                // ä»…åœ¨ OWNER_ID ç™»å½•æ—¶æ‰§è¡Œåˆå§‹åŒ–
                if (!isOwner) return;

                const regionsQuery = query(getRegionsCollection());
                const snapshot = await getDocs(regionsQuery);

                if (snapshot.empty) {
                    console.log("Regions collection is empty. Initializing default regions...");
                    for (const region of DEFAULT_REGIONS) {
                        // ä½¿ç”¨ setDoc å’Œä¸€ä¸ªåŸºäºå›½å®¶/å·å±çš„ ID æ¥é¿å…é‡å¤æ·»åŠ 
                        const regionId = `${region.country}_${region.state.replace(/\s/g, '_')}`;
                        await setDoc(doc(getRegionsCollection(), regionId), region);
                    }
                    console.log("Default regions initialized successfully.");
                } else {
                    console.log("Regions collection already contains data, skipping initialization.");
                }
            } catch (error) {
                console.error("Initializing default regions failed:", error);
            }
        }

        function bindRegionManagerEvents() {
            const form = document.getElementById('add-region-form');
            if (form) {
                form.onsubmit = handleAddRegion;
            }
        }
        
        async function handleAddRegion(e) {
            e.preventDefault();
            if (!isOwner) return;

            const country = document.getElementById('new-country').value.trim();
            const state = document.getElementById('new-state').value.trim();
            if (!country || !state) {
                showModal('é”™è¯¯', 'å›½å®¶å’Œå·å±éƒ½ä¸èƒ½ä¸ºç©ºã€‚', null);
                return;
            }

            try {
                const regionId = `${country.toUpperCase()}_${state.replace(/\s/g, '_')}`;
                await setDoc(doc(getRegionsCollection(), regionId), {
                    country: country.toUpperCase(),
                    state: state,
                    sortOrder: Date.now() 
                }, { merge: true }); // ä½¿ç”¨ merge é¿å…è¦†ç›–ç°æœ‰æ–‡æ¡£ï¼Œå¹¶ç¡®ä¿ ID å”¯ä¸€æ€§
                
                document.getElementById('new-country').value = '';
                document.getElementById('new-state').value = '';
            } catch (error) {
                console.error("æ·»åŠ åœ°åŒºå¤±è´¥:", error);
                showModal('é”™è¯¯', `æ·»åŠ åœ°åŒºå¤±è´¥: ${error.message}`, null);
            }
        }

        function handleDeleteRegion(id, country, state) {
            if (!isOwner) return;
            showModal(
                'ç¡®è®¤åˆ é™¤åœ°åŒº',
                `ç¡®å®šè¦åˆ é™¤åœ°åŒº "${country} - ${state}" å—ï¼Ÿ`,
                async () => {
                    try {
                        
                        await deleteDoc(doc(getRegionsCollection(), id));
                    } catch (error) {
                        console.error("åˆ é™¤åœ°åŒºå¤±è´¥:", error);
                        showModal('é”™è¯¯', `åˆ é™¤åœ°åŒºå¤±è´¥: ${error.message}`, null);
   
                    }
                },
                true
            );
        }

        /**
         * æ¸²æŸ“ Header å¯¼èˆªæ  (åŒ…å«ç­›é€‰é€»è¾‘)
         */
        function renderRegionNav(regions) {
            const navContainer = document.getElementById('region-nav');
            if (!navContainer) return; 

            allRegions = regions; // å­˜å‚¨åœ°åŒºåˆ—è¡¨ä¾› review form ä½¿ç”¨
            navContainer.innerHTML = ''; 

            if (regions.length === 0) {
                navContainer.innerHTML = '<p class="text-gray-400 text-sm">æš‚æ— åœ°åŒºä¿¡æ¯</p>';
                return;
            }
            
            // 1. æ·»åŠ  'å…¨éƒ¨åœ°åŒº' æŒ‰é’®
            const allActive = currentRegionFilter.countryCode === 'All';
            const allButtonHtml = `
                <button data-country="All" data-state="All" 
                    class="region-filter-btn px-3 py-2 rounded-md text-sm font-medium whitespace-nowrap transition 
                    ${allActive ? 'bg-primary-blue text-white shadow-md' : 'text-gray-600 hover:text-gray-900 bg-gray-100'}">
                    å…¨éƒ¨åœ°åŒº
                </button>
            `;
            navContainer.insertAdjacentHTML('beforeend', allButtonHtml);


            // 2. æŒ‰å›½å®¶/åœ°åŒºåˆ†ç»„æ¸²æŸ“ä¸‹æ‹‰èœå•
            const countries = regions.reduce((acc, region) => {
                if (!acc[region.country]) {
                    acc[region.country] = [];
                }
             
                acc[region.country].push(region);
                return acc;
            }, {});
            
            Object.entries(countries).forEach(([countryCode, states]) => {
                const countryActive = currentRegionFilter.countryCode === countryCode && currentRegionFilter.stateName === 'All';
                const countryButtonHtml = `
                    <div class="relative dropdown-hover">
                        <button data-country="${countryCode}" data-state="All"
                            class="region-filter-btn text-gray-600 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium flex items-center transition 
                            ${countryActive ? 'bg-indigo-100 text-indigo-800' : 'bg-gray-50'}"
                        >
                            ${countryCode} (${states.length})
                            <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="dropdown-menu 
absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50">
                            <div class="py-1">
                                ${states.map(s => {
                                    const stateActive = currentRegionFilter.countryCode === countryCode && currentRegionFilter.stateName === s.state;
                                    return `<a href="#" data-country="${countryCode}" data-state="${s.state}" 
                                        class="region-filter-btn block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 
                                        ${stateActive ? 'bg-primary-blue text-white hover:bg-primary-blue/90' : ''}">
                                        ${s.state}
                                    </a>`;
                                }).join('')}
                            </div>
                        
                        </div>
                    </div>
                `;
                navContainer.insertAdjacentHTML('beforeend', countryButtonHtml);
            });

            // 3. ç»‘å®šç­›é€‰äº‹ä»¶
            document.querySelectorAll('.region-filter-btn').forEach(btn => {
                btn.onclick = function(e) {
                    e.preventDefault();
                    const countryCode = this.getAttribute('data-country');
                    const stateName = this.getAttribute('data-state');
                    currentRegionFilter = { countryCode, stateName };
                    
                    // é‡æ–°æ¸²æŸ“å¯¼èˆªæ ä»¥æ›´æ–°æ¿€æ´»çŠ¶æ€
                    renderRegionNav(regions);
                    
                    // é‡æ–°è®¢é˜… reviews ä»¥åº”ç”¨æ–°çš„åœ°åŒºç­›é€‰
                    subscribeToReviews(); 
                };
            });
        }

        /**
         * æ¸²æŸ“åœ°åŒºé€‰æ‹©å™¨ (ç”¨äº 'æ·»åŠ æ–°è®°å½•' è¡¨å•)
         */
        function renderRegionSelectors() {
            const countrySelect = document.getElementById('review-country');
            const stateSelect = document.getElementById('review-state');
            
            if (!countrySelect || !stateSelect) return;

            // æ¸…ç©ºå¹¶å¡«å……å›½å®¶/åœ°åŒºé€‰æ‹©å™¨
            countrySelect.innerHTML = '<option value="">é€‰æ‹©å›½å®¶/åœ°åŒº</option>';
            const countries = [...new Set(allRegions.map(r => r.country))].sort();

            countries.forEach(countryCode => {
                const option = document.createElement('option');
                option.value = countryCode;
                option.textContent = countryCode;
                countrySelect.appendChild(option);
            });
            
            // ç»‘å®šå›½å®¶/åœ°åŒºé€‰æ‹©äº‹ä»¶
            countrySelect.onchange = function() {
                const selectedCountry = this.value;
                stateSelect.innerHTML = '<option value="">é€‰æ‹©å·å±/åŸå¸‚</option>';
                
                if (selectedCountry) {
                    stateSelect.disabled = false;
                    const states = allRegions
                        .filter(r => r.country === selectedCountry)
                        .map(r => r.state)
                        .sort();

                    states.forEach(stateName => {
                        const option = document.createElement('option');
                        option.value = stateName;
                        option.textContent = stateName;
                        stateSelect.appendChild(option);
                    });
                } else {
                    stateSelect.disabled = true;
                }
            };
            
            // é¦–æ¬¡æ¸²æŸ“æ—¶ç¦ç”¨å·å±é€‰æ‹©å™¨
            stateSelect.disabled = !countrySelect.value;
        }


        function renderRegionsInModal(regions) {
            const listContainer = document.getElementById('region-list-modal');
            if (!listContainer) return; 

            listContainer.innerHTML = '';
            if (regions.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-400">æš‚æ— åœ°åŒºã€‚</p>';
                return;
            }

            regions.forEach(r => {
                const itemHtml = `
                    <div class="flex justify-between items-center bg-gray-100 p-2 rounded-lg">
                        <span class="text-sm font-medium text-gray-700">${r.country} - ${r.state}</span>
           
                        <button data-id="${r.id}" data-country="${r.country}" data-state="${r.state}" class="delete-region-btn text-bad hover:text-red-700 p-1 rounded-full transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 
102 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', itemHtml);
            });
            document.querySelectorAll('.delete-region-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    handleDeleteRegion(
                        e.currentTarget.getAttribute('data-id'),
                        e.currentTarget.getAttribute('data-country'),
           
                        e.currentTarget.getAttribute('data-state')
                    );
                });
            });
        }


        async function callGeminiApi(payload, maxRetries = 3) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
            const headers = { 'Content-Type': 'application/json' };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                 
                        headers: headers,
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; 
                        }
                        throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.statusText}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!text) {
                         throw new Error("API å“åº”ä¸­æœªæ‰¾åˆ°ç”Ÿæˆçš„æ–‡æœ¬ã€‚");
                    }
                    return text;
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        console.error("Gemini API è°ƒç”¨æœ€ç»ˆå¤±è´¥:", error);
                        throw new Error(`AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨: ${error.message}`);
                    }
                }
            }
        }
        
        async function generateReviewSummary(reviewId, restaurantName, status, comment) {
            if (!isOwner) return;
            const loadingElement = document.getElementById(`summary-loading-${reviewId}`);
            const summaryElement = document.getElementById(`summary-content-${reviewId}`);
            const buttonElement = document.getElementById(`summary-btn-${reviewId}`);
            if (!loadingElement || !summaryElement || !buttonElement) {
                console.error("æœªèƒ½æ‰¾åˆ° AI æ‘˜è¦çš„ UI å…ƒç´ .");
                return;
            }

            summaryElement.innerHTML = '';
            summaryElement.classList.add('hidden');
            loadingElement.classList.remove('hidden');
            buttonElement.disabled = true;
            buttonElement.textContent = 'âœ¨ AI æ€è€ƒä¸­...';

            const ratingText = RATING_CONFIG[status] ? RATING_CONFIG[status].text : 'æœªè¯„åˆ†';
            const ratingEmoji = RATING_CONFIG[status] ? RATING_CONFIG[status].emoji : '';
            const systemPrompt = "ä½ æ˜¯ä¸€ä¸ªç¾é£Ÿåšä¸»åŠ©ç†ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®æä¾›çš„é¤å…è¯„è®ºï¼Œç”Ÿæˆä¸€æ®µç²¾ç‚¼ã€å¸å¼•äººçš„æ€»ç»“ï¼Œç”¨ä½œç¤¾äº¤åª’ä½“å¸–å­æˆ–çŸ­æ–‡æ¡ˆã€‚æ€»ç»“å¿…é¡»ç®€æ´ï¼ˆä¸è¶…è¿‡50å­—ï¼‰ï¼Œè¯­æ°”æ´»æ³¼ç§¯æï¼Œå¹¶åŒ…å« emojiã€‚";
            const userQuery = `é¤å…åç§°: ${restaurantName}ã€‚æˆ‘çš„è¯„çº§æ˜¯: ${ratingText} ${ratingEmoji}ã€‚æˆ‘çš„è¯¦ç»†è¯„è®ºæ˜¯: ${comment}ã€‚è¯·ç”Ÿæˆæ€»ç»“ã€‚`;
            const payload = { 
                contents: [{ parts: [{ text: userQuery }] }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            try {
                const summary = await callGeminiApi(payload);
                summaryElement.innerHTML = `<span class="font-semibold text-ai-sparkle">AI æ€»ç»“:</span> ${summary}`;
                summaryElement.classList.remove('hidden');
            } catch (error) {
                summaryElement.innerHTML = `<span class="font-semibold text-bad">AI é”™è¯¯:</span> ${error.message}`;
                summaryElement.classList.remove('hidden');
                console.error('ç”Ÿæˆæ€»ç»“å¤±è´¥:', error);
            } finally {
                loadingElement.classList.add('hidden');
                buttonElement.disabled = false;
                buttonElement.textContent = 'âœ¨ AI æ€»ç»“è¯„è®º';
            }
        }

        async function handleLike(reviewId, isLiked) {
            if (!isLoggedIn) {
                showModal('æƒé™ä¸è¶³', 'åªæœ‰ä½¿ç”¨ Gmail ç™»å½•çš„ç”¨æˆ·æ‰èƒ½ä½¿ç”¨ "Found this useful" åŠŸèƒ½ã€‚', handleGoogleSignIn, true);
                return;
            }
            const docRef = getLikeDocRef(reviewId);
            try {
                if (isLiked) {
                    await deleteDoc(docRef);
                } else {
                    await setDoc(docRef, { reviewId: reviewId, userId: userId, timestamp: new Date() });
                }
            } catch (error) {
                console.error("ç‚¹èµ/å–æ¶ˆç‚¹èµæ“ä½œå¤±è´¥:", error);
                showModal('é”™è¯¯', `æ“ä½œå¤±è´¥: ${error.message}`, null);
            }
        }

        // --- Firebase é›†æˆå’Œ UI æ¸²æŸ“ ---
        // Firebase åˆå§‹åŒ–å’Œè®¤è¯
        async function initializeFirebase() {
            // ç¡®ä¿åŠ è½½æŒ‡ç¤ºå™¨å’Œåº”ç”¨ä¸»ä½“å¯è§
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('app-container').classList.remove('hidden');

            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                document.getElementById('admin-login-entry').onclick = handleAdminLoginEntry;
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isOwner = userId === OWNER_ID; // R1: æƒé™æ£€æŸ¥
                 
                        isLoggedIn = !user.isAnonymous; // ç¡®å®šæ˜¯å¦ä¸ºçœŸå®ç”¨æˆ·ï¼ˆéåŒ¿åï¼‰

                        // R4: æ›´æ–°ç”¨æˆ·ä¿¡æ¯å’Œè®¤è¯æŒ‰é’®
                        document.getElementById('current-user-id').textContent = userId;
                        const statusEl = document.getElementById('owner-status');
          
                        const manageRegionsBtn = document.getElementById('manage-regions-btn');
                        const authBtn = document.getElementById('auth-button');

                        if (isOwner) {
                            statusEl.textContent = 
                            'æˆ‘ (ç®¡ç†å‘˜)';
                            statusEl.className = 'ml-2 px-2 py-0.5 rounded-full text-xs font-medium bg-admin-red text-white';
                            authBtn.textContent = 'é€€å‡ºç™»å½•';
                            authBtn.onclick = handleSignOut;
                            manageRegionsBtn.classList.remove('hidden');
                            manageRegionsBtn.onclick = () => {
                                showModal('åœ°åŒºç®¡ç†', document.getElementById('region-manager-content').innerHTML, null, true, true);
                            };
                            // åªæœ‰ç®¡ç†å‘˜éœ€è¦åˆå§‹åŒ–é»˜è®¤åœ°åŒº
                            await initializeDefaultRegions(); 
                        } else if (isLoggedIn) {
                            statusEl.textContent = 'å·²ç™»å½•ç”¨æˆ·';
                            statusEl.className = 'ml-2 px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800';
                            authBtn.textContent = 'é€€å‡ºç™»å½•';
                            authBtn.onclick = handleSignOut;
                            manageRegionsBtn.classList.add('hidden');
                        } else {
                            statusEl.textContent = 'åŒ¿åè®¿å®¢';
                            statusEl.className = 'ml-2 px-2 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-700';
                            authBtn.textContent = 'ä½¿ç”¨ Gmail ç™»å½•';
                            authBtn.onclick = handleGoogleSignIn;
                            manageRegionsBtn.classList.add('hidden');
                        }

                        // R1, R6: æ›´æ–° UI æƒé™
                        if (isOwner) {
                            document.getElementById('add-review-section').classList.remove('hidden');
                            document.getElementById('submit-btn').disabled = false;
                            document.getElementById('btn-text').textContent = 'æ·»åŠ è®°å½•';
                        } else {
                            document.getElementById('add-review-section').classList.add('hidden');
                            document.getElementById('submit-btn').disabled = true;
                            document.getElementById('btn-text').textContent = 'éç®¡ç†å‘˜æ— æ³•æ·»åŠ ';
                        }
                        
                        setTimeout(() => {
                            subscribeToReviews();
                
                            subscribeToLikes();
                            subscribeToRegions(); // è®¢é˜…åœ°åŒºæ•°æ®å¹¶åœ¨å…¶å›è°ƒä¸­è°ƒç”¨ renderRegionSelectors
                        }, 0);
                    } else {
                        // Initial load: try custom token or sign in anonymously
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ?
                        __initial_auth_token : null;
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }

                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('opacity-0');
                });
            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–æˆ–è®¤è¯å¤±è´¥:", error);
                document.getElementById('current-user-id').textContent = 'è®¤è¯å¤±è´¥';
                document.getElementById('loading-indicator').classList.add('hidden');
            }
        }

        async function uploadImage(file) {
            if (!file || !userId) return null;
            const fileExtension = file.name.split('.').pop();
            const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${fileExtension}`;
            const storageRef = ref(storage, `reviews/${OWNER_ID}/${fileName}`);
            const snapshot = await uploadBytes(storageRef, file);
            const url = await getDownloadURL(snapshot.ref);
            return url;
        }

        document.getElementById('add-review-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isOwner) {
                showModal('æƒé™é”™è¯¯', 'åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ·»åŠ è®°å½•ã€‚', null);
                return;
            }
         
            const countryCode = document.getElementById('review-country').value; // æ–°å¢
            const stateName = document.getElementById('review-state').value; // æ–°å¢
            const restaurantName = document.getElementById('restaurant-name').value.trim();
            const address = document.getElementById('address').value.trim();
            const category = document.getElementById('category').value;
            const status = document.getElementById('status').value;
            const comment = document.getElementById('comment').value.trim();
            const imageFile = document.getElementById('image-upload').files[0];

            const submitBtn = document.getElementById('submit-btn');
    
            if (!countryCode || !stateName || !restaurantName || !category || !status || !comment) { // æ£€æŸ¥æ–°å¢å­—æ®µ
                document.getElementById('error-message').textContent = 'å›½å®¶ã€å·å±ã€é¤å…åç§°ã€ç±»åˆ«ã€è¯„åˆ†å’Œè¯„è®ºéƒ½å¿…é¡»å¡«å†™ï¼';
                document.getElementById('error-message').classList.remove('hidden');
                return;
            }

            document.getElementById('error-message').classList.add('hidden');
            submitBtn.disabled = true;
            document.getElementById('btn-text').textContent = 'æ­£åœ¨ä¸Šä¼ /ä¿å­˜...';
            try {
                let imageUrl = null;
                if (imageFile) {
                    imageUrl = await uploadImage(imageFile);
                }

                await addDoc(getReviewsCollection(), {
                    countryCode, // æ–°å¢
                    stateName,   // æ–°å¢
                    restaurantName,
                    address: address || 'æœªæä¾›',
                    category,
                   
                    status,
                    comment,
                    imageUrl,
                    timestamp: new Date(),
                    sortTime: Date.now()
                
                });

                document.getElementById('add-review-form').reset();
                document.getElementById('image-upload').value = '';
                showModal('æˆåŠŸ', `å·²æˆåŠŸæ·»åŠ  "${restaurantName}" çš„è®°å½•ï¼`, null);
            } catch (error) {
                console.error("æ·»åŠ è®°å½•å¤±è´¥:", error);
                showModal('é”™è¯¯', `æ·»åŠ è®°å½•å¤±è´¥: ${error.message}`, null);
            } finally {
                submitBtn.disabled = false;
                document.getElementById('btn-text').textContent = 'æ·»åŠ è®°å½•';
            }
        });
        
        /**
         * è®¢é˜…å’Œç­›é€‰è¯„è®ºæ•°æ® (ä¿®æ”¹)
         */
        function subscribeToReviews() {
            let reviewsQuery = query(getReviewsCollection(), orderBy('sortTime', 'desc'));
            
            // åº”ç”¨åœ°åŒºç­›é€‰ (æ–°å¢é€»è¾‘)
            if (currentRegionFilter.countryCode !== 'All') {
                reviewsQuery = query(reviewsQuery, where('countryCode', '==', currentRegionFilter.countryCode));
                if (currentRegionFilter.stateName !== 'All') {
                    reviewsQuery = query(reviewsQuery, where('stateName', '==', currentRegionFilter.stateName));
                }
            }

            onSnapshot(reviewsQuery, (snapshot) => {
                reviews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderReviews(reviews);
            }, (error) => {
                console.error("ç›‘å¬ Owner Review æ•°æ®å¤±è´¥:", error);
            });
        }

        function subscribeToLikes() {
            const likesQuery = query(getLikesCollection());
            onSnapshot(likesQuery, (snapshot) => {
                likesMap = {};
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const reviewId = data.reviewId;
               
                    if (!likesMap[reviewId]) {
                        likesMap[reviewId] = { count: 0, likedByMe: false };
                    }
                    likesMap[reviewId].count += 1;
                    
                    if (data.userId === userId) {
                        likesMap[reviewId].likedByMe = true;
                    }
                });
                renderReviews(reviews);
            }, (error) => {
   
                console.error("ç›‘å¬ Likes æ•°æ®å¤±è´¥:", error);
            });
        }

        /**
         * è®¢é˜…åœ°åŒºæ•°æ® (ä¿®æ”¹)
         */
        function subscribeToRegions() {
            const regionsQuery = query(getRegionsCollection(), orderBy('sortOrder', 'asc'));
            onSnapshot(regionsQuery, (snapshot) => {
                const regions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                renderRegionNav(regions); // æ¸²æŸ“ Header å¯¼èˆª
                renderRegionSelectors();  // æ¸²æŸ“è¡¨å•ä¸­çš„åœ°åŒºé€‰æ‹©å™¨

                if (isOwner) {
                    renderRegionsInModal(regions);
                }
  
            }, (error) => {
                console.error("ç›‘å¬ Regions æ•°æ®å¤±è´¥:", error);
            });
        }

        function handleDelete(id, name) {
            if (!isOwner) {
                showModal('æƒé™é”™è¯¯', 'åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ é™¤è®°å½•ã€‚', null);
                return;
            }
            showModal(
                'ç¡®è®¤åˆ é™¤',
                `æ‚¨ç¡®å®šè¦åˆ é™¤é¤å… "${name}" çš„è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚`,
                async () => {
                    try {
             
                        // 1. åˆ é™¤ Firestore è®°å½•
                        await deleteDoc(doc(getReviewsCollection(), id));
                        
                        // 2. åˆ é™¤å›¾ç‰‡ (å¯é€‰ï¼Œä½†æ¨è)
        
                        // å®é™…å›¾ç‰‡åˆ é™¤é€»è¾‘éœ€è¦é¢å¤–çš„äº‘å‡½æ•°æˆ–å®¢æˆ·ç«¯ä»£ç ï¼Œè¿™é‡Œä»…å¤„ç† Firestore è®°å½•
                    } catch (error) {
                        console.error("åˆ é™¤è®°å½•å¤±è´¥:", error);
                        showModal('é”™è¯¯', `åˆ é™¤è®°å½•å¤±è´¥: ${error.message}`, null);
      
                    }
                },
                true // showCancel = true
            );
        }

        /**
         * åˆ›å»ºè¯„è®ºå¡ç‰‡ (ä¿®æ”¹ï¼šæ·»åŠ åœ°åŒº Tag)
         */
        function createReviewCard(review) {
            const likeInfo = likesMap[review.id] ||
            { count: 0, likedByMe: false };
            const ratingConfig = RATING_CONFIG[review.status] || RATING_CONFIG['Can eat'];
            const timestamp = review.timestamp ?
            new Date(review.timestamp.seconds * 1000).toLocaleDateString('zh-CN', { year: 'numeric', month: 'short', day: 'numeric' }) : 'æœªçŸ¥æ—¥æœŸ';
            
            // æ–°å¢åœ°åŒº Tag
            const locationTag = (review.countryCode && review.stateName) ? 
                `<span class="bg-gray-200 text-gray-700 px-2 py-0.5 rounded-full font-medium text-xs mr-2">${review.countryCode} - ${review.stateName}</span>` 
                : '';
                
            const ownerControls = isOwner ?
            `
                <div class="flex space-x-2 mt-3 pt-3 border-t border-gray-100">
                    <button id="summary-btn-${review.id}" class="flex items-center text-xs font-medium text-ai-sparkle hover:text-orange-600 transition">
                        âœ¨ AI æ€»ç»“è¯„è®º
                    </button>
    
                    <button data-id="${review.id}" class="delete-btn flex items-center text-xs font-medium text-bad hover:text-red-700 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 
102 0V8z" clip-rule="evenodd" /></svg>
                        åˆ é™¤
                    </button>
                </div>
                <div id="summary-loading-${review.id}" class="flex items-center text-sm text-ai-sparkle mt-2 hidden">
              
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    æ­£åœ¨ç”ŸæˆAIæ€»ç»“...
                </div>
                <p id="summary-content-${review.id}" class="text-xs 
text-gray-600 bg-orange-50/50 p-2 rounded-lg mt-2 hidden"></p>
            ` : '';
            
            return `
                <div class="review-card bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-bold text-gray-800">${review.restaurantName}</h3>
                        <span 
class="px-3 py-1 text-xs font-semibold rounded-full ${ratingConfig.color} text-white whitespace-nowrap">
                            ${ratingConfig.emoji} ${ratingConfig.text}
                        </span>
                    </div>
                    
                    ${review.address && review.address !== 'æœªæä¾›' ? `<p class="text-xs text-gray-400 mb-2 truncate">${review.address}</p>` : ''}
                    <p class="text-sm text-gray-600 mb-3">${review.comment}</p>
                    
                    ${review.imageUrl ?
                    `
                        <img src="${review.imageUrl}" alt="Restaurant image" class="w-full h-40 object-cover rounded-lg mb-3 shadow-md cursor-pointer" onclick="window.open('${review.imageUrl}', '_blank')">
                    ` : ''}

                    <div class="flex justify-between items-center text-xs text-gray-500">
                 
                        <div class="flex space-x-2">
                            ${locationTag} <span class="bg-indigo-50 text-indigo-800 px-2 py-0.5 rounded-full font-medium">${review.category}</span>
                        </div>
                        <span class="text-gray-400">è®°å½•äº ${timestamp}</span>
                    </div>

                    <div class="flex justify-between items-end">
                  
                        <button id="like-btn-${review.id}" data-liked="${likeInfo.likedByMe}" class="flex items-center text-sm font-medium ${likeInfo.likedByMe ? 'text-useful' : 'text-gray-400 hover:text-useful'} transition mt-3">
                            <svg class="h-5 w-5 mr-1 ${likeInfo.likedByMe ? 'fill-current' : 'fill-none stroke-current'}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 10h-4v4h4v-4zM7 10h2v4h-2v-4zM16 10h2v4h-2v-4zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
        
                            Found this useful (${likeInfo.count})
                        </button>
                        ${ownerControls}
                    </div>
         
                </div>
            `;
        }

        function renderReviews(allReviews) {
            const listContainer = document.getElementById('reviews-list');
            const totalCountEl = document.getElementById('total-count');
            const emptyMessage = document.getElementById('empty-message');
            const filterButtonsContainer = document.getElementById('filter-buttons');

            if (!listContainer || !totalCountEl || !filterButtonsContainer) return;
            // 1. ç”Ÿæˆç­›é€‰æŒ‰é’®
            const statuses = Object.keys(RATING_CONFIG);
            filterButtonsContainer.innerHTML = statuses.map(status => {
                const config = RATING_CONFIG[status];
                const isActive = currentFilter === status;
                return `
                    <button data-filter="${status}" class="filter-btn px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap transition ${isActive ? `${config.color} text-white shadow-md` : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}">
 
                        ${config.emoji} ${config.text}
                    </button>
                `;
            }).join('');
            // é‡æ–°ç»‘å®šç­›é€‰æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.onclick = function() {
                    currentFilter = this.getAttribute('data-filter');
                    renderReviews(allReviews); // é‡æ–°æ¸²æŸ“ä»¥åº”ç”¨æ–°ç­›é€‰å™¨
                };
      
            });

            // 2. ç­›é€‰å’Œæ¸²æŸ“è¯„è®º
            const filteredReviews = currentFilter === 'All'
                ?
            allReviews
                : allReviews.filter(review => review.status === currentFilter);
            totalCountEl.textContent = `æ€»å…± ${filteredReviews.length} æ¡è®°å½•`;
            listContainer.innerHTML = '';

            if (filteredReviews.length === 0) {
                emptyMessage.classList.remove('hidden');
                return;
            } else {
                emptyMessage.classList.add('hidden');
            }

            // ä½¿ç”¨ DocumentFragment æé«˜æ€§èƒ½
            const fragment = document.createDocumentFragment();
            filteredReviews.forEach(review => {
                const div = document.createElement('div');
                div.innerHTML = createReviewCard(review).trim();
                fragment.appendChild(div.firstChild);
            });
            listContainer.appendChild(fragment);

            // 3. ç»‘å®šæ“ä½œæŒ‰é’®äº‹ä»¶
            filteredReviews.forEach(review => {
                if (isOwner) {
                    const deleteButton = document.querySelector(`.delete-btn[data-id="${review.id}"]`);
                    if (deleteButton) {
                    
                        deleteButton.addEventListener('click', (e) => {
                            handleDelete(review.id, review.restaurantName);
                        });
                    }

                    
                    const summaryButton = document.getElementById(`summary-btn-${review.id}`);
                    if (summaryButton) {
                        summaryButton.addEventListener('click', () => {
                            generateReviewSummary(review.id, review.restaurantName, review.status, review.comment);
                 
                        });
                    }
                }
                
                const likeButton = document.getElementById(`like-btn-${review.id}`);
                if (likeButton) { 
   
                    likeButton.addEventListener('click', (e) => {
                        const isLiked = e.currentTarget.getAttribute('data-liked') === 'true';
                        handleLike(review.id, isLiked);
                    });
                }
            });
        }
        
        // --- T&C é€»è¾‘ ---
        const TERMS_ACCEPTED_KEY = 'termsAccepted';
        const TNC_MODAL_ID = 'terms-and-conditions-modal';

        function checkTermsAndConditions() {
            const isAccepted = localStorage.getItem(TERMS_ACCEPTED_KEY) === 'true';
            const tncModal = document.getElementById(TNC_MODAL_ID);
            const loadingIndicator = document.getElementById('loading-indicator');
            const appContainer = document.getElementById('app-container');
            // æ£€æŸ¥æ˜¯å¦å·²æ¥å—æ¡æ¬¾
            if (isAccepted) {
                // å·²æ¥å—ï¼Œéšè— T&C æ¨¡æ€æ¡†ï¼Œæ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨ï¼Œç»§ç»­åŠ è½½åº”ç”¨
                if (tncModal) tncModal.classList.add('hidden');
                if (loadingIndicator) loadingIndicator.classList.remove('hidden');
                if (appContainer) appContainer.classList.remove('hidden');
                initializeFirebase();
            } else {
                // æœªæ¥å—ï¼Œæ˜¾ç¤º T&C æ¨¡æ€æ¡†ï¼Œéšè—åŠ è½½æŒ‡ç¤ºå™¨å’Œåº”ç”¨ä¸»ä½“
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
                if (appContainer) appContainer.classList.add('hidden');
                if (tncModal) {
                    tncModal.classList.remove('hidden');
                    bindTermsAndConditionsEvents();
                }
            }
        }

        function bindTermsAndConditionsEvents() {
            document.getElementById('accept-terms-btn').onclick = handleAcceptTerms;
            document.getElementById('decline-terms-btn').onclick = handleDeclineTerms;
        }

        function handleAcceptTerms() {
            // 1. å­˜å‚¨æ¥å—çŠ¶æ€ (å³ä½¿æ˜¯åŒ¿åç”¨æˆ·ä¹Ÿè¦å­˜å‚¨)
            localStorage.setItem(TERMS_ACCEPTED_KEY, 'true');
            // 2. éšè— T&C æ¨¡æ€æ¡†
            document.getElementById(TNC_MODAL_ID).classList.add('hidden');
            // 3. æ¢å¤åŠ è½½æŒ‡ç¤ºå™¨å¹¶åˆå§‹åŒ–åº”ç”¨
            document.getElementById('loading-indicator').classList.remove('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            initializeFirebase();
        }

        function handleDeclineTerms() {
            // æ‹’ç»æ¡æ¬¾ï¼Œè·³è½¬åˆ° index.html
            window.location.href = 'index.html';
        }
        
        // --- ç»‘å®šæ–°çš„è¯„åˆ†æ ‡å‡†è¯´æ˜æŒ‰é’® (æ–°å¢) ---
        document.addEventListener('DOMContentLoaded', () => {
             const ratingBtn = document.getElementById('show-rating-standard-btn');
             if (ratingBtn) {
                 ratingBtn.onclick = () => {
                     showModal('è¯„åˆ†æ ‡å‡†è¯´æ˜ / Rating Standard', RATING_EXPLANATION_HTML, null, true, true);
                 };
             }
        });
        
        window.onload = checkTermsAndConditions;
    </script>
</body>
</html>