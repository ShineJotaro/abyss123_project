<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>abyss_123çš„é¤å…è¯„é‰´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- æ¨¡å—è„šæœ¬ 1: Firebase ä¾èµ–å¯¼å…¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // è®¾ç½® Firebase æ—¥å¿—çº§åˆ«
        setLogLevel('error'); // å‡å°‘æ§åˆ¶å°å™ªéŸ³
        
        // å…¨å±€å˜é‡ï¼Œç”¨äºåœ¨å…¶ä»–è„šæœ¬ä¸­è®¿é—®
        window.firebase = { 
            initializeApp, 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, writeBatch 
        };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'best': '#10b981', 
                        'good': '#3b82f6', 
                        'caneat': '#f59e0b', 
                        'bad': '#ef4444', 
                        'primary-blue': '#3b82f6',
                        'ai-sparkle': '#f97316', 
                        'useful': '#6366f1', 
                        'admin-red': '#dc2626', 
                    }
                }
            }
        }
    </script>
    <style>
        /* ç§»é™¤ loading-hiddenï¼Œå…¨éƒ¨ä½¿ç”¨ hidden */
        /* æ”¹è¿›ä¸‹æ‹‰èœå•çš„å¯è§æ€§æ§åˆ¶ */
        .dropdown-menu {
            transition: all 0.3s ease-out;
            opacity: 0;
            visibility: hidden;
            transform: translateY(5px);
            pointer-events: none; /* é»˜è®¤ç¦ç”¨é¼ æ ‡äº‹ä»¶ */
        }
        .dropdown-hover:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto; /* æ‚¬åœæ—¶å¯ç”¨é¼ æ ‡äº‹ä»¶ */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Custom color classes */
        .bg-best { background-color: #10b981; }
        .bg-good { background-color: #3b82f6; }
        .bg-caneat { background-color: #f59e0b; }
        .bg-bad { background-color: #ef4444; }
        
        /* æ ‡ç­¾å¯¼èˆªæ çš„æ ·å¼ */
        .tag-btn {
            @apply px-4 py-2 text-sm font-medium rounded-lg transition duration-150 cursor-pointer;
        }
        .tag-active {
            @apply bg-primary-blue text-white shadow-md;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- T&C æ¨¡æ€æ¡† (æ–°ç»“æ„) -->
    <div id="terms-and-conditions-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[9999] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-8 transform transition-all">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">æœåŠ¡æ¡æ¬¾ä¸å…è´£å£°æ˜ / Terms & Conditions and Disclaimer</h2>
            
            <div class="text-sm text-gray-700 space-y-4 mb-6 pr-4">

                <h3 class="font-semibold text-lg text-primary-blue mt-4">æ ¸å¿ƒå…è´£å£°æ˜ (Core Disclaimer)</h3>
                <p class="font-medium text-red-600 border-l-4 border-red-500 pl-3 py-1 bg-red-50/50">
                    **é‡è¦å£°æ˜:** ä»¥ä¸Šæ‰€æœ‰æ¨èå†…å®¹ä»…ä»¥æˆ‘ï¼ˆabyss_123ï¼‰**åƒåˆ°é£Ÿç‰©çš„å½“ä¸‹ä¸ºæ ‡å‡†**ã€‚æˆ‘ä»¬ä¸å¯¹é¤å…åç»­çš„è¿›æ­¥æˆ–é€€æ­¥æ‰€å¯¼è‡´çš„é—®é¢˜æ‰¿æ‹…ä»»ä½•è´£ä»»ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºé£Ÿç‰©ä¸­æ¯’ã€é£Ÿç‰©å£å‘³ä¸ä½³æˆ–æ‚¨è®¤ä¸ºæˆ‘æœªæ¨èä½†å®é™…å¾ˆç¾å‘³çš„é£Ÿç‰©ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯¹ç”¨æˆ·æˆ–é¤å…å¯¹å½¼æ­¤çš„æ€¨è¨€ã€è¡ŒåŠ¨æˆ–ä»»ä½•æ³•å¾‹è´£ä»»ä¸è´Ÿè´£ä»»ã€‚æ‚¨å¿…é¡»æ¥å—æ­¤æ¡æ¬¾æ‰èƒ½ç»§ç»­ä½¿ç”¨æœ¬ç½‘ç«™ã€‚
                </p>

                <p class="font-medium text-red-600 border-l-4 border-red-500 pl-3 py-1 bg-red-50/50">
                    **Crucial Disclaimer:** All recommendations herein are based **solely on the quality of the food at the moment I (abyss_123) consumed it**.
                    We are not responsible for any issues arising from the restaurant's subsequent improvement or deterioration, including but not limited to food poisoning, bad taste, or highly-rated food that I did not recommend.
                    Furthermore, we are not liable for any user or restaurant grievances, actions, or legal matters directed at each other.
                    You must accept this term to proceed.
                </p>

                <h3 class="font-semibold text-lg text-gray-700 mt-6">æ ‡å‡†æœåŠ¡æ¡æ¬¾ (Standard Terms of Service)</h3>
                <p>
                    **Cookie æ”¿ç­–:** æœ¬ç½‘ç«™ä½¿ç”¨ Cookieï¼ˆæˆ–æœ¬åœ°å­˜å‚¨ï¼‰æ¥å­˜å‚¨æ‚¨çš„åå¥½è®¾ç½®å’Œä¼šè¯çŠ¶æ€ï¼ˆåŒ…æ‹¬æ‚¨æ¥å—æ­¤æ¡æ¬¾çš„çŠ¶æ€ï¼‰ã€‚é€šè¿‡ä½¿ç”¨æœ¬ç½‘ç«™ï¼Œæ‚¨åŒæ„æˆ‘ä»¬æ ¹æ®æˆ‘ä»¬çš„ Cookie æ”¿ç­–ä½¿ç”¨ Cookieã€‚
                </p>
            
                <p>
                    **éšç§æ”¿ç­–:** æˆ‘ä»¬é‡è§†æ‚¨çš„éšç§ã€‚æˆ‘ä»¬ä»…æ”¶é›†å’Œä½¿ç”¨ä¸ºæä¾›åŸºæœ¬æœåŠ¡ï¼ˆå¦‚ç”¨æˆ·è®¤è¯ã€ç‚¹èµåŠŸèƒ½ï¼‰æ‰€å¿…éœ€çš„æ•°æ®ï¼Œä¾‹å¦‚æ‚¨çš„ Google ç”¨æˆ·IDã€‚æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼ˆå¦‚è¯„è®ºæˆ–å›¾ç‰‡ï¼‰ä¸ä¼šè¢«å…¬å¼€åˆ†äº«ç»™ç¬¬ä¸‰æ–¹ï¼Œé™¤éæ³•å¾‹è¦æ±‚ã€‚
                </p>
                <p>
                    **ä½¿ç”¨é™åˆ¶:** æ‚¨åŒæ„ä¸ä»¥ä»»ä½•éæ³•ã€æœ‰å®³æˆ–ä¾µçŠ¯ä»–äººæƒåˆ©çš„æ–¹å¼ä½¿ç”¨æœ¬ç½‘ç«™ã€‚
                </p>

    
                <h3 class="font-semibold text-lg text-gray-700 mt-6">Standard Terms of Service</h3>
                <p>
                    **Cookie Policy:** This site uses cookies (or local storage) to store your preferences and session status (including your acceptance of these terms).
                    By using this site, you consent to our use of cookies in accordance with our Cookie Policy.
                </p>
                <p>
                    **Privacy Policy:** We value your privacy.
                    We only collect and use data necessary for providing essential services (such as user authentication, and like features), such as your Google User ID.
                    Your personal information (such as comments or images) will not be publicly shared with third parties unless required by law.
                </p>
                <p>
                    **Use Restrictions:** You agree not to use this site in any manner that is unlawful, harmful, or infringes upon the rights of others.
                </p>
            </div>

            <div class="flex justify-end space-x-4 border-t pt-4">
                <button id="decline-terms-btn" class="px-6 py-2 text-base font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    ä¸æ¥å—å¹¶é€€å‡º (Decline & Exit)
                </button>
            
                <button id="accept-terms-btn" class="px-6 py-2 text-base font-medium text-white bg-primary-blue rounded-lg hover:bg-blue-600 transition">
                    æˆ‘æ¥å—æ¡æ¬¾ (I Accept the Terms)
                </button>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ (æ–°ç»“æ„) -->
    <div id="loading-indicator" class="fixed inset-0 bg-white/70 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-sm text-primary-blue">åº”ç”¨åˆå§‹åŒ–ä¸­...</p>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app-container" class="opacity-0 hidden transition-opacity duration-500 max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- å¤´éƒ¨ & è®¤è¯çŠ¶æ€ -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">abyss_123çš„é¤å…è¯„é‰´</h1>
            <div id="auth-status" class="relative">
                <!-- è®¤è¯çŠ¶æ€å°†åœ¨æ­¤å¤„æ¸²æŸ“ -->
            </div>
        </header>

        <!-- ç®¡ç†å‘˜æ·»åŠ è¯„é‰´è¡¨å• -->
        <div id="admin-form-container" class="mb-10 p-6 bg-white shadow-xl rounded-xl border border-primary-blue/30 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-primary-blue">ç®¡ç†å‘˜ï¼šæ·»åŠ é¤å…è¯„é‰´</h2>
            <form id="add-review-form" class="space-y-4">
                <input type="text" id="restaurantName" placeholder="é¤å…åç§°" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                <input type="text" id="address" placeholder="é¤å…åœ°å€" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                <input type="url" id="imageUrl" placeholder="å›¾ç‰‡ URL (PNG/JPG/å…¶ä»–)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                
                <!-- æ›´æ–°åçš„è¯„åˆ†çŠ¶æ€é€‰æ‹© -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">è¯„åˆ†çŠ¶æ€</label>
                    <select id="status" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue transition bg-white">
                        <option value="">é€‰æ‹©è¯„åˆ†</option>
                        <option value="Best">Best ğŸ˜† (æœ€ä½³)</option>
                        <option value="Good">Good ğŸ˜ (ä¸é”™)</option>
                        <option value="Can eat">Can eat ğŸ™‚ (å¯ä»¥åƒ)</option>
                        <option value="Bad">Bad ğŸ˜  (å·®è¯„)</option>
                    </select>
                </div>
                
                <!-- æ–°å¢æ ‡ç­¾è¾“å…¥æ¡† -->
                <input type="text" id="tags" placeholder="å›½å®¶/å·å±æ ‡ç­¾ (ä¾‹å¦‚: Malaysia, Penang) å¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                <textarea id="comment" placeholder="è¯¦ç»†è¯„è®º (å¿…å¡«)" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue"></textarea>
                <button type="submit" class="w-full py-3 bg-primary-blue text-white font-bold rounded-lg hover:bg-blue-600 transition duration-150">æäº¤è¯„é‰´</button>
                <!-- æ–°å¢å…³é—­æŒ‰é’® -->
                <button type="button" id="closeAdminForm" class="w-full py-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-150">å…³é—­æ­¤é¡µé¢</button>
            </form>
        </div>
        
        <!-- æ ‡ç­¾ç­›é€‰/å¯¼èˆªæ  -->
        <nav id="filter-navbar-container" class="mb-6 bg-white shadow-md rounded-xl p-4 sticky top-0 z-10 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">æŒ‰å›½å®¶/å·å±ç­›é€‰</h2>
            <div id="filter-navbar" class="flex flex-wrap gap-2">
                <!-- ç­›é€‰æŒ‰é’®å°†åœ¨æ­¤å¤„æ¸²æŸ“ -->
            </div>
        </nav>

        <!-- é¤å…è¯„é‰´åˆ—è¡¨ -->
        <section class="mt-8">
            <h2 id="reviews-header" class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">æ‰€æœ‰è¯„é‰´ (å…¨éƒ¨)</h2>
            <div id="reviews-list" class="space-y-6">
                <!-- è¯„è®ºå°†åœ¨æ­¤å¤„æ¸²æŸ“ -->
            </div>
            <div id="empty-state" class="text-center p-10 bg-white rounded-xl shadow mt-6 hidden">
                <p class="text-gray-500 italic">ç›®å‰è¿˜æ²¡æœ‰ä»»ä½•é¤å…è¯„é‰´ã€‚</p>
            </div>
        </section>

        <!-- æ¨¡æ€æ¡†ç”¨äºæç¤ºä¿¡æ¯ -->
        <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center transition-opacity duration-300">
            <div id="app-modal" class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transition-transform duration-300 transform scale-95">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
                <p id="modal-message" class="text-gray-600 mb-4"></p>
                <button id="modal-close-btn" class="w-full py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-600 transition">ç¡®å®š</button>
            </div>
        </div>
        
        <!-- å¹¿å‘Šå®¹å™¨ (ç½‘ç«™æœ€ä¸‹æ–¹) -->
        <div class="max-w-4xl mx-auto p-4 sm:p-8 mt-12">
            <div class="ads-container p-4 bg-gray-100 rounded-xl text-center">
                <p class="text-sm text-gray-500 mb-2">å¹¿å‘ŠèµåŠ©å•†å†…å®¹</p>
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9923429709566940"
                    crossorigin="anonymous"></script>
                <ins class="adsbygoogle"
                    style="display:block; min-height: 100px;"
                    data-ad-format="autorelaxed"
                    data-ad-client="ca-pub-9923429709566940"
                    data-ad-slot="7327876978"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>
    </div>

    <!-- åœ¨å¹¿å‘Šå®¹å™¨åæ·»åŠ è¿™ä¸ªé¡µè„š -->
<footer class="max-w-4xl mx-auto p-4 mt-8 border-t border-gray-200">
    <div class="text-center text-sm text-gray-500">
        <div class="flex justify-center space-x-6 mb-4">
            <a href="privacy-policy.html" class="hover:text-primary-blue transition">éšç§æ”¿ç­–</a>
            <a href="terms-of-service.html" class="hover:text-primary-blue transition">æœåŠ¡æ¡æ¬¾</a>
            <a href="contact.html" class="hover:text-primary-blue transition">è”ç³»æˆ‘ä»¬</a>
        </div>
        <p>&copy; 2025 abyss_123çš„é¤å…è¯„é‰´. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
    </div>
</footer>

    <!-- æ¨¡å—è„šæœ¬ 2: ä¸»è¦åº”ç”¨é€»è¾‘ -->
    <script type="module">
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// è·å–å…¨å±€å˜é‡
const { initializeApp, signInAnonymously, signInWithCustomToken } = window.firebase;

// --- è¯„åˆ†é…ç½®æ˜ å°„ (RATING_CONFIG) ---
const RATING_CONFIG = {
    'Best': { emoji: 'ğŸ˜†', color: 'bg-best', text: 'æœ€ä½³' },
    'Good': { emoji: 'ğŸ˜', color: 'bg-good', text: 'ä¸é”™' },
    'Can eat': { emoji: 'ğŸ™‚', color: 'bg-caneat', text: 'å¯ä»¥åƒ' },
    'Bad': { emoji: 'ğŸ˜ ', color: 'bg-bad', text: 'å·®è¯„' },
    'All': { emoji: '', color: 'bg-primary-blue', text: 'å…¨éƒ¨' }
};

// --- å…¨å±€çŠ¶æ€ & å¸¸é‡ ---
let db;
let auth;
let ADMIN_EMAIL = 'jefflai123123@gmail.com'; // æŒ‡å®šç®¡ç†å‘˜é‚®ç®±
let isAuthReady = false;
let currentUserEmail = null; // æ”¹ä¸ºå­˜å‚¨é‚®ç®±è€Œä¸æ˜¯ID
let isLoggedIn = false;
let isAdmin = false;
let activeFilterTag = 'All';
let allReviewsData = [];

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = {
    apiKey: "AIzaSyCD7f8ZnlXZuI_DiBc_M2c9jl44WajJMhw",
    authDomain: "abyss123-project.firebaseapp.com",
    projectId: "abyss123-project",
    storageBucket: "abyss123-project.firebasestorage.app",
    messagingSenderId: "233505718695",
    appId: "1:233505718695:web:1a62ca261f9ebd9beaf682"
};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

// é»˜è®¤æ ‡ç­¾åˆ—è¡¨
const DEFAULT_TAGS = {
    'Malaysia': [
        'Johor', 'Kedah', 'Kelantan', 'Malacca', 'Negeri Sembilan', 
        'Pahang', 'Penang', 'Perak', 'Perlis', 'Sabah', 
        'Sarawak', 'Selangor', 'Terengganu', 'Kuala Lumpur', 
        'Labuan', 'Putrajaya'
    ],
    'Singapore': ['Singapore'],
};

// Firestore é›†åˆè·¯å¾„
const getCollectionPath = () => `/artifacts/${appId}/public/data/reviews`;

// --- UI / æ¨¡æ€æ¡†å‡½æ•° ---
const showModal = (title, message) => {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message').textContent = message;
    document.getElementById('modal-backdrop').classList.remove('hidden');
    document.getElementById('modal-backdrop').classList.add('flex');
    document.getElementById('app-modal').classList.remove('scale-95');
    document.getElementById('app-modal').classList.add('scale-100');
};

document.getElementById('modal-close-btn').addEventListener('click', () => {
    document.getElementById('modal-backdrop').classList.add('hidden');
    document.getElementById('modal-backdrop').classList.remove('flex');
});

// T&C æ¨¡æ€æ¡†æ£€æŸ¥
const checkTermsAndConditions = () => {
    const accepted = sessionStorage.getItem('T&C_Accepted') === 'true';
    const termsModalBackdrop = document.getElementById('terms-and-conditions-modal');
    const acceptBtn = termsModalBackdrop.querySelector('#accept-terms-btn');
    const declineBtn = termsModalBackdrop.querySelector('#decline-terms-btn');

    if (accepted) {
        termsModalBackdrop.classList.add('hidden');
        document.getElementById('loading-indicator').classList.remove('hidden'); 
        initializeFirebase();
    } else {
        termsModalBackdrop.classList.remove('hidden');
        
        // Handle Accept
        acceptBtn.addEventListener('click', () => {
            sessionStorage.setItem('T&C_Accepted', 'true');
            termsModalBackdrop.classList.add('hidden');
            document.getElementById('loading-indicator').classList.remove('hidden');
            initializeFirebase();
        }, { once: true });
        
        // Handle Decline - è·³è½¬åˆ°é¦–é¡µ
        declineBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        }, { once: true });
    }
};

// --- Firebase åˆå§‹åŒ– & è®¤è¯ ---
const initializeFirebase = async () => {
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦æœ‰ç”¨æˆ·é‚®ç®±
        const savedEmail = localStorage.getItem('userEmail');
        if (savedEmail) {
            currentUserEmail = savedEmail;
            isLoggedIn = true;
            isAdmin = (savedEmail === ADMIN_EMAIL);
        }

        // åŒ¿åç™»å½•ä»¥è®¿é—®Firestore
        await signInAnonymously(auth);

        onAuthStateChanged(auth, (user) => {
            isAuthReady = true;
            updateUIBasedOnAuth();
            startReviewListener();
        });

    } catch (error) {
        console.error("Firebase åˆå§‹åŒ–æˆ–è®¤è¯å¤±è´¥:", error);
        showModal("åˆå§‹åŒ–é”™è¯¯", "åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æˆ–ç¨åé‡è¯•ã€‚");
    } finally {
        document.getElementById('loading-indicator').classList.add('hidden');
        document.getElementById('app-container').classList.remove('opacity-0', 'hidden');
    }
};

// --- è®¤è¯ç›¸å…³å‡½æ•° ---
const signInWithEmailOnly = async () => {
    const email = prompt('è¯·è¾“å…¥æ‚¨çš„ç”µå­é‚®ä»¶åœ°å€ä»¥ç™»å½•:');
    if (!email) return;
    
    // ç®€å•çš„é‚®ç®±éªŒè¯
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showModal('è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç”µå­é‚®ä»¶åœ°å€ã€‚');
        return;
    }
    
    // ä¿å­˜é‚®ç®±åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('userEmail', email);
    currentUserEmail = email;
    isLoggedIn = true;
    isAdmin = (email === ADMIN_EMAIL);
    
    updateUIBasedOnAuth();
    showModal('ç™»å½•æˆåŠŸ', isAdmin ? `ç®¡ç†å‘˜ ${email} å·²ç™»å½•` : `æ¬¢è¿ ${email}`);
};

const handleSignOut = () => {
    localStorage.removeItem('userEmail');
    currentUserEmail = null;
    isLoggedIn = false;
    isAdmin = false;
    
    updateUIBasedOnAuth();
    showModal('ç™»å‡ºæˆåŠŸ', 'æ‚¨å·²æˆåŠŸç™»å‡ºã€‚');
};

// æŒ‚è½½åˆ°å…¨å±€
window.signInWithEmailOnly = signInWithEmailOnly;
window.handleSignOut = handleSignOut;

// --- æ›´æ–° UI åŸºäºè®¤è¯çŠ¶æ€ ---
const updateUIBasedOnAuth = () => {
    const authStatusDiv = document.getElementById('auth-status');
    const adminFormContainer = document.getElementById('admin-form-container');

    if (isLoggedIn) {
        authStatusDiv.innerHTML = `
            <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-600">
                    ${isAdmin ? 'ğŸ‘‘ ç®¡ç†å‘˜: ' : 'ğŸ‘‹ ç”¨æˆ·: '} ${currentUserEmail}
                </span>
                <button onclick="handleSignOut()" class="px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded-lg hover:bg-red-600 transition">ç™»å‡º</button>
            </div>`;
        adminFormContainer.classList.toggle('hidden', !isAdmin);
    } else {
        authStatusDiv.innerHTML = `
            <div class="flex items-center space-x-2">
                <button onclick="signInWithEmailOnly()" class="px-3 py-1 bg-primary-blue text-white text-xs font-semibold rounded-lg hover:bg-blue-600 transition">Email ç™»å½•</button>
            </div>`;
        adminFormContainer.classList.add('hidden');
    }
};

// --- æ ‡ç­¾ç­›é€‰é€»è¾‘ ---
const setActiveFilter = (tag) => {
    activeFilterTag = tag;
    document.getElementById('reviews-header').textContent = `æ‰€æœ‰è¯„é‰´ (${tag === 'All' ? 'å…¨éƒ¨' : tag})`;
    renderReviews(allReviewsData);
    renderFilterNavbar();
}

const renderFilterNavbar = () => {
    const container = document.getElementById('filter-navbar');
    container.innerHTML = '';
    
    // 1. All æŒ‰é’®
    const allButton = document.createElement('button');
    allButton.textContent = 'All (å…¨éƒ¨)';
    allButton.className = `tag-btn ${activeFilterTag === 'All' ? 'tag-active bg-gray-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`;
    allButton.addEventListener('click', () => setActiveFilter('All'));
    container.appendChild(allButton);
    
    // 2. å›½å®¶/åœ°åŒºæŒ‰é’®
    Object.keys(DEFAULT_TAGS).forEach(country => {
        const states = DEFAULT_TAGS[country];
        
        if (states.length > 1) {
            const countryDiv = document.createElement('div');
            countryDiv.className = 'relative dropdown-hover';
            
            const countryButton = document.createElement('button');
            countryButton.textContent = country;
            const isActiveCountry = activeFilterTag === country || states.includes(activeFilterTag);
            
            countryButton.className = `tag-btn flex items-center ${isActiveCountry ? 'tag-active' : 'bg-primary-blue/10 text-primary-blue hover:bg-primary-blue/20'}`;
            countryButton.addEventListener('click', () => setActiveFilter(country));

            countryButton.innerHTML += `
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `;
            
            const dropdown = document.createElement('div');
            dropdown.className = 'dropdown-menu absolute z-20 mt-2 w-48 rounded-lg shadow-xl bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100';
            
            states.forEach(state => {
                const stateButton = document.createElement('button');
                stateButton.textContent = state;
                stateButton.className = `w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition ${activeFilterTag === state ? 'bg-primary-blue text-white hover:bg-primary-blue/90' : ''}`;
                stateButton.addEventListener('click', () => setActiveFilter(state));
                dropdown.appendChild(stateButton);
            });

            countryDiv.appendChild(countryButton);
            countryDiv.appendChild(dropdown);
            container.appendChild(countryDiv);
            
        } else {
            const countryButton = document.createElement('button');
            countryButton.textContent = country;
            countryButton.className = `tag-btn ${activeFilterTag === country ? 'tag-active bg-red-500 text-white' : 'bg-red-100 text-red-700 hover:bg-red-200'}`;
            countryButton.addEventListener('click', () => setActiveFilter(country));
            container.appendChild(countryButton);
        }
    });
};

// --- æ¸²æŸ“è¯„é‰´åˆ—è¡¨ ---
const renderReviews = (reviews) => {
    const listContainer = document.getElementById('reviews-list');
    listContainer.innerHTML = '';
    
    // 1. è¿‡æ»¤ï¼šåªæ˜¾ç¤ºç®¡ç†å‘˜å‘å¸ƒçš„è¯„è®º
    const adminReviews = reviews.filter(review => review.creatorId === ADMIN_EMAIL);
    
    // 2. æ ‡ç­¾ç­›é€‰
    const filteredByTag = adminReviews.filter(review => {
        if (activeFilterTag === 'All') return true;
        
        const reviewTags = Array.isArray(review.tags) ? review.tags.map(t => t.toLowerCase()) : [];
        return reviewTags.includes(activeFilterTag.toLowerCase());
    });
    
    // 3. å¤„ç†ç©ºçŠ¶æ€
    if (filteredByTag.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('empty-state').querySelector('p').textContent = 
            activeFilterTag === 'All' ? 'ç®¡ç†å‘˜å°šæœªå‘å¸ƒä»»ä½•è¯„é‰´ã€‚' : `åœ¨ ${activeFilterTag} åŒºåŸŸæš‚æ— è¯„é‰´ã€‚`;
        return;
    }
    document.getElementById('empty-state').classList.add('hidden');

    // 4. æ¸²æŸ“è¯„è®º
    filteredByTag.forEach(review => {
        const reviewStatus = review.status;
        const config = RATING_CONFIG[reviewStatus] || RATING_CONFIG['Can eat'];
        const statusColor = config.color;
        const statusText = config.text;
        const statusEmoji = config.emoji;
        
        const likeCount = review.likedBy ? review.likedBy.length : 0;
        const isLiked = review.likedBy && review.likedBy.includes(currentUserEmail);
            
        const likeText = likeCount > 0 
            ? `${likeCount} ä½ç”¨æˆ·è®¤ä¸ºæœ‰ç”¨`
            : 'Found this useful';
            
        const likeButtonDisabled = !isLoggedIn;
        const likeButtonClass = isLiked 
            ? 'bg-useful text-white hover:bg-indigo-700' 
            : 'bg-gray-100 text-gray-600 hover:bg-gray-200';
        
        const deleteButtonHtml = isAdmin ? `
            <button class="delete-btn px-3 py-1 text-sm bg-admin-red text-white rounded-lg hover:bg-red-700 transition" data-id="${review.id}">
                åˆ é™¤
            </button>
        ` : '';
        
        const tagHtml = (review.tags && review.tags.length > 0) 
            ? review.tags.map(tag => `<span class="inline-block bg-primary-blue/10 text-primary-blue text-xs font-medium mr-1 px-2.5 py-0.5 rounded-full">${tag}</span>`).join('')
            : '';

        const reviewElement = document.createElement('div');
        reviewElement.className = 'bg-white p-6 rounded-xl shadow-lg border-l-4 ' + statusColor.replace('bg-', 'border-');
        reviewElement.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <div>
                    <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white ${statusColor}">
                        ${statusEmoji} ${statusText}
                    </span>
                    <h3 class="text-2xl font-extrabold text-gray-900 mt-2">${review.restaurantName}</h3>
                    <p class="text-gray-500 text-sm mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 text-primary-blue" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        ${review.address || 'åœ°å€æœªæä¾›'}
                    </p>
                </div>
                ${deleteButtonHtml}
            </div>

            ${review.imageUrl ? `
                <img src="${review.imageUrl}" alt="${review.restaurantName} å›¾ç‰‡" class="w-full h-48 object-cover rounded-lg mb-4 shadow-inner" onerror="this.onerror=null;this.src='https://placehold.co/600x200/cccccc/333333?text=å›¾ç‰‡åŠ è½½å¤±è´¥';">
            ` : ''}

            <p class="text-gray-700 mb-4">${review.comment}</p>
            
            <!-- æ ‡ç­¾æ˜¾ç¤º -->
            <div class="mb-4">${tagHtml}</div>

            <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                <button id="like-btn-${review.id}" data-liked="${isLiked}" 
                    class="px-4 py-2 text-sm font-semibold rounded-full transition duration-150 flex items-center space-x-2 ${likeButtonClass} ${likeButtonDisabled ? 'opacity-50 cursor-not-allowed' : ''}"
                    title="${likeButtonDisabled ? 'è¯·ç™»å½•ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½' : 'Found this useful'}"
                    ${likeButtonDisabled ? 'disabled' : ''}
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${isLiked ? 'text-white' : 'text-useful'}" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.433a2.5 2.5 0 00.953 1.956 2.5 2.5 0 001.996.183 2.5 2.5 0 002.825-1.042l3.4-6a2.5 2.5 0 00.94-1.879V5.75a1.75 1.75 0 10-3.5 0v2.75l-3.4 6c-.15.263-.448.425-.774.425-.333 0-.638-.17-.788-.445l-.462-.871c-.08-.15-.17-.306-.27-.47L6 10.333z" />
                    </svg>
                    <span class="hidden sm:inline-block">${likeText}</span>
                    <span class="sm:hidden">${likeText}</span>
                    <span class="ml-1 px-2 py-0.5 text-xs rounded-full ${isLiked ? 'bg-indigo-500' : 'bg-useful text-white'}">${likeCount}</span>
                </button>
            </div>
        `;
        listContainer.appendChild(reviewElement);
    });

    // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
    filteredByTag.forEach(review => {
        if (isAdmin) {
            const deleteButton = document.querySelector(`.delete-btn[data-id="${review.id}"]`);
            if (deleteButton) {
                deleteButton.addEventListener('click', () => handleDelete(review.id, review.restaurantName));
            }
        }
        
        const likeButton = document.getElementById(`like-btn-${review.id}`);
        if (likeButton && isLoggedIn) { 
            likeButton.addEventListener('click', (e) => {
                const isLiked = e.currentTarget.getAttribute('data-liked') === 'true';
                handleLike(review.id, isLiked);
            });
        }
    });
};

// ç›‘å¬ Firestore å˜åŒ–
const startReviewListener = () => {
     const reviewsColRef = collection(db, getCollectionPath());

    onSnapshot(reviewsColRef, (snapshot) => {
        const reviews = [];
        snapshot.forEach(doc => {
            reviews.push({ id: doc.id, ...doc.data() });
        });
        // æ’åºï¼šæœ€æ–°çš„åœ¨æœ€å‰é¢
        reviews.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 
        
        allReviewsData = reviews;
        renderReviews(allReviewsData);
        renderFilterNavbar();
    }, (error) => {
        console.error("ç›‘å¬è¯„è®ºå¤±è´¥:", error);
        showModal("æ•°æ®é”™è¯¯", "æ— æ³•å®æ—¶è·å–è¯„è®ºæ•°æ®ã€‚");
    });
}

// å¤„ç†è¡¨å•æäº¤ (ä»…ç®¡ç†å‘˜)
const handleFormSubmit = async (e) => {
    e.preventDefault();

    if (!isAdmin) {
        showModal("æƒé™ä¸è¶³", "åªæœ‰ç®¡ç†å‘˜æ‰èƒ½æ·»åŠ æ–°çš„é¤å…è¯„é‰´ã€‚");
        return;
    }

    const restaurantName = document.getElementById('restaurantName').value.trim();
    const address = document.getElementById('address').value.trim();
    const imageUrl = document.getElementById('imageUrl').value.trim();
    const status = document.getElementById('status').value;
    const comment = document.getElementById('comment').value.trim();
    const tagsInput = document.getElementById('tags').value.trim();

    if (!restaurantName || !status || !comment || !address) {
        showModal("è¾“å…¥é”™è¯¯", "è¯·å¡«å†™é¤å…åç§°ã€åœ°å€ã€çŠ¶æ€å’Œè¯„è®ºã€‚");
        return;
    }
    
    const tagsArray = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

    try {
        const reviewsColRef = collection(db, getCollectionPath());
        await addDoc(reviewsColRef, {
            restaurantName,
            address,
            imageUrl,
            status,
            comment,
            tags: tagsArray, 
            creatorId: ADMIN_EMAIL, // ä½¿ç”¨é‚®ç®±ä½œä¸ºåˆ›å»ºè€…ID
            likedBy: [], 
            timestamp: Date.now()
        });

        showModal("æäº¤æˆåŠŸ", `é¤å…è¯„é‰´ "${restaurantName}" å·²æ·»åŠ ã€‚`);
        e.target.reset();
    } catch (error) {
        console.error("æ·»åŠ è¯„é‰´å¤±è´¥:", error);
        showModal("æäº¤å¤±è´¥", `æ— æ³•æ·»åŠ è¯„é‰´: ${error.message}`);
    }
};

// å¤„ç†ç‚¹èµ/å–æ¶ˆç‚¹èµ (ä»…ç™»å½•ç”¨æˆ·)
const handleLike = async (reviewId, isLiked) => {
    if (!isLoggedIn) {
        showModal("æƒé™ä¸è¶³", "è¯·å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨ 'Found this useful' åŠŸèƒ½ã€‚");
        return;
    }

    try {
        const reviewRef = doc(db, getCollectionPath(), reviewId);
        
        const updateField = isLiked ? arrayRemove(currentUserEmail) : arrayUnion(currentUserEmail);
        
        await updateDoc(reviewRef, {
            likedBy: updateField
        });
    } catch (error) {
        console.error("æ›´æ–°ç‚¹èµçŠ¶æ€å¤±è´¥:", error);
        showModal("æ“ä½œå¤±è´¥", "æ— æ³•æ›´æ–° 'Found this useful' çŠ¶æ€ã€‚");
    }
};

// å¤„ç†åˆ é™¤ (ä»…ç®¡ç†å‘˜)
const handleDelete = async (reviewId, restaurantName) => {
     if (!isAdmin) {
        showModal("æƒé™ä¸è¶³", "åªæœ‰ç®¡ç†å‘˜æ‰èƒ½åˆ é™¤é¤å…è¯„é‰´ã€‚");
        return;
    }
    
    showModal("ç¡®è®¤åˆ é™¤", `æ‚¨ç¡®å®šè¦åˆ é™¤é¤å… "${restaurantName}" çš„è¯„é‰´å—ï¼Ÿ`);
    
    const originalModalCloseBtn = document.getElementById('modal-close-btn');
    const originalClick = originalModalCloseBtn.onclick;

    const tempCloseListener = () => {
        document.getElementById('modal-backdrop').classList.add('hidden');
        document.getElementById('modal-backdrop').classList.remove('flex');
    };
    originalModalCloseBtn.onclick = tempCloseListener; 

    const confirmDelete = async () => {
        try {
            await deleteDoc(doc(db, getCollectionPath(), reviewId));
            
            originalModalCloseBtn.removeEventListener('click', confirmDelete);
            originalModalCloseBtn.onclick = originalClick; 
            showModal("åˆ é™¤æˆåŠŸ", `è¯„é‰´ "${restaurantName}" å·²è¢«åˆ é™¤ã€‚`);
        } catch (error) {
            originalModalCloseBtn.removeEventListener('click', confirmDelete);
            originalModalCloseBtn.onclick = originalClick;
            console.error("åˆ é™¤å¤±è´¥:", error);
            showModal("åˆ é™¤å¤±è´¥", `æ— æ³•åˆ é™¤è¯„é‰´: ${error.message}`);
        }
    };

    originalModalCloseBtn.removeEventListener('click', tempCloseListener);
    originalModalCloseBtn.addEventListener('click', confirmDelete, { once: true });
};

// ç»‘å®šäº‹ä»¶å’Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('add-review-form');
    if (form) {
        form.addEventListener('submit', handleFormSubmit);
    }
    
    // ç®¡ç†å‘˜å…³é—­è¡¨å•æŒ‰é’®
    document.getElementById('closeAdminForm').addEventListener('click', () => {
        const adminFormContainer = document.getElementById('admin-form-container');
        adminFormContainer.classList.add('hidden');
        adminFormContainer.dataset.visibility = 'hidden'; 
    });
});

// åº”ç”¨ç¨‹åºå…¥å£ç‚¹ï¼šé¦–å…ˆæ£€æŸ¥ T&C
window.onload = checkTermsAndConditions;
</script>
</body>
</html>


