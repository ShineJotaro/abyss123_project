<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>abyss_123çš„é¤å…è¯„é‰´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- æ¨¡å—è„šæœ¬ 1: Firebase ä¾èµ–å¯¼å…¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // è®¾ç½® Firebase æ—¥å¿—çº§åˆ«
        setLogLevel('error'); // å‡å°‘æ§åˆ¶å°å™ªéŸ³
        
        // å…¨å±€å˜é‡ï¼Œç”¨äºåœ¨å…¶ä»–è„šæœ¬ä¸­è®¿é—®
        window.firebase = { 
            initializeApp, 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, writeBatch 
        };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'best': '#10b981', 
                        'good': '#3b82f6', 
                        'caneat': '#f59e0b', 
                        'bad': '#ef4444', 
                        'primary-blue': '#3b82f6',
                        'ai-sparkle': '#f97316', 
                        'useful': '#6366f1', 
                        'admin-red': '#dc2626', 
                    }
                }
            }
        }
    </script>
    <style>
        /* ç§»é™¤ loading-hiddenï¼Œå…¨éƒ¨ä½¿ç”¨ hidden */
        /* æ”¹è¿›ä¸‹æ‹‰èœå•çš„å¯è§æ€§æ§åˆ¶ */
        .dropdown-menu {
            transition: all 0.3s ease-out;
            opacity: 0;
            visibility: hidden;
            transform: translateY(5px);
            pointer-events: none; /* é»˜è®¤ç¦ç”¨é¼ æ ‡äº‹ä»¶ */
        }
        .dropdown-hover:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto; /* æ‚¬åœæ—¶å¯ç”¨é¼ æ ‡äº‹ä»¶ */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Custom color classes */
        .bg-best { background-color: #10b981; }
        .bg-good { background-color: #3b82f6; }
        .bg-caneat { background-color: #f59e0b; }
        .bg-bad { background-color: #ef4444; }
        
        /* æ ‡ç­¾å¯¼èˆªæ çš„æ ·å¼ */
        .tag-btn {
            @apply px-4 py-2 text-sm font-medium rounded-lg transition duration-150 cursor-pointer;
        }
        .tag-active {
            @apply bg-primary-blue text-white shadow-md;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- T&C æ¨¡æ€æ¡† (æ–°ç»“æ„) -->
    <div id="terms-and-conditions-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[9999] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-8 transform transition-all">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">æœåŠ¡æ¡æ¬¾ä¸å…è´£å£°æ˜ / Terms & Conditions and Disclaimer</h2>
            
            <div class="text-sm text-gray-700 space-y-4 mb-6 pr-4">

                <h3 class="font-semibold text-lg text-primary-blue mt-4">æ ¸å¿ƒå…è´£å£°æ˜ (Core Disclaimer)</h3>
                <p class="font-medium text-red-600 border-l-4 border-red-500 pl-3 py-1 bg-red-50/50">
                    **é‡è¦å£°æ˜:** ä»¥ä¸Šæ‰€æœ‰æ¨èå†…å®¹ä»…ä»¥æˆ‘ï¼ˆabyss_123ï¼‰**åƒåˆ°é£Ÿç‰©çš„å½“ä¸‹ä¸ºæ ‡å‡†**ã€‚æˆ‘ä»¬ä¸å¯¹é¤å…åç»­çš„è¿›æ­¥æˆ–é€€æ­¥æ‰€å¯¼è‡´çš„é—®é¢˜æ‰¿æ‹…ä»»ä½•è´£ä»»ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºé£Ÿç‰©ä¸­æ¯’ã€é£Ÿç‰©å£å‘³ä¸ä½³æˆ–æ‚¨è®¤ä¸ºæˆ‘æœªæ¨èä½†å®é™…å¾ˆç¾å‘³çš„é£Ÿç‰©ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å¯¹ç”¨æˆ·æˆ–é¤å…å¯¹å½¼æ­¤çš„æ€¨è¨€ã€è¡ŒåŠ¨æˆ–ä»»ä½•æ³•å¾‹è´£ä»»ä¸è´Ÿè´£ä»»ã€‚æ‚¨å¿…é¡»æ¥å—æ­¤æ¡æ¬¾æ‰èƒ½ç»§ç»­ä½¿ç”¨æœ¬ç½‘ç«™ã€‚
                </p>

                <p class="font-medium text-red-600 border-l-4 border-red-500 pl-3 py-1 bg-red-50/50">
                    **Crucial Disclaimer:** All recommendations herein are based **solely on the quality of the food at the moment I (abyss_123) consumed it**.
                    We are not responsible for any issues arising from the restaurant's subsequent improvement or deterioration, including but not limited to food poisoning, bad taste, or highly-rated food that I did not recommend.
                    Furthermore, we are not liable for any user or restaurant grievances, actions, or legal matters directed at each other.
                    You must accept this term to proceed.
                </p>

                <h3 class="font-semibold text-lg text-gray-700 mt-6">æ ‡å‡†æœåŠ¡æ¡æ¬¾ (Standard Terms of Service)</h3>
                <p>
                    **Cookie æ”¿ç­–:** æœ¬ç½‘ç«™ä½¿ç”¨ Cookieï¼ˆæˆ–æœ¬åœ°å­˜å‚¨ï¼‰æ¥å­˜å‚¨æ‚¨çš„åå¥½è®¾ç½®å’Œä¼šè¯çŠ¶æ€ï¼ˆåŒ…æ‹¬æ‚¨æ¥å—æ­¤æ¡æ¬¾çš„çŠ¶æ€ï¼‰ã€‚é€šè¿‡ä½¿ç”¨æœ¬ç½‘ç«™ï¼Œæ‚¨åŒæ„æˆ‘ä»¬æ ¹æ®æˆ‘ä»¬çš„ Cookie æ”¿ç­–ä½¿ç”¨ Cookieã€‚
                </p>
            
                <p>
                    **éšç§æ”¿ç­–:** æˆ‘ä»¬é‡è§†æ‚¨çš„éšç§ã€‚æˆ‘ä»¬ä»…æ”¶é›†å’Œä½¿ç”¨ä¸ºæä¾›åŸºæœ¬æœåŠ¡ï¼ˆå¦‚ç”¨æˆ·è®¤è¯ã€ç‚¹èµåŠŸèƒ½ï¼‰æ‰€å¿…éœ€çš„æ•°æ®ï¼Œä¾‹å¦‚æ‚¨çš„ Google ç”¨æˆ·IDã€‚æ‚¨çš„ä¸ªäººä¿¡æ¯ï¼ˆå¦‚è¯„è®ºæˆ–å›¾ç‰‡ï¼‰ä¸ä¼šè¢«å…¬å¼€åˆ†äº«ç»™ç¬¬ä¸‰æ–¹ï¼Œé™¤éæ³•å¾‹è¦æ±‚ã€‚
                </p>
                <p>
                    **ä½¿ç”¨é™åˆ¶:** æ‚¨åŒæ„ä¸ä»¥ä»»ä½•éæ³•ã€æœ‰å®³æˆ–ä¾µçŠ¯ä»–äººæƒåˆ©çš„æ–¹å¼ä½¿ç”¨æœ¬ç½‘ç«™ã€‚
                </p>

    
                <h3 class="font-semibold text-lg text-gray-700 mt-6">Standard Terms of Service</h3>
                <p>
                    **Cookie Policy:** This site uses cookies (or local storage) to store your preferences and session status (including your acceptance of these terms).
                    By using this site, you consent to our use of cookies in accordance with our Cookie Policy.
                </p>
                <p>
                    **Privacy Policy:** We value your privacy.
                    We only collect and use data necessary for providing essential services (such as user authentication, and like features), such as your Google User ID.
                    Your personal information (such as comments or images) will not be publicly shared with third parties unless required by law.
                </p>
                <p>
                    **Use Restrictions:** You agree not to use this site in any manner that is unlawful, harmful, or infringes upon the rights of others.
                </p>
            </div>

            <div class="flex justify-end space-x-4 border-t pt-4">
                <button id="decline-terms-btn" class="px-6 py-2 text-base font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    ä¸æ¥å—å¹¶é€€å‡º (Decline & Exit)
                </button>
            
                <button id="accept-terms-btn" class="px-6 py-2 text-base font-medium text-white bg-primary-blue rounded-lg hover:bg-blue-600 transition">
                    æˆ‘æ¥å—æ¡æ¬¾ (I Accept the Terms)
                </button>
            </div>
        </div>
    </div>
    
    <!-- åŠ è½½æŒ‡ç¤ºå™¨ (æ–°ç»“æ„) -->
    <div id="loading-indicator" class="fixed inset-0 bg-white/70 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-sm text-primary-blue">åº”ç”¨åˆå§‹åŒ–ä¸­...</p>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="app-container" class="opacity-0 hidden transition-opacity duration-500 max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- å¤´éƒ¨ & è®¤è¯çŠ¶æ€ -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">abyss_123çš„é¤å…è¯„é‰´</h1>
            <div id="auth-status" class="relative">
                <!-- è®¤è¯çŠ¶æ€å°†åœ¨æ­¤å¤„æ¸²æŸ“ -->
            </div>
        </header>

        <!-- ç®¡ç†å‘˜æ·»åŠ è¯„é‰´è¡¨å• -->
        <div id="admin-form-container" class="mb-10 p-6 bg-white shadow-xl rounded-xl border border-primary-blue/30 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-primary-blue">ç®¡ç†å‘˜ï¼šæ·»åŠ é¤å…è¯„é‰´</h2>
            <form id="add-review-form" class="space-y-4">
                <input type="text" id="restaurantName" placeholder="é¤å…åç§°" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                <input type="text" id="address" placeholder="é¤å…åœ°å€" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                <input type="url" id="imageUrl" placeholder="å›¾ç‰‡ URL (PNG/JPG/å…¶ä»–)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                
                <!-- æ›´æ–°åçš„è¯„åˆ†çŠ¶æ€é€‰æ‹© -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">è¯„åˆ†çŠ¶æ€</label>
                    <select id="status" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue transition bg-white">
                        <option value="">é€‰æ‹©è¯„åˆ†</option>
                        <option value="Best">Best ğŸ˜† (æœ€ä½³)</option>
                        <option value="Good">Good ğŸ˜ (ä¸é”™)</option>
                        <option value="Can eat">Can eat ğŸ™‚ (å¯ä»¥åƒ)</option>
                        <option value="Bad">Bad ğŸ˜  (å·®è¯„)</option>
                    </select>
                </div>
                
                <!-- æ–°å¢æ ‡ç­¾è¾“å…¥æ¡† -->
                <input type="text" id="tags" placeholder="å›½å®¶/å·å±æ ‡ç­¾ (ä¾‹å¦‚: Malaysia, Penang) å¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                <textarea id="comment" placeholder="è¯¦ç»†è¯„è®º (å¿…å¡«)" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue"></textarea>
                <button type="submit" class="w-full py-3 bg-primary-blue text-white font-bold rounded-lg hover:bg-blue-600 transition duration-150">æäº¤è¯„é‰´</button>
                <!-- æ–°å¢å…³é—­æŒ‰é’® -->
                <button type="button" id="closeAdminForm" class="w-full py-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-150">å…³é—­æ­¤é¡µé¢</button>
            </form>
        </div>
        
        <!-- æ ‡ç­¾ç­›é€‰/å¯¼èˆªæ  -->
        <nav id="filter-navbar-container" class="mb-6 bg-white shadow-md rounded-xl p-4 sticky top-0 z-10 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">æŒ‰å›½å®¶/å·å±ç­›é€‰</h2>
            <div id="filter-navbar" class="flex flex-wrap gap-2">
                <!-- ç­›é€‰æŒ‰é’®å°†åœ¨æ­¤å¤„æ¸²æŸ“ -->
            </div>
        </nav>


        <!-- é¤å…è¯„é‰´åˆ—è¡¨ -->
        <section class="mt-8">
            <h2 id="reviews-header" class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">æ‰€æœ‰è¯„é‰´ (å…¨éƒ¨)</h2>
            <div id="reviews-list" class="space-y-6">
                <!-- è¯„è®ºå°†åœ¨æ­¤å¤„æ¸²æŸ“ -->
            </div>
            <div id="empty-state" class="text-center p-10 bg-white rounded-xl shadow mt-6 hidden">
                <p class="text-gray-500 italic">ç›®å‰è¿˜æ²¡æœ‰ä»»ä½•é¤å…è¯„é‰´ã€‚</p>
            </div>
        </section>

        <!-- æ¨¡æ€æ¡†ç”¨äºæç¤ºä¿¡æ¯ -->
        <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center transition-opacity duration-300">
            <div id="app-modal" class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transition-transform duration-300 transform scale-95">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
                <p id="modal-message" class="text-gray-600 mb-4"></p>
                <button id="modal-close-btn" class="w-full py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-600 transition">ç¡®å®š</button>
            </div>
        </div>
        
        <!-- å¹¿å‘Šå®¹å™¨ (ç½‘ç«™æœ€ä¸‹æ–¹) -->
        <div class="max-w-4xl mx-auto p-4 sm:p-8 mt-12">
            <div class="ads-container p-4 bg-gray-100 rounded-xl text-center">
                <p class="text-sm text-gray-500 mb-2">å¹¿å‘ŠèµåŠ©å•†å†…å®¹</p>
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9923429709566940"
                    crossorigin="anonymous"></script>
                <ins class="adsbygoogle"
                    style="display:block; min-height: 100px;"
                    data-ad-format="autorelaxed"
                    data-ad-client="ca-pub-9923429709566940"
                    data-ad-slot="7327876978"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>

    </div>

    <!-- æ¨¡å—è„šæœ¬ 2: ä¸»è¦åº”ç”¨é€»è¾‘ -->
    <script type="module">
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// è·å–å…¨å±€å˜é‡
const { initializeApp, signInAnonymously, signInWithCustomToken } = window.firebase;

// --- ç¼ºå¤±çš„å‡½æ•°å®šä¹‰ ---
const signInWithGoogle = async () => {
    try {
        const provider = new GoogleAuthProvider();
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        
        // è®¾ç½®ç®¡ç†å‘˜æ£€æŸ¥
        const ADMIN_EMAIL = 'jefflai123123@gmail.com';
        isAdmin = user.email === ADMIN_EMAIL;
        isLoggedIn = true;
        currentUserId = user.uid;
        
        updateUIBasedOnAuth();
        showModal('ç™»å½•æˆåŠŸ', isAdmin ? 'ç®¡ç†å‘˜å·²ç™»å½•' : `æ¬¢è¿ ${user.email}`);
        
    } catch (error) {
        console.error('Google ç™»å½•å¤±è´¥:', error);
        showModal('ç™»å½•å¤±è´¥', 'æ— æ³•é€šè¿‡ Google ç™»å½•ï¼Œè¯·é‡è¯•ã€‚');
    }
};

const handleSignOut = async () => {
    try {
        await signOut(auth);
        isLoggedIn = false;
        isAdmin = false;
        currentUserId = null;
        updateUIBasedOnAuth();
        showModal('ç™»å‡ºæˆåŠŸ', 'æ‚¨å·²æˆåŠŸç™»å‡ºã€‚');
    } catch (error) {
        console.error('ç™»å‡ºå¤±è´¥:', error);
        showModal('ç™»å‡ºå¤±è´¥', 'ç™»å‡ºè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ã€‚');
    }
};

// æŒ‚è½½åˆ°å…¨å±€
window.signInWithGoogle = signInWithGoogle;
window.handleSignOut = handleSignOut;

// --- è¯„åˆ†é…ç½®æ˜ å°„ (RATING_CONFIG) ---
const RATING_CONFIG = {
    'Best': { emoji: 'ğŸ˜†', color: 'bg-best', text: 'æœ€ä½³' },
    'Good': { emoji: 'ğŸ˜', color: 'bg-good', text: 'ä¸é”™' },
    'Can eat': { emoji: 'ğŸ™‚', color: 'bg-caneat', text: 'å¯ä»¥åƒ' },
    'Bad': { emoji: 'ğŸ˜ ', color: 'bg-bad', text: 'å·®è¯„' },
    'All': { emoji: '', color: 'bg-primary-blue', text: 'å…¨éƒ¨' }
};

// --- å…¨å±€çŠ¶æ€ & å¸¸é‡ ---
let db;
let auth;
let ADMIN_ID = 'unknown'; 
let isAuthReady = false;
let currentUserId = null;
let isLoggedIn = false;
let isAdmin = false;
let activeFilterTag = 'All'; // å½“å‰ç­›é€‰çš„æ ‡ç­¾
let allReviewsData = []; // å­˜å‚¨æ‰€æœ‰è¯„è®ºçš„åŸå§‹æ•°æ®

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = {
    apiKey: "AIzaSyCD7f8ZnlXZuI_DiBc_M2c9jl44WajJMhw",
    authDomain: "abyss123-project.firebaseapp.com",
    projectId: "abyss123-project",
    storageBucket: "abyss123-project.firebasestorage.app",
    messagingSenderId: "233505718695",
    appId: "1:233505718695:web:1a62ca261f9ebd9beaf682"
};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

// é»˜è®¤æ ‡ç­¾åˆ—è¡¨
const DEFAULT_TAGS = {
    'Malaysia': [
        'Johor', 'Kedah', 'Kelantan', 'Malacca', 'Negeri Sembilan', 
        'Pahang', 'Penang', 'Perak', 'Perlis', 'Sabah', 
        'Sarawak', 'Selangor', 'Terengganu', 'Kuala Lumpur', 
        'Labuan', 'Putrajaya'
    ],
    'Singapore': ['Singapore'],
};

// Firestore é›†åˆè·¯å¾„
const getCollectionPath = () => `/artifacts/${appId}/public/data/reviews`;

// --- UI / æ¨¡æ€æ¡†å‡½æ•° ---
const showModal = (title, message) => {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message').textContent = message;
    document.getElementById('modal-backdrop').classList.remove('hidden');
    document.getElementById('modal-backdrop').classList.add('flex');
    document.getElementById('app-modal').classList.remove('scale-95');
    document.getElementById('app-modal').classList.add('scale-100');
};

document.getElementById('modal-close-btn').addEventListener('click', () => {
    document.getElementById('modal-backdrop').classList.add('hidden');
    document.getElementById('modal-backdrop').classList.remove('flex');
});

// T&C æ¨¡æ€æ¡†æ£€æŸ¥ (ä¿®å¤ç‰ˆæœ¬)
const checkTermsAndConditions = () => {
    const accepted = sessionStorage.getItem('T&C_Accepted') === 'true';
    const termsModalBackdrop = document.getElementById('terms-and-conditions-modal');
    const acceptBtn = termsModalBackdrop.querySelector('#accept-terms-btn');
    const declineBtn = termsModalBackdrop.querySelector('#decline-terms-btn');

    if (accepted) {
        termsModalBackdrop.classList.add('hidden');
        document.getElementById('loading-indicator').classList.remove('hidden'); 
        initializeFirebase();
    } else {
        // æ˜¾ç¤º T&C æ¨¡æ€æ¡†
        termsModalBackdrop.classList.remove('hidden');
        
        // Handle Accept
        acceptBtn.addEventListener('click', () => {
            sessionStorage.setItem('T&C_Accepted', 'true');
            termsModalBackdrop.classList.add('hidden');
            document.getElementById('loading-indicator').classList.remove('hidden');
            initializeFirebase();
        }, { once: true });
        
        // Handle Decline - è·³è½¬åˆ°é¦–é¡µ
        declineBtn.addEventListener('click', () => {
            // ç”¨æˆ·é€‰æ‹©æ‹’ç»ï¼Œè·³è½¬åˆ°é¦–é¡µ
            window.location.href = 'index.html';
        }, { once: true });
    }
};

// --- Firebase åˆå§‹åŒ– & è®¤è¯ ---
const initializeFirebase = async () => {
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        if (initialAuthToken) {
            const userCredential = await signInWithCustomToken(auth, initialAuthToken);
            ADMIN_ID = userCredential.user.uid;
        } else {
            await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
            isAuthReady = true;
            if (user) {
                currentUserId = user.uid;
                isLoggedIn = !user.isAnonymous;
                isAdmin = user.uid === ADMIN_ID && initialAuthToken !== undefined; 
            } else {
                currentUserId = crypto.randomUUID(); 
                isLoggedIn = false;
                isAdmin = false;
            }
            updateUIBasedOnAuth();
            startReviewListener();
        });

    } catch (error) {
        console.error("Firebase åˆå§‹åŒ–æˆ–è®¤è¯å¤±è´¥:", error);
        showModal("åˆå§‹åŒ–é”™è¯¯", "åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æˆ–ç¨åé‡è¯•ã€‚");
    } finally {
        document.getElementById('loading-indicator').classList.add('hidden');
        document.getElementById('app-container').classList.remove('opacity-0', 'hidden');
    }
};

// --- æ›´æ–° UI åŸºäºè®¤è¯çŠ¶æ€ ---
const updateUIBasedOnAuth = () => {
    const authStatusDiv = document.getElementById('auth-status');
    const adminFormContainer = document.getElementById('admin-form-container');

    if (isLoggedIn) {
        authStatusDiv.innerHTML = `
            <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-600">
                    ${isAdmin ? 'ğŸ‘‘ ç®¡ç†å‘˜' : 'ğŸ‘‹ ç”¨æˆ·'}
                </span>
                <button onclick="handleSignOut()" class="px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded-lg hover:bg-red-600 transition">ç™»å‡º</button>
            </div>`;
        adminFormContainer.classList.toggle('hidden', !isAdmin);
    } else {
        authStatusDiv.innerHTML = `
            <div class="flex items-center space-x-2">
                <button onclick="signInWithGoogle()" class="px-3 py-1 bg-primary-blue text-white text-xs font-semibold rounded-lg hover:bg-blue-600 transition">Google ç™»å½•</button>
            </div>`;
        adminFormContainer.classList.add('hidden');
    }
};

// å…¶ä½™çš„ä»£ç ä¿æŒä¸å˜...
// [ä¿ç•™æ‚¨åŸæœ‰çš„æ ‡ç­¾ç­›é€‰ã€æ¸²æŸ“è¯„è®ºã€è¡¨å•å¤„ç†ç­‰å‡½æ•°]

// ç»‘å®šäº‹ä»¶å’Œåˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('add-review-form');
    if (form) {
        form.addEventListener('submit', handleFormSubmit);
    }
    
    // ç®¡ç†å‘˜å…³é—­è¡¨å•æŒ‰é’®
    document.getElementById('closeAdminForm').addEventListener('click', () => {
        const adminFormContainer = document.getElementById('admin-form-container');
        adminFormContainer.classList.add('hidden');
        adminFormContainer.dataset.visibility = 'hidden'; 
    });
});

// åº”ç”¨ç¨‹åºå…¥å£ç‚¹ï¼šé¦–å…ˆæ£€æŸ¥ T&C
window.onload = checkTermsAndConditions;
</script>



    
</body>
</html>




