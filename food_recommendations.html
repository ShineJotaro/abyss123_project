<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>abyss_123的餐厅评鉴</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 模块脚本 1: Firebase 依赖导入 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // 设置 Firebase 日志级别
        setLogLevel('error'); // 减少控制台噪音
        
        // 全局变量，用于在其他脚本中访问
        window.firebase = { 
            initializeApp, 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, 
            getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, writeBatch 
        };
    </script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        'best': '#10b981', 
                        'good': '#3b82f6', 
                        'caneat': '#f59e0b', 
                        'bad': '#ef4444', 
                        'primary-blue': '#3b82f6',
                        'ai-sparkle': '#f97316', 
                        'useful': '#6366f1', 
                        'admin-red': '#dc2626', 
                    }
                }
            }
        }
    </script>
    <style>
        /* 移除 loading-hidden，全部使用 hidden */
        /* 改进下拉菜单的可见性控制 */
        .dropdown-menu {
            transition: all 0.3s ease-out;
            opacity: 0;
            visibility: hidden;
            transform: translateY(5px);
            pointer-events: none; /* 默认禁用鼠标事件 */
        }
        .dropdown-hover:hover .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto; /* 悬停时启用鼠标事件 */
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Custom color classes */
        .bg-best { background-color: #10b981; }
        .bg-good { background-color: #3b82f6; }
        .bg-caneat { background-color: #f59e0b; }
        .bg-bad { background-color: #ef4444; }
        
        /* 标签导航栏的样式 */
        .tag-btn {
            @apply px-4 py-2 text-sm font-medium rounded-lg transition duration-150 cursor-pointer;
        }
        .tag-active {
            @apply bg-primary-blue text-white shadow-md;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- T&C 模态框 (新结构) -->
    <div id="terms-and-conditions-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[9999] flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-8 transform transition-all">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 border-b pb-2">服务条款与免责声明 / Terms & Conditions and Disclaimer</h2>
            
            <div class="text-sm text-gray-700 space-y-4 mb-6 pr-4">

                <h3 class="font-semibold text-lg text-primary-blue mt-4">核心免责声明 (Core Disclaimer)</h3>
                <p class="font-medium text-red-600 border-l-4 border-red-500 pl-3 py-1 bg-red-50/50">
                    **重要声明:** 以上所有推荐内容仅以我（abyss_123）**吃到食物的当下为标准**。我们不对餐厅后续的进步或退步所导致的问题承担任何责任，包括但不限于食物中毒、食物口味不佳或您认为我未推荐但实际很美味的食物。同时，我们对用户或餐厅对彼此的怨言、行动或任何法律责任不负责任。您必须接受此条款才能继续使用本网站。
                </p>

                <p class="font-medium text-red-600 border-l-4 border-red-500 pl-3 py-1 bg-red-50/50">
                    **Crucial Disclaimer:** All recommendations herein are based **solely on the quality of the food at the moment I (abyss_123) consumed it**.
                    We are not responsible for any issues arising from the restaurant's subsequent improvement or deterioration, including but not limited to food poisoning, bad taste, or highly-rated food that I did not recommend.
                    Furthermore, we are not liable for any user or restaurant grievances, actions, or legal matters directed at each other.
                    You must accept this term to proceed.
                </p>

                <h3 class="font-semibold text-lg text-gray-700 mt-6">标准服务条款 (Standard Terms of Service)</h3>
                <p>
                    **Cookie 政策:** 本网站使用 Cookie（或本地存储）来存储您的偏好设置和会话状态（包括您接受此条款的状态）。通过使用本网站，您同意我们根据我们的 Cookie 政策使用 Cookie。
                </p>
            
                <p>
                    **隐私政策:** 我们重视您的隐私。我们仅收集和使用为提供基本服务（如用户认证、点赞功能）所必需的数据，例如您的 Google 用户ID。您的个人信息（如评论或图片）不会被公开分享给第三方，除非法律要求。
                </p>
                <p>
                    **使用限制:** 您同意不以任何非法、有害或侵犯他人权利的方式使用本网站。
                </p>

    
                <h3 class="font-semibold text-lg text-gray-700 mt-6">Standard Terms of Service</h3>
                <p>
                    **Cookie Policy:** This site uses cookies (or local storage) to store your preferences and session status (including your acceptance of these terms).
                    By using this site, you consent to our use of cookies in accordance with our Cookie Policy.
                </p>
                <p>
                    **Privacy Policy:** We value your privacy.
                    We only collect and use data necessary for providing essential services (such as user authentication, and like features), such as your Google User ID.
                    Your personal information (such as comments or images) will not be publicly shared with third parties unless required by law.
                </p>
                <p>
                    **Use Restrictions:** You agree not to use this site in any manner that is unlawful, harmful, or infringes upon the rights of others.
                </p>
            </div>

            <div class="flex justify-end space-x-4 border-t pt-4">
                <button id="decline-terms-btn" class="px-6 py-2 text-base font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">
                    不接受并退出 (Decline & Exit)
                </button>
            
                <button id="accept-terms-btn" class="px-6 py-2 text-base font-medium text-white bg-primary-blue rounded-lg hover:bg-blue-600 transition">
                    我接受条款 (I Accept the Terms)
                </button>
            </div>
        </div>
    </div>
    
    <!-- 加载指示器 (新结构) -->
    <div id="loading-indicator" class="fixed inset-0 bg-white/70 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-primary-blue" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-sm text-primary-blue">应用初始化中...</p>
        </div>
    </div>

    <!-- 主应用容器 -->
    <div id="app-container" class="opacity-0 hidden transition-opacity duration-500 max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- 头部 & 认证状态 -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">abyss_123的餐厅评鉴</h1>
            <div id="auth-status" class="relative">
                <!-- 认证状态将在此处渲染 -->
            </div>
        </header>

        <!-- 管理员添加评鉴表单 -->
        <div id="admin-form-container" class="mb-10 p-6 bg-white shadow-xl rounded-xl border border-primary-blue/30 hidden">
            <h2 class="text-2xl font-semibold mb-4 text-primary-blue">管理员：添加餐厅评鉴</h2>
            <form id="add-review-form" class="space-y-4">
                <input type="text" id="restaurantName" placeholder="餐厅名称" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                <input type="text" id="address" placeholder="餐厅地址" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                <input type="url" id="imageUrl" placeholder="图片 URL (PNG/JPG/其他)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                
                <!-- 更新后的评分状态选择 -->
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700">评分状态</label>
                    <select id="status" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 focus:ring-primary-blue focus:border-primary-blue transition bg-white">
                        <option value="">选择评分</option>
                        <option value="Best">Best 😆 (最佳)</option>
                        <option value="Good">Good 😁 (不错)</option>
                        <option value="Can eat">Can eat 🙂 (可以吃)</option>
                        <option value="Bad">Bad 😠 (差评)</option>
                    </select>
                </div>
                
                <!-- 新增标签输入框 -->
                <input type="text" id="tags" placeholder="国家/州属标签 (例如: Malaysia, Penang) 多个标签用逗号分隔" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue">
                <textarea id="comment" placeholder="详细评论 (必填)" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue"></textarea>
                <button type="submit" class="w-full py-3 bg-primary-blue text-white font-bold rounded-lg hover:bg-blue-600 transition duration-150">提交评鉴</button>
                <!-- 新增关闭按钮 -->
                <button type="button" id="closeAdminForm" class="w-full py-3 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition duration-150">关闭此页面</button>
            </form>
        </div>
        
        <!-- 标签筛选/导航栏 -->
        <nav id="filter-navbar-container" class="mb-6 bg-white shadow-md rounded-xl p-4 sticky top-0 z-10 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">按国家/州属筛选</h2>
            <div id="filter-navbar" class="flex flex-wrap gap-2">
                <!-- 筛选按钮将在此处渲染 -->
            </div>
        </nav>

        <!-- 餐厅评鉴列表 -->
        <section class="mt-8">
            <h2 id="reviews-header" class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">所有评鉴 (全部)</h2>
            <div id="reviews-list" class="space-y-6">
                <!-- 评论将在此处渲染 -->
            </div>
            <div id="empty-state" class="text-center p-10 bg-white rounded-xl shadow mt-6 hidden">
                <p class="text-gray-500 italic">目前还没有任何餐厅评鉴。</p>
            </div>
        </section>

        <!-- 模态框用于提示信息 -->
        <div id="modal-backdrop" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 items-center justify-center transition-opacity duration-300">
            <div id="app-modal" class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transition-transform duration-300 transform scale-95">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
                <p id="modal-message" class="text-gray-600 mb-4"></p>
                <button id="modal-close-btn" class="w-full py-2 bg-primary-blue text-white rounded-lg hover:bg-blue-600 transition">确定</button>
            </div>
        </div>
        
        <!-- 广告容器 (网站最下方) -->
        <div class="max-w-4xl mx-auto p-4 sm:p-8 mt-12">
            <div class="ads-container p-4 bg-gray-100 rounded-xl text-center">
                <p class="text-sm text-gray-500 mb-2">广告赞助商内容</p>
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9923429709566940"
                    crossorigin="anonymous"></script>
                <ins class="adsbygoogle"
                    style="display:block; min-height: 100px;"
                    data-ad-format="autorelaxed"
                    data-ad-client="ca-pub-9923429709566940"
                    data-ad-slot="7327876978"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>
    </div>

    <!-- 在广告容器后添加这个页脚 -->
<footer class="max-w-4xl mx-auto p-4 mt-8 border-t border-gray-200">
    <div class="text-center text-sm text-gray-500">
        <div class="flex justify-center space-x-6 mb-4">
            <a href="privacy-policy.html" class="hover:text-primary-blue transition">隐私政策</a>
            <a href="terms-of-service.html" class="hover:text-primary-blue transition">服务条款</a>
            <a href="contact.html" class="hover:text-primary-blue transition">联系我们</a>
        </div>
        <p>&copy; 2025 abyss_123的餐厅评鉴. 保留所有权利.</p>
    </div>
</footer>

    <!-- 模块脚本 2: 主要应用逻辑 -->
    <script type="module">
import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// 获取全局变量
const { initializeApp, signInAnonymously, signInWithCustomToken } = window.firebase;

// --- 评分配置映射 (RATING_CONFIG) ---
const RATING_CONFIG = {
    'Best': { emoji: '😆', color: 'bg-best', text: '最佳' },
    'Good': { emoji: '😁', color: 'bg-good', text: '不错' },
    'Can eat': { emoji: '🙂', color: 'bg-caneat', text: '可以吃' },
    'Bad': { emoji: '😠', color: 'bg-bad', text: '差评' },
    'All': { emoji: '', color: 'bg-primary-blue', text: '全部' }
};

// --- 全局状态 & 常量 ---
let db;
let auth;
let ADMIN_EMAIL = 'jefflai123123@gmail.com'; // 指定管理员邮箱
let isAuthReady = false;
let currentUserEmail = null; // 改为存储邮箱而不是ID
let isLoggedIn = false;
let isAdmin = false;
let activeFilterTag = 'All';
let allReviewsData = [];

const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = {
    apiKey: "AIzaSyCD7f8ZnlXZuI_DiBc_M2c9jl44WajJMhw",
    authDomain: "abyss123-project.firebaseapp.com",
    projectId: "abyss123-project",
    storageBucket: "abyss123-project.firebasestorage.app",
    messagingSenderId: "233505718695",
    appId: "1:233505718695:web:1a62ca261f9ebd9beaf682"
};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;

// 默认标签列表
const DEFAULT_TAGS = {
    'Malaysia': [
        'Johor', 'Kedah', 'Kelantan', 'Malacca', 'Negeri Sembilan', 
        'Pahang', 'Penang', 'Perak', 'Perlis', 'Sabah', 
        'Sarawak', 'Selangor', 'Terengganu', 'Kuala Lumpur', 
        'Labuan', 'Putrajaya'
    ],
    'Singapore': ['Singapore'],
};

// Firestore 集合路径
const getCollectionPath = () => `/artifacts/${appId}/public/data/reviews`;

// --- UI / 模态框函数 ---
const showModal = (title, message) => {
    document.getElementById('modal-title').textContent = title;
    document.getElementById('modal-message').textContent = message;
    document.getElementById('modal-backdrop').classList.remove('hidden');
    document.getElementById('modal-backdrop').classList.add('flex');
    document.getElementById('app-modal').classList.remove('scale-95');
    document.getElementById('app-modal').classList.add('scale-100');
};

document.getElementById('modal-close-btn').addEventListener('click', () => {
    document.getElementById('modal-backdrop').classList.add('hidden');
    document.getElementById('modal-backdrop').classList.remove('flex');
});

// T&C 模态框检查
const checkTermsAndConditions = () => {
    const accepted = sessionStorage.getItem('T&C_Accepted') === 'true';
    const termsModalBackdrop = document.getElementById('terms-and-conditions-modal');
    const acceptBtn = termsModalBackdrop.querySelector('#accept-terms-btn');
    const declineBtn = termsModalBackdrop.querySelector('#decline-terms-btn');

    if (accepted) {
        termsModalBackdrop.classList.add('hidden');
        document.getElementById('loading-indicator').classList.remove('hidden'); 
        initializeFirebase();
    } else {
        termsModalBackdrop.classList.remove('hidden');
        
        // Handle Accept
        acceptBtn.addEventListener('click', () => {
            sessionStorage.setItem('T&C_Accepted', 'true');
            termsModalBackdrop.classList.add('hidden');
            document.getElementById('loading-indicator').classList.remove('hidden');
            initializeFirebase();
        }, { once: true });
        
        // Handle Decline - 跳转到首页
        declineBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        }, { once: true });
    }
};

// --- Firebase 初始化 & 认证 ---
const initializeFirebase = async () => {
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // 检查本地存储中是否有用户邮箱
        const savedEmail = localStorage.getItem('userEmail');
        if (savedEmail) {
            currentUserEmail = savedEmail;
            isLoggedIn = true;
            isAdmin = (savedEmail === ADMIN_EMAIL);
        }

        // 匿名登录以访问Firestore
        await signInAnonymously(auth);

        onAuthStateChanged(auth, (user) => {
            isAuthReady = true;
            updateUIBasedOnAuth();
            startReviewListener();
        });

    } catch (error) {
        console.error("Firebase 初始化或认证失败:", error);
        showModal("初始化错误", "应用初始化失败，请检查控制台或稍后重试。");
    } finally {
        document.getElementById('loading-indicator').classList.add('hidden');
        document.getElementById('app-container').classList.remove('opacity-0', 'hidden');
    }
};

// --- 认证相关函数 ---
const signInWithEmailOnly = async () => {
    const email = prompt('请输入您的电子邮件地址以登录:');
    if (!email) return;
    
    // 简单的邮箱验证
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        showModal('输入错误', '请输入有效的电子邮件地址。');
        return;
    }
    
    // 保存邮箱到本地存储
    localStorage.setItem('userEmail', email);
    currentUserEmail = email;
    isLoggedIn = true;
    isAdmin = (email === ADMIN_EMAIL);
    
    updateUIBasedOnAuth();
    showModal('登录成功', isAdmin ? `管理员 ${email} 已登录` : `欢迎 ${email}`);
};

const handleSignOut = () => {
    localStorage.removeItem('userEmail');
    currentUserEmail = null;
    isLoggedIn = false;
    isAdmin = false;
    
    updateUIBasedOnAuth();
    showModal('登出成功', '您已成功登出。');
};

// 挂载到全局
window.signInWithEmailOnly = signInWithEmailOnly;
window.handleSignOut = handleSignOut;

// --- 更新 UI 基于认证状态 ---
const updateUIBasedOnAuth = () => {
    const authStatusDiv = document.getElementById('auth-status');
    const adminFormContainer = document.getElementById('admin-form-container');

    if (isLoggedIn) {
        authStatusDiv.innerHTML = `
            <div class="flex items-center space-x-2">
                <span class="text-sm font-medium text-gray-600">
                    ${isAdmin ? '👑 管理员: ' : '👋 用户: '} ${currentUserEmail}
                </span>
                <button onclick="handleSignOut()" class="px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded-lg hover:bg-red-600 transition">登出</button>
            </div>`;
        adminFormContainer.classList.toggle('hidden', !isAdmin);
    } else {
        authStatusDiv.innerHTML = `
            <div class="flex items-center space-x-2">
                <button onclick="signInWithEmailOnly()" class="px-3 py-1 bg-primary-blue text-white text-xs font-semibold rounded-lg hover:bg-blue-600 transition">Email 登录</button>
            </div>`;
        adminFormContainer.classList.add('hidden');
    }
};

// --- 标签筛选逻辑 ---
const setActiveFilter = (tag) => {
    activeFilterTag = tag;
    document.getElementById('reviews-header').textContent = `所有评鉴 (${tag === 'All' ? '全部' : tag})`;
    renderReviews(allReviewsData);
    renderFilterNavbar();
}

const renderFilterNavbar = () => {
    const container = document.getElementById('filter-navbar');
    container.innerHTML = '';
    
    // 1. All 按钮
    const allButton = document.createElement('button');
    allButton.textContent = 'All (全部)';
    allButton.className = `tag-btn ${activeFilterTag === 'All' ? 'tag-active bg-gray-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`;
    allButton.addEventListener('click', () => setActiveFilter('All'));
    container.appendChild(allButton);
    
    // 2. 国家/地区按钮
    Object.keys(DEFAULT_TAGS).forEach(country => {
        const states = DEFAULT_TAGS[country];
        
        if (states.length > 1) {
            const countryDiv = document.createElement('div');
            countryDiv.className = 'relative dropdown-hover';
            
            const countryButton = document.createElement('button');
            countryButton.textContent = country;
            const isActiveCountry = activeFilterTag === country || states.includes(activeFilterTag);
            
            countryButton.className = `tag-btn flex items-center ${isActiveCountry ? 'tag-active' : 'bg-primary-blue/10 text-primary-blue hover:bg-primary-blue/20'}`;
            countryButton.addEventListener('click', () => setActiveFilter(country));

            countryButton.innerHTML += `
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            `;
            
            const dropdown = document.createElement('div');
            dropdown.className = 'dropdown-menu absolute z-20 mt-2 w-48 rounded-lg shadow-xl bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100';
            
            states.forEach(state => {
                const stateButton = document.createElement('button');
                stateButton.textContent = state;
                stateButton.className = `w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition ${activeFilterTag === state ? 'bg-primary-blue text-white hover:bg-primary-blue/90' : ''}`;
                stateButton.addEventListener('click', () => setActiveFilter(state));
                dropdown.appendChild(stateButton);
            });

            countryDiv.appendChild(countryButton);
            countryDiv.appendChild(dropdown);
            container.appendChild(countryDiv);
            
        } else {
            const countryButton = document.createElement('button');
            countryButton.textContent = country;
            countryButton.className = `tag-btn ${activeFilterTag === country ? 'tag-active bg-red-500 text-white' : 'bg-red-100 text-red-700 hover:bg-red-200'}`;
            countryButton.addEventListener('click', () => setActiveFilter(country));
            container.appendChild(countryButton);
        }
    });
};

// --- 渲染评鉴列表 ---
const renderReviews = (reviews) => {
    const listContainer = document.getElementById('reviews-list');
    listContainer.innerHTML = '';
    
    // 1. 过滤：只显示管理员发布的评论
    const adminReviews = reviews.filter(review => review.creatorId === ADMIN_EMAIL);
    
    // 2. 标签筛选
    const filteredByTag = adminReviews.filter(review => {
        if (activeFilterTag === 'All') return true;
        
        const reviewTags = Array.isArray(review.tags) ? review.tags.map(t => t.toLowerCase()) : [];
        return reviewTags.includes(activeFilterTag.toLowerCase());
    });
    
    // 3. 处理空状态
    if (filteredByTag.length === 0) {
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('empty-state').querySelector('p').textContent = 
            activeFilterTag === 'All' ? '管理员尚未发布任何评鉴。' : `在 ${activeFilterTag} 区域暂无评鉴。`;
        return;
    }
    document.getElementById('empty-state').classList.add('hidden');

    // 4. 渲染评论
    filteredByTag.forEach(review => {
        const reviewStatus = review.status;
        const config = RATING_CONFIG[reviewStatus] || RATING_CONFIG['Can eat'];
        const statusColor = config.color;
        const statusText = config.text;
        const statusEmoji = config.emoji;
        
        const likeCount = review.likedBy ? review.likedBy.length : 0;
        const isLiked = review.likedBy && review.likedBy.includes(currentUserEmail);
            
        const likeText = likeCount > 0 
            ? `${likeCount} 位用户认为有用`
            : 'Found this useful';
            
        const likeButtonDisabled = !isLoggedIn;
        const likeButtonClass = isLiked 
            ? 'bg-useful text-white hover:bg-indigo-700' 
            : 'bg-gray-100 text-gray-600 hover:bg-gray-200';
        
        const deleteButtonHtml = isAdmin ? `
            <button class="delete-btn px-3 py-1 text-sm bg-admin-red text-white rounded-lg hover:bg-red-700 transition" data-id="${review.id}">
                删除
            </button>
        ` : '';
        
        const tagHtml = (review.tags && review.tags.length > 0) 
            ? review.tags.map(tag => `<span class="inline-block bg-primary-blue/10 text-primary-blue text-xs font-medium mr-1 px-2.5 py-0.5 rounded-full">${tag}</span>`).join('')
            : '';

        const reviewElement = document.createElement('div');
        reviewElement.className = 'bg-white p-6 rounded-xl shadow-lg border-l-4 ' + statusColor.replace('bg-', 'border-');
        reviewElement.innerHTML = `
            <div class="flex justify-between items-start mb-4">
                <div>
                    <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full text-white ${statusColor}">
                        ${statusEmoji} ${statusText}
                    </span>
                    <h3 class="text-2xl font-extrabold text-gray-900 mt-2">${review.restaurantName}</h3>
                    <p class="text-gray-500 text-sm mt-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block mr-1 text-primary-blue" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                        </svg>
                        ${review.address || '地址未提供'}
                    </p>
                </div>
                ${deleteButtonHtml}
            </div>

            ${review.imageUrl ? `
                <img src="${review.imageUrl}" alt="${review.restaurantName} 图片" class="w-full h-48 object-cover rounded-lg mb-4 shadow-inner" onerror="this.onerror=null;this.src='https://placehold.co/600x200/cccccc/333333?text=图片加载失败';">
            ` : ''}

            <p class="text-gray-700 mb-4">${review.comment}</p>
            
            <!-- 标签显示 -->
            <div class="mb-4">${tagHtml}</div>

            <div class="flex justify-between items-center pt-4 border-t border-gray-100">
                <button id="like-btn-${review.id}" data-liked="${isLiked}" 
                    class="px-4 py-2 text-sm font-semibold rounded-full transition duration-150 flex items-center space-x-2 ${likeButtonClass} ${likeButtonDisabled ? 'opacity-50 cursor-not-allowed' : ''}"
                    title="${likeButtonDisabled ? '请登录以使用此功能' : 'Found this useful'}"
                    ${likeButtonDisabled ? 'disabled' : ''}
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${isLiked ? 'text-white' : 'text-useful'}" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.433a2.5 2.5 0 00.953 1.956 2.5 2.5 0 001.996.183 2.5 2.5 0 002.825-1.042l3.4-6a2.5 2.5 0 00.94-1.879V5.75a1.75 1.75 0 10-3.5 0v2.75l-3.4 6c-.15.263-.448.425-.774.425-.333 0-.638-.17-.788-.445l-.462-.871c-.08-.15-.17-.306-.27-.47L6 10.333z" />
                    </svg>
                    <span class="hidden sm:inline-block">${likeText}</span>
                    <span class="sm:hidden">${likeText}</span>
                    <span class="ml-1 px-2 py-0.5 text-xs rounded-full ${isLiked ? 'bg-indigo-500' : 'bg-useful text-white'}">${likeCount}</span>
                </button>
            </div>
        `;
        listContainer.appendChild(reviewElement);
    });

    // 重新绑定事件监听器
    filteredByTag.forEach(review => {
        if (isAdmin) {
            const deleteButton = document.querySelector(`.delete-btn[data-id="${review.id}"]`);
            if (deleteButton) {
                deleteButton.addEventListener('click', () => handleDelete(review.id, review.restaurantName));
            }
        }
        
        const likeButton = document.getElementById(`like-btn-${review.id}`);
        if (likeButton && isLoggedIn) { 
            likeButton.addEventListener('click', (e) => {
                const isLiked = e.currentTarget.getAttribute('data-liked') === 'true';
                handleLike(review.id, isLiked);
            });
        }
    });
};

// 监听 Firestore 变化
const startReviewListener = () => {
     const reviewsColRef = collection(db, getCollectionPath());

    onSnapshot(reviewsColRef, (snapshot) => {
        const reviews = [];
        snapshot.forEach(doc => {
            reviews.push({ id: doc.id, ...doc.data() });
        });
        // 排序：最新的在最前面
        reviews.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0)); 
        
        allReviewsData = reviews;
        renderReviews(allReviewsData);
        renderFilterNavbar();
    }, (error) => {
        console.error("监听评论失败:", error);
        showModal("数据错误", "无法实时获取评论数据。");
    });
}

// 处理表单提交 (仅管理员)
const handleFormSubmit = async (e) => {
    e.preventDefault();

    if (!isAdmin) {
        showModal("权限不足", "只有管理员才能添加新的餐厅评鉴。");
        return;
    }

    const restaurantName = document.getElementById('restaurantName').value.trim();
    const address = document.getElementById('address').value.trim();
    const imageUrl = document.getElementById('imageUrl').value.trim();
    const status = document.getElementById('status').value;
    const comment = document.getElementById('comment').value.trim();
    const tagsInput = document.getElementById('tags').value.trim();

    if (!restaurantName || !status || !comment || !address) {
        showModal("输入错误", "请填写餐厅名称、地址、状态和评论。");
        return;
    }
    
    const tagsArray = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);

    try {
        const reviewsColRef = collection(db, getCollectionPath());
        await addDoc(reviewsColRef, {
            restaurantName,
            address,
            imageUrl,
            status,
            comment,
            tags: tagsArray, 
            creatorId: ADMIN_EMAIL, // 使用邮箱作为创建者ID
            likedBy: [], 
            timestamp: Date.now()
        });

        showModal("提交成功", `餐厅评鉴 "${restaurantName}" 已添加。`);
        e.target.reset();
    } catch (error) {
        console.error("添加评鉴失败:", error);
        showModal("提交失败", `无法添加评鉴: ${error.message}`);
    }
};

// 处理点赞/取消点赞 (仅登录用户)
const handleLike = async (reviewId, isLiked) => {
    if (!isLoggedIn) {
        showModal("权限不足", "请先登录才能使用 'Found this useful' 功能。");
        return;
    }

    try {
        const reviewRef = doc(db, getCollectionPath(), reviewId);
        
        const updateField = isLiked ? arrayRemove(currentUserEmail) : arrayUnion(currentUserEmail);
        
        await updateDoc(reviewRef, {
            likedBy: updateField
        });
    } catch (error) {
        console.error("更新点赞状态失败:", error);
        showModal("操作失败", "无法更新 'Found this useful' 状态。");
    }
};

// 处理删除 (仅管理员)
const handleDelete = async (reviewId, restaurantName) => {
     if (!isAdmin) {
        showModal("权限不足", "只有管理员才能删除餐厅评鉴。");
        return;
    }
    
    showModal("确认删除", `您确定要删除餐厅 "${restaurantName}" 的评鉴吗？`);
    
    const originalModalCloseBtn = document.getElementById('modal-close-btn');
    const originalClick = originalModalCloseBtn.onclick;

    const tempCloseListener = () => {
        document.getElementById('modal-backdrop').classList.add('hidden');
        document.getElementById('modal-backdrop').classList.remove('flex');
    };
    originalModalCloseBtn.onclick = tempCloseListener; 

    const confirmDelete = async () => {
        try {
            await deleteDoc(doc(db, getCollectionPath(), reviewId));
            
            originalModalCloseBtn.removeEventListener('click', confirmDelete);
            originalModalCloseBtn.onclick = originalClick; 
            showModal("删除成功", `评鉴 "${restaurantName}" 已被删除。`);
        } catch (error) {
            originalModalCloseBtn.removeEventListener('click', confirmDelete);
            originalModalCloseBtn.onclick = originalClick;
            console.error("删除失败:", error);
            showModal("删除失败", `无法删除评鉴: ${error.message}`);
        }
    };

    originalModalCloseBtn.removeEventListener('click', tempCloseListener);
    originalModalCloseBtn.addEventListener('click', confirmDelete, { once: true });
};

// 绑定事件和初始化
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('add-review-form');
    if (form) {
        form.addEventListener('submit', handleFormSubmit);
    }
    
    // 管理员关闭表单按钮
    document.getElementById('closeAdminForm').addEventListener('click', () => {
        const adminFormContainer = document.getElementById('admin-form-container');
        adminFormContainer.classList.add('hidden');
        adminFormContainer.dataset.visibility = 'hidden'; 
    });
});

// 应用程序入口点：首先检查 T&C
window.onload = checkTermsAndConditions;
</script>
</body>
</html>


