<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>abyss_123的AI奇幻冒险</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- AdSense 头部脚本 -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9923429709566940" crossorigin="anonymous"></script>

    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4c51bf', // 模仿原有的蓝色调
                        'ai-sparkle': '#f97316',   // 橙色系作为AI核心颜色 (Orange-600)
                        'useful': '#4f46e5',       // 紫色系用于保存/加载 (Indigo-600)
                        'admin-red': '#dc2626',    // 红色系用于危险操作 (Red-600)
                        'random-green': '#10b981', // 随机生成按钮颜色 (Emerald-500)
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* 确保 Inter 字体在所有设备上都能良好显示 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }

        /* 故事输出框的平滑滚动效果 */
        #story-output {
            transition: all 0.5s ease-out;
        }
        
        /* 隐藏滚动条但允许滚动 */
        .scrollbar-hidden::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hidden {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* 按钮的统一过渡效果 */
        .btn-base {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        .btn-base:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        .btn-base:active {
            transform: translateY(1px);
            box-shadow: none;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50 flex flex-col items-center">
    
    <!-- 新增：网站入口接受条款模态框 -->
    <div id="acceptance-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-[100]" aria-modal="true" role="dialog">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 m-4 transform transition-all duration-500">
            <h2 class="text-2xl font-bold mb-4 text-gray-900 border-b pb-2">欢迎来到 AI 奇幻冒险模拟器</h2>
            <p class="mb-4 text-gray-700">
                本应用通过 AI 模型实时生成故事内容。在使用前，请您知悉并同意以下条款：
            </p>
            <ul class="list-disc list-inside space-y-2 mb-6 text-sm text-gray-600">
                <li>**AI 内容生成：** 所有故事内容由 AI 实时创作，本站不对其准确性、完整性或适宜性作任何保证。</li>
                <li>**数据使用：** 您的故事进程将用于持续的 AI 交互。**所有故事通过TXT文件本地保存和加载。**</li>
                <li>**服务条款 & 隐私：** 请仔细阅读我们的服务条款和隐私政策。</li>
            </ul>
            <div class="flex justify-end space-x-4">
                <button id="modal-reject" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg transition duration-150">
                    不接受并退出
                </button>
                <button id="modal-accept" class="px-6 py-2 bg-ai-sparkle hover:bg-orange-700 text-white font-semibold rounded-lg transition duration-150">
                    接受并开始冒险
                </button>
            </div>
        </div>
    </div>

    <!-- 主内容容器，限制最大宽度并居中 -->
    <div id="app-container" class="w-full max-w-4xl px-4 py-8 opacity-0 pointer-events-none transition-opacity duration-300">

        <!-- 标题区域 -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">
                AI 奇幻冒险
            </h1>
            <p class="text-xl font-medium text-ai-sparkle">
                您的决定，将创造独一无二的故事
            </p>
        </header>

        <!-- Status Bar -->
       <div class="mb-4 p-3 bg-indigo-100 rounded-xl shadow-inner text-sm text-indigo-800 text-center">
            <span>使用 TXT 文件存储进度</span>
       </div>

        <!-- 故事和输入区域 -->
        <main class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8">
            
            <!-- 故事输出区 -->
            <div class="h-96 sm:h-[500px] bg-gray-100 p-4 sm:p-6 mb-6 rounded-xl border border-gray-200 overflow-y-auto scrollbar-hidden">
                <div id="story-output" class="text-gray-700 whitespace-pre-wrap leading-relaxed">
                    <!-- 初始加载文本 -->
                    <p class="text-center text-gray-500 italic">
                        欢迎来到 AI 奇幻冒险！请在下方输入您的初始设定，然后点击"开始冒险"按钮。
                    </p>
                </div>
            </div>

            <!-- 状态和选项区 (新增世界观/开头/随机生成) -->
            <div class="space-y-4 mb-6 p-4 border border-gray-200 rounded-xl bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">初始设定 (首次冒险必填)</h3>
                
                <!-- 设定输入区域 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="world-input" placeholder="世界观/背景 (例如：蒸汽朋克王国)"
                           class="md:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                    <input type="text" id="character-input" placeholder="您的角色名/描述 (例如：精灵法师 Aerys)"
                           class="md:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                    <input type="text" id="opening-input" placeholder="初始场景/开头 (例如：我在一座废弃的图书馆中醒来)"
                           class="md:col-span-1 p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                </div>

                <!-- 故事风格选择 & 随机生成按钮 -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <select id="genre-select" 
                            class="md:col-span-2 p-3 border border-gray-300 rounded-lg bg-white focus:ring-primary-blue focus:border-primary-blue transition duration-150">
                        <option value="奇幻史诗">奇幻史诗 (Epic Fantasy)</option>
                        <option value="赛博朋克">赛博朋克 (Cyberpunk)</option>
                        <option value="武侠江湖">武侠江湖 (Wuxia)</option>
                        <option value="末日生存">末日生存 (Apocalyptic Survival)</option>
                        <option value="校园日常">校园日常 (School Life)</option>
                    </select>

                    <button id="randomize-button" class="btn-base bg-random-green hover:bg-emerald-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg flex items-center justify-center disabled:opacity-50">
                        <span id="random-text">随机生成</span>
                        <span id="loading-spinner-random" class="hidden animate-spin ml-2 w-5 h-5 border-2 border-white border-t-transparent rounded-full"></span>
                    </button>
                </div>

            </div>


            <!-- 动作输入和主要按钮 -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <!-- 动作输入 -->
                <textarea id="action-input" rows="2" placeholder="输入您的下一步行动（例如：我决定向西边森林深处走去）"
                          class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-ai-sparkle focus:border-ai-sparkle transition duration-150 resize-none"></textarea>

                <!-- 主要按钮：开始/继续/生成 -->
                <button id="generate-button" class="btn-base w-full sm:w-1/3 bg-ai-sparkle hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg flex items-center justify-center disabled:opacity-50">
                    <span id="button-text">开始冒险</span>
                    <span id="loading-spinner-button" class="hidden animate-spin ml-2 w-5 h-5 border-2 border-white border-t-transparent rounded-full"></span>
                </button>
            </div>

                      <!-- 管理按钮 -->
           <div class="grid grid-cols-2 sm:grid-cols-2 gap-4">
                <button id="export-txt-button" class="btn-base bg-random-green hover:bg-emerald-700 text-white font-semibold py-2 px-4 rounded-lg">
       导出故事
   </button>
   <button id="import-txt-button" class="btn-base bg-ai-sparkle hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg">
       导入故事
   </button>
               
               <button id="new-game-button" class="btn-base bg-admin-red hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">
                   <span id="new-game-text">开始新游戏</span>
               </button>
               <button id="clear-history-button" class="btn-base bg-gray-500 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg disabled:opacity-50">
                   清空对话
               </button>
           </div>
            <!-- 隐藏的档案输入元素 -->
<input type="file" id="txt-file-input" accept=".txt" class="hidden">
        </main>

        <!-- 消息模态框 (用于替代 alert/confirm) -->
        <div id="message-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300" aria-modal="true" role="dialog">
            <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 m-4 transform transition-transform duration-300 scale-95">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
                <p id="modal-body" class="mb-6 text-gray-600"></p>
                <div class="flex justify-end space-x-3">
                    <button id="modal-cancel" class="hidden px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg transition duration-150">取消</button>
                    <button id="modal-confirm" class="px-4 py-2 bg-primary-blue hover:bg-indigo-600 text-white font-semibold rounded-lg transition duration-150">确定</button>
                </div>
            </div>
        </div>

        <!-- 广告容器 (网站最下方) -->
        <div class="max-w-4xl mx-auto p-4 sm:p-8 mt-12">
            <div class="ads-container p-4 bg-gray-100 rounded-xl text-center">
                <p class="text-sm text-gray-500 mb-2">广告赞助商内容</p>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
                <ins class="adsbygoogle"
                    style="display:block; min-height: 100px;"
                    data-ad-format="autorelaxed"
                    data-ad-client="ca-pub-9923429709566940"
                    data-ad-slot="7327876978"></ins>
            </div>
        </div>
    </div>

    <!-- 修复：在广告容器后添加完整的页脚内容 -->
    <footer class="max-w-4xl mx-auto p-4 mt-8 border-t border-gray-200">
    <div class="text-center text-sm text-gray-500">
        <div class="flex justify-center space-x-6 mb-4">
            <a href="privacy-policy.html" class="hover:text-primary-blue transition">隐私政策</a>
            <a href="terms-of-service.html" class="hover:text-primary-blue transition">服务条款</a>
            <a href="contact.html" class="hover:text-primary-blue transition">联系我们</a>
        </div>
        <p>&copy; 2025 abyss_123. 保留所有权利.</p>
    </div>
</footer>


    <script type="module">
        
        // 定义全局的 API Key
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        // 修改这一行：
        const apiKey = '%%VERCEL_GEMINI_API_KEY_PLACEHOLDER%%'; // 这是一个将在构建时被替换的占位符
        // 假设 Vercel 会注入名为 VERCEL_GEMINI_API_KEY 的变量。
        // 在您的 Vercel 环境中，请确保添加名为 GEMINI_API_KEY 的环境变量。

        // 状态管理
        let storyHistory = [];
        let isGenerating = false;
        let isRandomizing = false; // 新增：用于随机生成状态
        let isGameStarted = false;

        // UI 元素
        const appContainer = document.getElementById('app-container');
        const acceptanceModal = document.getElementById('acceptance-modal');
        const modalAccept = document.getElementById('modal-accept');
        const modalReject = document.getElementById('modal-reject');

        const storyOutput = document.getElementById('story-output');
        const actionInput = document.getElementById('action-input');
        
        // 新增的输入元素
        const worldInput = document.getElementById('world-input'); 
        const openingInput = document.getElementById('opening-input'); 

        const characterInput = document.getElementById('character-input');
        const genreSelect = document.getElementById('genre-select');
        
        const generateButton = document.getElementById('generate-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinnerButton = document.getElementById('loading-spinner-button');
        
        const randomizeButton = document.getElementById('randomize-button'); // 新增随机生成按钮
        const randomText = document.getElementById('random-text');
        const loadingSpinnerRandom = document.getElementById('loading-spinner-random');

        const newGameButton = document.getElementById('new-game-button');
        const clearHistoryButton = document.getElementById('clear-history-button');

        // 在现有的事件监听器部分添加
        document.getElementById('export-txt-button').addEventListener('click', exportStoryToTxt);
        document.getElementById('import-txt-button').addEventListener('click', importStoryFromTxt);
        
        // --- 通用辅助函数 ---

        /**
         * 显示故事内容并自动滚动到底部。
         */
        function displayStory() {
            storyOutput.innerHTML = storyHistory.map(item => {
                if (item.role === 'user') {
                    // 用户行动以醒目的块引用样式显示
                    return `<div class="mb-4">
                                <p class="text-sm font-semibold text-primary-blue bg-indigo-50 p-2 rounded-t-lg border-l-4 border-primary-blue">
                                    > 您的行动
                                </p>
                                <p class="bg-indigo-50 p-2 rounded-b-lg italic text-indigo-800">${item.text}</p>
                            </div>`;
                } else if (item.role === 'model') {
                    // AI 回复以卡片样式显示
                    return `<div class="mb-4 bg-white p-4 rounded-xl shadow-md border border-ai-sparkle/30">
                                <p class="text-xs font-bold text-ai-sparkle mb-1">AI 故事叙述者</p>
                                <p>${item.text.replace(/\n/g, '<br>')}</p>
                            </div>`;
                }
                return '';
            }).join('');

            storyOutput.parentElement.scrollTop = storyOutput.parentElement.scrollHeight;
        }

        /**
         * 更新 UI 状态（按钮文本、禁用状态）。
         */
        function updateUIState() {
            const canInteract = !isGenerating && !isRandomizing;
            
            generateButton.disabled = !canInteract;
            randomizeButton.disabled = !canInteract || isGameStarted; // 游戏开始后禁用随机生成
            clearHistoryButton.disabled = !canInteract || !isGameStarted;

            if (isGenerating) {
                buttonText.textContent = '生成中...';
                loadingSpinnerButton.classList.remove('hidden');
                generateButton.classList.add('animate-pulse');
            } else if (isRandomizing) {
                randomText.textContent = '生成中...';
                loadingSpinnerRandom.classList.remove('hidden');
                randomizeButton.classList.add('animate-pulse');
            } else if (!isGameStarted) {
                buttonText.textContent = '开始冒险';
                loadingSpinnerButton.classList.add('hidden');
                generateButton.classList.remove('animate-pulse');
                randomText.textContent = '随机生成';
                loadingSpinnerRandom.classList.add('hidden');
                randomizeButton.classList.remove('animate-pulse');

                // 首次游戏，可以编辑设定
                characterInput.disabled = false;
                worldInput.disabled = false;
                openingInput.disabled = false;
                genreSelect.disabled = false;
            } else {
                buttonText.textContent = '继续故事';
                loadingSpinnerButton.classList.add('hidden');
                generateButton.classList.remove('animate-pulse');
                randomText.textContent = '随机生成';
                loadingSpinnerRandom.classList.add('hidden');
                randomizeButton.classList.remove('animate-pulse');

                // 游戏开始后，禁用设定编辑
                characterInput.disabled = true;
                worldInput.disabled = true;
                openingInput.disabled = true;
                genreSelect.disabled = true;
            }
        }

        /**
         * 显示自定义模态框
         * @param {string} title 标题
         * @param {string} body 内容
         * @param {boolean} isConfirm 是否为确认对话框
         * @returns {Promise<boolean>} 如果是确认对话框，返回 Promise
         */
        function showModal(title, body, isConfirm = false) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            if (isConfirm) {
                cancelBtn.classList.remove('hidden');
                modal.classList.remove('hidden');
                return new Promise((resolve) => {
                    confirmBtn.onclick = () => {
                        modal.classList.add('hidden');
                        cancelBtn.classList.add('hidden');
                        resolve(true);
                    };
                    cancelBtn.onclick = () => {
                        modal.classList.add('hidden');
                        cancelBtn.classList.add('hidden');
                        resolve(false);
                    };
                });
            } else {
                cancelBtn.classList.add('hidden');
                modal.classList.remove('hidden');
                confirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                };
                return Promise.resolve(true); // 非确认模式立即解决
            }
        }

        /**
         * 阻塞式显示入口条款模态框。
         */
        function showAcceptanceModal() {
            modalAccept.onclick = () => {
                acceptanceModal.classList.add('hidden');
                appContainer.classList.remove('opacity-0', 'pointer-events-none');
                updateUIState();
            };

            // --- 关键修改：不接受则跳转到 index.html ---
            modalReject.onclick = () => {
                window.location.href = 'index.html'; 
            };
            // ---------------------------------------------
        }

        // TXT 导出功能
        function exportStoryToTxt() {
            if (storyHistory.length === 0) {
                showModal('导出失败', '没有故事内容可以导出。');
                return;
            }

            try {
                // 构建 TXT 内容
                let txtContent = `AI 奇幻冒险故事存档\n`;
                txtContent += `生成时间: ${new Date().toLocaleString('zh-TW')}\n`;
                txtContent += `故事类型: ${genreSelect.value}\n`;
                txtContent += `角色设定: ${characterInput.value}\n`;
                txtContent += `世界观: ${worldInput.value}\n`;
                txtContent += `开场设定: ${openingInput.value}\n`;
                txtContent += `${"=".repeat(50)}\n\n`;

                // 添加故事内容
                storyHistory.forEach((item, index) => {
                    if (item.role === 'user') {
                        txtContent += `[第 ${index + 1} 回合 - 您的行动]\n`;
                        txtContent += `> ${item.text}\n\n`;
                    } else if (item.role === 'model') {
                        txtContent += `[第 ${index + 1} 回合 - AI 叙述]\n`;
                        txtContent += `${item.text}\n\n`;
                        txtContent += `${"=".repeat(50)}\n\n`;
                    }
                });

                // 添加元数据（用于重新导入）
                const metadata = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    character: characterInput.value,
                    world: worldInput.value,
                    opening: openingInput.value,
                    genre: genreSelect.value,
                    history: storyHistory
                };

                txtContent += `\n\n<!-- METADATA: ${JSON.stringify(metadata)} -->`;

                // 创建下载
                const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                const fileName = `story_${new Date().toISOString().slice(0, 10)}_${characterInput.value || 'adventure'}.txt`;
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showModal('导出成功', `故事已导出为 ${fileName}，您可以保存这个档案以便将来继续。`);

            } catch (error) {
                console.error('导出失败:', error);
                showModal('导出失败', `导出过程中发生错误: ${error.message}`);
            }
        }

        // TXT 导入功能
        function importStoryFromTxt() {
            const fileInput = document.getElementById('txt-file-input');
            fileInput.click();
        }

        // 处理档案选择
        document.getElementById('txt-file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    processImportedTxt(content, file.name);
                } catch (error) {
                    console.error('档案读取失败:', error);
                    showModal('导入失败', '无法读取档案内容。');
                }
            };
            
            reader.onerror = function() {
                showModal('导入失败', '读取档案时发生错误。');
            };
            
            reader.readAsText(file);
        });

        // 处理导入的 TXT 内容
        function processImportedTxt(content, fileName) {
            try {
                // 尝试从元数据恢复
                const metadataMatch = content.match(/<!-- METADATA: ({.*?}) -->/);
                
                if (metadataMatch) {
                    // 有元数据的完整导入
                    const metadata = JSON.parse(metadataMatch[1]);
                    return restoreFromMetadata(metadata, fileName);
                } else {
                    // 纯文本文件的智能导入
                    return restoreFromPlainText(content, fileName);
                }
                
            } catch (error) {
                console.error('处理导入档案失败:', error);
                showModal('导入失败', `档案格式不正确: ${error.message}`);
            }
        }

        // 从元数据恢复
        function restoreFromMetadata(metadata, fileName) {
            // 检查版本兼容性
            if (!metadata.version || !metadata.history) {
                throw new Error('档案格式不完整，缺少必要的元数据。');
            }

            // 确认用户是否要覆盖当前进度
            showModal('确认导入', 
                `即将导入故事 "${fileName}"。这将覆盖您当前的游戏进度，确定要继续吗？`,
                true
            ).then(confirmed => {
                if (confirmed) {
                    // 恢复所有状态
                    storyHistory = metadata.history || [];
                    characterInput.value = metadata.character || '';
                    worldInput.value = metadata.world || '';
                    openingInput.value = metadata.opening || '';
                    genreSelect.value = metadata.genre || '奇幻史诗';
                    
                    // 更新 UI
                    isGameStarted = storyHistory.length > 0;
                    displayStory();
                    updateUIState();
                    
                    showModal('导入成功', 
                        `故事 "${fileName}" 已成功导入！您可以继续这个冒险。\n\n` +
                        `进度: ${storyHistory.length} 回合对话\n` +
                        `角色: ${characterInput.value || '未设定'}`);
                }
            });
        }

        // 从纯文本恢复（兼容旧格式）
        function restoreFromPlainText(content, fileName) {
            // 解析纯文本格式
            const lines = content.split('\n');
            const restoredHistory = [];
            let currentRole = null;
            let currentText = [];
            
            lines.forEach(line => {
                line = line.trim();
                
                if (line.startsWith('[第') && line.includes('回合 - 您的行动]')) {
                    // 保存上一个对话
                    if (currentRole && currentText.length > 0) {
                        restoredHistory.push({
                            role: currentRole,
                            text: currentText.join('\n').trim()
                        });
                    }
                    // 开始新的用户对话
                    currentRole = 'user';
                    currentText = [];
                } 
                else if (line.startsWith('[第') && line.includes('回合 - AI 叙述]')) {
                    // 保存上一个对话
                    if (currentRole && currentText.length > 0) {
                        restoredHistory.push({
                            role: currentRole,
                            text: currentText.join('\n').trim()
                        });
                    }
                    // 开始新的 AI 对话
                    currentRole = 'model';
                    currentText = [];
                }
                else if (line.startsWith('>') && currentRole === 'user') {
                    // 用户行动内容
                    currentText.push(line.substring(1).trim());
                }
                else if (line.length > 0 && !line.includes('='.repeat(50)) && 
                         !line.startsWith('AI 奇幻冒险故事存档') &&
                         !line.startsWith('生成时间:') &&
                         !line.startsWith('故事类型:') &&
                         !line.startsWith('角色设定:') &&
                         !line.startsWith('世界观:') &&
                         !line.startsWith('开场设定:')) {
                    // AI 叙述内容
                    if (currentRole) {
                        currentText.push(line);
                    }
                }
            });
            
            // 保存最后一个对话
            if (currentRole && currentText.length > 0) {
                restoredHistory.push({
                    role: currentRole,
                    text: currentText.join('\n').trim()
                });
            }
            
            if (restoredHistory.length === 0) {
                throw new Error('无法从档案中解析出有效的故事内容。');
            }
            
            // 确认导入
            showModal('确认导入', 
                `找到 ${restoredHistory.length} 回合对话。这将覆盖您当前的游戏进度，确定要继续吗？`,
                true
            ).then(confirmed => {
                if (confirmed) {
                    storyHistory = restoredHistory;
                    isGameStarted = storyHistory.length > 0;
                    
                    // 尝试从档案名提取角色名
                    const charMatch = fileName.match(/story_.*_(.*)\.txt/);
                    if (charMatch && charMatch[1] !== 'adventure') {
                        characterInput.value = charMatch[1];
                    }
                    
                    displayStory();
                    updateUIState();
                    
                    showModal('导入成功', 
                        `故事已从 "${fileName}" 导入！\n\n` +
                        `已恢复 ${restoredHistory.length} 回合对话。\n` +
                        `请检查角色设定是否正确，然后继续您的冒险。`);
                }
            });
        }

        // --- LLM 交互逻辑 ---
        
        /**
         * 使用指数退避重试机制进行 API 调用。
         */
        async function fetchWithRetry(url, payload, retries = 3) {
            // 构建最终的带API Key的URL
            const finalUrl = `${url}?key=${apiKey}`; // <-- 这里添加了API Key
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(finalUrl, { // <-- 使用 finalUrl
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API error ${response.status}: ${JSON.stringify(errorBody)}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error(`API 调用失败 (尝试 ${i + 1}/${retries}):`, error);
                    if (i === retries - 1) throw error; // 最后一次失败，抛出错误

                    // 指数退避 (1s, 2s, 4s...)
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * 构建系统指令。
         */
        function buildSystemInstruction() {
            const character = characterInput.value.trim() || '一位没有名字的旅行者';
            const world = worldInput.value.trim() || '一个普通的奇幻世界';
            const genre = genreSelect.value;
            
            return `
                你是一位沉浸式的、富有创造力的 RPG 故事叙述者。
                你的职责是根据用户的行动（user part）来推进奇幻故事的发展。
                
                **指令要点：**
                1. **故事风格：** 必须严格遵循用户选择的 [${genre}] 风格。
                2. **世界观/背景：** 故事发生的世界是："${world}"。
                3. **角色：** 故事的主角是："${character}"。
                4. **内容生成：**
                    - 每次回复必须在 150 到 250 字之间。
                    - 描述环境变化、NPC 反应和行动结果。
                    - 保持悬念，并以开放式的问题或挑战结束回复，激励用户采取下一步行动。
                                        -必须严格按照用户的要求以及指令生成，如果用户要求与其他规则相冲，本规则优先。
                5. **历史：** 使用提供的 storyHistory 来理解上下文。
                6. **输出格式：** 仅输出故事文本，不要包含任何额外的对话、提示词或格式。
            `.trim();
        }

        /**
         * 新增功能：随机生成缺失的设定。
         */
        async function randomizeInputs() {
            if (isGenerating || isRandomizing || isGameStarted) return;

            const fieldsToGenerate = [];
            if (!worldInput.value.trim()) fieldsToGenerate.push('World Setting (世界观/背景)');
            if (!characterInput.value.trim()) fieldsToGenerate.push('Character Description (角色名/描述)');
            if (!openingInput.value.trim()) fieldsToGenerate.push('Initial Scene (初始场景/开头)');
            
            if (fieldsToGenerate.length === 0) {
                showModal('提示', '所有设定字段均已填写，无需随机生成。');
                return;
            }

            isRandomizing = true;
            updateUIState();
            
            try {
                const prompt = `请为以下空白字段随机生成一个引人入胜的设定，并确保它们与用户选择的【${genreSelect.value}】风格相符。请用 JSON 格式返回结果，仅包含需要生成的部分。需要生成的字段：${fieldsToGenerate.join(', ')}。`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "world": { "type": "STRING", "description": "随机生成的世界观或背景。" },
                                "character": { "type": "STRING", "description": "随机生成的角色名和简短描述。" },
                                "opening": { "type": "STRING", "description": "随机生成的初始场景描述。" }
                            }
                        }
                    }
                };

                const result = await fetchWithRetry(API_URL, payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (jsonText) {
                    const randomData = JSON.parse(jsonText);
                    
                    if (randomData.world && !worldInput.value.trim()) {
                        worldInput.value = randomData.world;
                    }
                    if (randomData.character && !characterInput.value.trim()) {
                        characterInput.value = randomData.character;
                    }
                    if (randomData.opening && !openingInput.value.trim()) {
                        openingInput.value = randomData.opening;
                    }
                    showModal('随机生成成功', '缺失的设定已自动填充。');
                } else {
                    throw new Error("AI未能返回有效的JSON数据。");
                }

            } catch (error) {
                console.error("随机生成失败:", error);
                showModal('随机生成失败', `AI 无法生成随机设定: ${error.message}`);
            } finally {
                isRandomizing = false;
                updateUIState();
            }
        }
        
        /**
         * AI 故事生成函数。
         */
        async function generateStory() {
            if (isGenerating) return;

            const action = actionInput.value.trim();
            const character = characterInput.value.trim();
            const world = worldInput.value.trim();
            const opening = openingInput.value.trim();
            
            // 首次开始游戏检查：确保所有设定字段已填写
            if (!isGameStarted) {
                if (!character || !world || !opening || !action) {
                    showModal('信息缺失', '首次开始游戏，请填写【世界观】、【角色】、【初始场景】以及您的【第一个行动】！您可以使用"随机生成"按钮。');
                    return;
                }
                isGameStarted = true;
                storyHistory = [];
                // 首次行动作为故事的引子
                storyHistory.push({ role: 'user', text: `故事设定：世界观是 "${world}"，我的角色是 "${character}"。故事从这里开始："${opening}"。我的第一个行动是："${action}"。请根据所有设定写出故事的开头。` });
            } else {
                if (!action) {
                    showModal('请行动', '请描述您的下一步行动，以继续故事。');
                    return;
                }
                // 后续行动，只记录用户行动
                storyHistory.push({ role: 'user', text: action });
            }

            // 清空输入框并显示当前故事状态
            actionInput.value = '';
            displayStory();
            updateUIState();
            
            isGenerating = true;
            updateUIState();
            
            // 暂时在故事输出区底部添加一个提示
            const tempLoadingElement = document.createElement('div');
            tempLoadingElement.id = 'temp-loading';
            tempLoadingElement.className = 'mt-4 text-center text-gray-500 italic flex items-center justify-center';
            tempLoadingElement.innerHTML = '<span class="animate-spin inline-block w-4 h-4 mr-2 border-2 border-gray-500 border-t-transparent rounded-full"></span> AI 正在思考...';
            storyOutput.appendChild(tempLoadingElement);
            storyOutput.parentElement.scrollTop = storyOutput.parentElement.scrollHeight;

            try {
                const systemInstruction = buildSystemInstruction();
                
                // 过滤掉角色/风格信息，只留下对话历史给 API
                const contents = storyHistory.map(h => ({
                    role: h.role,
                    parts: [{ text: h.text }]
                }));

                const payload = {
                    contents: contents,
                    systemInstruction: { parts: [{ text: systemInstruction }] },
                };

                const result = await fetchWithRetry(API_URL, payload);
                const modelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (modelResponse) {
                    storyHistory.push({ role: 'model', text: modelResponse });
                    displayStory();
                } else {
                    throw new Error("API 返回的数据格式错误或内容为空。");
                }

            } catch (error) {
                console.error("生成故事失败:", error);
                // 详细的错误处理
                const errorMessage = `
                    [系统错误] 故事生成失败。请检查网络连接或尝试新的行动。
                    错误详情: ${error.message}
                `;
                
                // 只记录错误信息，不影响历史记录
                storyHistory.push({ role: 'model', text: errorMessage }); 
                displayStory();
                
                showModal('故事生成失败', 'AI 无法回复。请查看控制台了解详细错误或稍后再试。');

            } finally {
                // 移除临时加载提示
                const loading = document.getElementById('temp-loading');
                if (loading) loading.remove();
                
                isGenerating = false;
                updateUIState();
            }
        }
        
        /**
         * 初始化新游戏。
         */
        async function startNewGame() {
            const confirm = await showModal(
                '确认新游戏',
                '您确定要开始新游戏吗？当前未保存的进度将会丢失。',
                true
            );
            
            if (confirm) {
                // 清理本地状态
                storyHistory = [];
                isGameStarted = false;
                
                // 清理 UI
                storyOutput.innerHTML = `<p class="text-center text-gray-500 italic">欢迎来到 AI 奇幻冒险！请在下方输入您的初始设定，然后点击"开始冒险"按钮。</p>`;
                worldInput.value = '';
                characterInput.value = '';
                openingInput.value = '';
                actionInput.value = '';
                
                updateUIState();
                showModal('新游戏开始', '新游戏已就绪。请设定您的世界观、角色并开始冒险！');
            }
        }

        // --- 事件监听器 ---
        generateButton.addEventListener('click', generateStory);
        randomizeButton.addEventListener('click', randomizeInputs); // 绑定随机生成事件
        actionInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                generateStory();
            }
        });
        
        newGameButton.addEventListener('click', startNewGame);
        clearHistoryButton.addEventListener('click', async () => {
             const confirm = await showModal(
                '确认清空历史',
                '您确定要清空当前对话历史吗？',
                true
            );

            if (confirm) {
                storyHistory = [];
                displayStory();
                updateUIState();
                showModal('清空成功', '当前对话历史已清除。');
            }
        });

        // 页面加载完成时首先显示条款模态框
        window.onload = showAcceptanceModal;
    </script>
</body>
</html>
