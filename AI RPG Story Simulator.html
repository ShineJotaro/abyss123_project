<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>abyss_123çš„AIå¥‡å¹»å†’é™©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- AdSense å¤´éƒ¨è„šæœ¬ - ğŸš¨ è¯·æ›¿æ¢ YOUR_ADSENSE_PUB_ID -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-YOUR_ADSENSE_PUB_ID" crossorigin="anonymous"></script>

    <!-- Tailwind é…ç½®: ä¿æŒåŸæœ‰é£æ ¼å¹¶å¼•å…¥ AI ä¸»é¢˜è‰² -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#4c51bf', // æ¨¡ä»¿åŸæœ‰çš„è“è‰²è°ƒ
                        'ai-sparkle': '#f97316',   // æ©™è‰²ç³»ä½œä¸ºAIæ ¸å¿ƒé¢œè‰² (Orange-600)
                        'useful': '#4f46e5',       // ç´«è‰²ç³»ç”¨äºä¿å­˜/åŠ è½½ (Indigo-600)
                        'admin-red': '#dc2626',    // çº¢è‰²ç³»ç”¨äºå±é™©æ“ä½œ (Red-600)
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- åŸºç¡€æ ·å¼è¦†ç›– -->
    <style>
        .no-scrollbar::-webkit-scrollbar {
            display: none; /* For Chrome, Safari and Opera */
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* For IE and Edge */
            scrollbar-width: none;  /* For Firefox */
        }
    </style>
    
    <!-- æ¨¡å—è„šæœ¬ 1: Firebase ä¾èµ–å¯¼å…¥ -->
    <script type="module">
        // å¯¼å…¥ Firebase æ ¸å¿ƒåŠŸèƒ½å’Œ Firestore/Auth
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, addDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // è®¾ç½® Firebase æ—¥å¿—çº§åˆ«
        setLogLevel('error'); 
        
        // å…¨å±€å˜é‡ï¼Œç”¨äºåœ¨å…¶ä»–è„šæœ¬ä¸­è®¿é—®
        window.firebase = { 
            initializeApp, 
            getAuth, signInAnonymously, onAuthStateChanged, signOut, 
            getFirestore, doc, onSnapshot, collection, query, addDoc, updateDoc, 
            setLogLevel 
        };
    </script>

    <!-- æ¨¡å—è„šæœ¬ 2: ä¸»è¦åº”ç”¨é€»è¾‘ (RPG Simulator) -->
    <script type="module">
        // ä» window.firebase ä¸­è§£æ„æ‰€æœ‰å¿…éœ€çš„å‡½æ•°
        const { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signOut, 
            getFirestore, doc, onSnapshot, collection, query, addDoc, updateDoc 
        } = window.firebase;
        
        // --- å…¨å±€å˜é‡å’Œå¸¸é‡ ---
        let db;
        let auth;
        let isAuthReady = false;
        let currentUserEmail = null; 
        let isLoggedIn = false;
        
        // ğŸš¨ VERCEL éƒ¨ç½²æ­¥éª¤ 3: GEMINI API KEY é…ç½® - Vercel ä¼šæ³¨å…¥æ­¤å€¼
        const GEMINI_API_KEY = "__VERCEL_GEMINI_API_KEY_PLACEHOLDER__"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const MAX_RETRIES = 5;
        
        let currentStory = null; // å½“å‰æ•…äº‹å¯¹è±¡: { id (optional), userId, world, character, log: [] }
        let storyLog = []; // èŠå¤©å†å²è®°å½•
        
        const systemInstruction = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„æ–‡å­—å†’é™©æ¸¸æˆ (Text-RPG) å¼•æ“ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·çš„ä¸–ç•Œè§‚è®¾å®šã€è§’è‰²å’Œè¡ŒåŠ¨ï¼Œç”Ÿæˆæ²‰æµ¸å¼çš„ã€å¯Œæœ‰ç”»é¢æ„Ÿçš„æ•…äº‹æƒ…èŠ‚ã€‚æ¯æ¬¡å“åº”å¿…é¡»ï¼š1. æè¿°ç”¨æˆ·è¡ŒåŠ¨çš„ç»“æœã€‚2. æè¿°å‘¨å›´ç¯å¢ƒçš„å˜åŒ–å’Œ NPC çš„ååº”ã€‚3. ä»¥ä¸€ä¸ªå¼€æ”¾å¼é—®é¢˜æˆ–ä¸€ä¸ªéœ€è¦ç”¨æˆ·åšå‡ºå†³å®šçš„å›°å¢ƒç»“å°¾ï¼Œå¼•å¯¼ç”¨æˆ·è¿›è¡Œä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚è¯·ä¿æŒæ•…äº‹çš„è¿è´¯æ€§å’Œä¸–ç•Œè§‚çš„ä¸€è‡´æ€§ã€‚`;

        // ğŸš¨ VERCEL éƒ¨ç½²æ­¥éª¤ 1: FIREBASE é…ç½® (é‡è¦! è¯·æ›¿æ¢ä¸‹é¢çš„æ‰€æœ‰å ä½ç¬¦)
        const firebaseConfig = {
            apiKey: "YOUR_FIREBASE_API_KEY_MUST_BE_HERE",
            authDomain: "YOUR_FIREBASE_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_FIREBASE_PROJECT_ID",
            storageBucket: "YOUR_FIREBASE_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const appId = 'rpg-story-simulator-vercel'; // Vercel éƒ¨ç½²ä½¿ç”¨å›ºå®š ID
        const initialAuthToken = null; 

        // Firestore é›†åˆè·¯å¾„ (ç§æœ‰æ•°æ®: /artifacts/{appId}/users/{userId}/user_stories)
        const getCollectionPath = (userId) => `/artifacts/${appId}/users/${userId}/user_stories`;

        // --- UI æ“ä½œå’Œæ¨¡æ€æ¡† ---

        // æ¨¡æ€æ¡†æ˜¾ç¤ºå‡½æ•°
        const showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerHTML = message; // ä½¿ç”¨ innerHTML æ”¯æŒåŠ è½½æ•…äº‹çš„HTML
            document.getElementById('modal-backdrop').classList.remove('hidden');
        };

        // UI å…ƒç´ è·å–
        const setupContainer = document.getElementById('story-setup-container');
        const interactionContainer = document.getElementById('story-interaction-container');
        const storyLogElement = document.getElementById('story-log');
        const startStoryBtn = document.getElementById('start-story-btn');
        const submitActionBtn = document.getElementById('submit-action-btn');
        const saveStoryBtn = document.getElementById('save-story-btn');
        const loadStoryBtn = document.getElementById('load-story-btn');

        // æ ¹æ®è®¤è¯çŠ¶æ€æ›´æ–° UI
        const updateUIBasedOnAuth = () => {
            const authSection = document.getElementById('auth-section');
            const welcomeText = document.getElementById('welcome-text');
            
            // æ£€æŸ¥ Firebase é…ç½®æ˜¯å¦ä¸ºå ä½ç¬¦
            const isFirebaseConfigured = !firebaseConfig.apiKey.includes('YOUR_FIREBASE');

            if (auth.currentUser) {
                // åœ¨ Vercel éƒ¨ç½²ä¸­ï¼Œæˆ‘ä»¬é»˜è®¤åªæœ‰åŒ¿åç”¨æˆ·ï¼Œé™¤éç”¨æˆ·å®ç°äº†è‡ªå®šä¹‰ç™»å½•
                isLoggedIn = !auth.currentUser.isAnonymous && isFirebaseConfigured; 
                currentUserEmail = isLoggedIn ? auth.currentUser.email : `åŒ¿åç”¨æˆ· (${auth.currentUser.uid.substring(0, 8)}...)`;
                
                authSection.innerHTML = `
                    <p class="text-sm font-medium text-gray-700">ç”¨æˆ·ID: ${auth.currentUser.uid}</p>
                    ${isLoggedIn ? 
                        `<button id="sign-out-btn" class="ml-4 px-3 py-1 bg-admin-red text-white text-sm font-medium rounded-lg hover:bg-red-700 transition">ç™»å‡º</button>` :
                        `<button id="sign-in-prompt" class="ml-4 px-3 py-1 bg-primary-blue text-white text-sm font-medium rounded-lg hover:bg-indigo-600 transition">ç™»å½•ä¿å­˜</button>`
                    }
                `;
                
                if (!isFirebaseConfigured) {
                    welcomeText.textContent = 'æ¬¢è¿ï¼Firebaseæœªé…ç½®ï¼Œä¿å­˜/åŠ è½½åŠŸèƒ½å·²ç¦ç”¨ã€‚';
                    loadStoryBtn.classList.add('hidden');
                    saveStoryBtn.classList.add('hidden');
                } else {
                    welcomeText.textContent = isLoggedIn ? `æ¬¢è¿ï¼Œ${currentUserEmail}ï¼` : 'æ¬¢è¿ï¼ŒåŒ¿åç©å®¶ï¼æ•…äº‹å°†ä¸ä¼šè¢«ä¿å­˜ã€‚';
                    
                    // ä»…ç™»å½•ç”¨æˆ·å¯ä»¥ä¿å­˜å’ŒåŠ è½½ (ä¸” Firebase å·²é…ç½®)
                    if (isLoggedIn) {
                        loadStoryBtn.classList.remove('hidden');
                        if (currentStory) saveStoryBtn.classList.remove('hidden');
                    } else {
                        loadStoryBtn.classList.add('hidden');
                        saveStoryBtn.classList.add('hidden');
                    }
                }
                
                // ç»‘å®šç™»å‡ºäº‹ä»¶
                document.getElementById('sign-out-btn')?.addEventListener('click', handleSignOut);
                // ç»‘å®šç™»å½•æç¤ºäº‹ä»¶ (æ­¤å¤„ç®€åŒ–ä¸ºæ˜¾ç¤ºæ¨¡æ€æ¡†)
                document.getElementById('sign-in-prompt')?.addEventListener('click', () => {
                     if (!isFirebaseConfigured) {
                         showModal('Firebase æœªé…ç½®', 'è¯·å…ˆé…ç½®æ‚¨çš„ Firebase é¡¹ç›®æ‰èƒ½å¯ç”¨ç™»å½•å’Œä¿å­˜åŠŸèƒ½ã€‚');
                     } else {
                         showModal('ç™»å½•ä¿å­˜', 'å½“å‰ä»…æ”¯æŒåŒ¿åç”¨æˆ·ã€‚å¦‚éœ€çœŸæ­£çš„ç”¨æˆ·ç™»å½•åŠŸèƒ½ï¼Œæ‚¨éœ€è¦é›†æˆ Firebase Email/Password æˆ– Google ç™»å½•ã€‚');
                     }
                });

            }
        };

        // ç™»å‡ºå¤„ç†
        const handleSignOut = async () => {
            try {
                await signOut(auth);
                // ç™»å‡ºåé‡ç½®ä¸ºåŒ¿åç”¨æˆ·
                await signInAnonymously(auth);
                showModal('ç™»å‡ºæˆåŠŸ', 'æ‚¨å·²ç™»å‡ºï¼Œå½“å‰ä»¥åŒ¿åèº«ä»½ç»§ç»­ã€‚');
                currentStory = null; // æ¸…é™¤å½“å‰æ•…äº‹çŠ¶æ€
                updateUIBasedOnAuth();
            } catch (error) {
                console.error("ç™»å‡ºå¤±è´¥:", error);
                showModal('ç™»å‡ºå¤±è´¥', `ç™»å‡ºé”™è¯¯: ${error.message}`);
            }
        };

        // Firebase åˆå§‹åŒ– - æ³¨æ„ï¼šæ­¤å‡½æ•°ä¸å†åœ¨ DOMContentLoaded ä¸­è‡ªåŠ¨è°ƒç”¨
        const initializeFirebase = async () => {
            try {
                // æ£€æŸ¥ Firebase é…ç½®æ˜¯å¦ä¸ºå ä½ç¬¦
                if (firebaseConfig.apiKey.includes('YOUR_FIREBASE')) {
                    console.warn("Firebase é…ç½®æœªè®¾ç½®ã€‚è·³è¿‡åˆå§‹åŒ–ã€‚ä¿å­˜/åŠ è½½åŠŸèƒ½å°†ç¦ç”¨ã€‚");
                    document.getElementById('loading-indicator').classList.add('hidden');
                    document.getElementById('main-content').classList.remove('hidden');
                    updateUIBasedOnAuth(); // æ›´æ–°UIä»¥åæ˜ æœªé…ç½®çŠ¶æ€
                    return; 
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Vercel ç¯å¢ƒä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨åŒ¿åç™»å½•
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    updateUIBasedOnAuth();
                });
                
            } catch (error) {
                console.error("Firebase åˆå§‹åŒ–å¤±è´¥:", error);
                showModal("åˆå§‹åŒ–é”™è¯¯", `Firebase åˆå§‹åŒ–å¤±è´¥ã€‚è¯·æ£€æŸ¥æ‚¨çš„é…ç½®ã€‚é”™è¯¯: ${error.message}`);
            } finally {
                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            }
        };
        
        // å»¶è¿Ÿå‡½æ•°
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // å°è£…çš„ Gemini API è°ƒç”¨å‡½æ•° (åŒ…å«æŒ‡æ•°é€€é¿é€»è¾‘)
        const callGeminiApi = async (contents, systemInstruction) => {
            // ğŸš¨ æ£€æŸ¥ API å¯†é’¥æ˜¯å¦å·²æ³¨å…¥
            if (GEMINI_API_KEY === "__VERCEL_GEMINI_API_KEY_PLACEHOLDER__" || !GEMINI_API_KEY) {
                throw new Error("API å¯†é’¥æœªé…ç½®ã€‚è¯·åœ¨ Vercel ç¯å¢ƒå˜é‡ä¸­è®¾ç½® GEMINI_API_KEYã€‚");
            }

            const payload = {
                contents: contents,
                config: {
                    systemInstruction: systemInstruction,
                },
            };

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) {
                            return text;
                        }
                        throw new Error("APIè¿”å›ç»“æ„ä¸å®Œæ•´æˆ–æ— æ–‡æœ¬å†…å®¹");
                    } 
                    
                    // å¤„ç†é€Ÿç‡é™åˆ¶ (429) æˆ–ç¬æ—¶é”™è¯¯ (5xx)
                    if (response.status === 429 || (response.status >= 500 && response.status < 600)) {
                        if (attempt < MAX_RETRIES - 1) {
                            const backoffTime = Math.pow(2, attempt) * 1000;
                            await delay(backoffTime);
                            continue; 
                        }
                    }
                    
                    // å¤„ç†éé‡è¯•é”™è¯¯
                    const errorBody = await response.json();
                    throw new Error(`APIé”™è¯¯: ${response.status} - ${errorBody.error?.message || 'æœªçŸ¥é”™è¯¯'}`);

                } catch (error) {
                    if (attempt === MAX_RETRIES - 1) {
                        throw error;
                    }
                    // ç½‘ç»œé”™è¯¯ï¼Œé‡è¯•
                    const backoffTime = Math.pow(2, attempt) * 1000;
                    await delay(backoffTime);
                }
            }
            throw new Error("è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°");
        };

        // --- RPG æ ¸å¿ƒé€»è¾‘ (ä¿æŒä¸å˜) ---

        // æ¸²æŸ“æ•…äº‹æ—¥å¿—
        const appendLog = (role, text) => {
            const logContainer = storyLogElement;
            const roleClass = role === 'user' 
                ? 'bg-primary-blue/10 text-primary-blue self-end text-right' 
                : 'bg-gray-100 text-gray-800 self-start text-left';
            const roleLabel = role === 'user' ? 'æˆ‘çš„è¡ŒåŠ¨' : 'AI æ•…äº‹';
            
            const logEntry = document.createElement('div');
            logEntry.className = `max-w-[90%] p-3 rounded-xl shadow-sm ${roleClass}`;
            logEntry.innerHTML = `<span class="font-semibold text-xs ${role === 'user' ? 'text-primary-blue' : 'text-ai-sparkle'}">${roleLabel}:</span><p class="mt-1 whitespace-pre-wrap">${text}</p>`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight; // æ»šåŠ¨åˆ°åº•éƒ¨
        };

        // æ¸²æŸ“å®Œæ•´çš„å†å²è®°å½•
        const renderStoryLog = (log) => {
            storyLogElement.innerHTML = ''; // æ¸…ç©º
            log.forEach(entry => {
                if (entry.role === 'user' || entry.role === 'model') {
                    const text = entry.parts.map(p => p.text).join('\n');
                    appendLog(entry.role === 'model' ? 'ai' : 'user', text);
                }
            });
        };

        // å¼€å§‹æ–°æ¸¸æˆ
        const startNewStory = async (worldSetting, characterName, openingAction) => {
            setupContainer.classList.add('hidden');
            interactionContainer.classList.remove('hidden');
            storyLogElement.innerHTML = ''; 
            
            const fullPrompt = `ä¸–ç•Œè§‚: ${worldSetting}. è§’è‰²: ${characterName}. å¼€åœºè¡ŒåŠ¨: ${openingAction}.`;
            
            // åˆå§‹åŒ–æ•…äº‹æ—¥å¿—ï¼ŒAIä½¿ç”¨System Instruction
            storyLog = [{ role: "user", parts: [{ text: fullPrompt }] }];
            
            // æ˜¾ç¤ºç”¨æˆ·è¾“å…¥
            appendLog('user', `ä¸–ç•Œè§‚: ${worldSetting} | è§’è‰²: ${characterName}<br>å¼€åœºè¡ŒåŠ¨: ${openingAction}`);

            try {
                submitActionBtn.disabled = true;
                submitActionBtn.textContent = 'AI æ€è€ƒä¸­...';
                startStoryBtn.disabled = true; // ç¦ç”¨å¼€å§‹æŒ‰é’®ç›´åˆ°AIå“åº”

                // ä½¿ç”¨å®‰å…¨çš„ API è°ƒç”¨å‡½æ•°
                const aiText = await callGeminiApi(storyLog, systemInstruction);
                
                appendLog('ai', aiText);
                
                // å°†AIå“åº”æ·»åŠ åˆ°æ—¥å¿—
                storyLog.push({ role: "model", parts: [{ text: aiText }] });
                
                // é‡ç½®æŒ‰é’®å’ŒçŠ¶æ€
                submitActionBtn.disabled = false;
                submitActionBtn.textContent = 'â–¶ï¸ è¡ŒåŠ¨';
                startStoryBtn.disabled = false;
                
                // å‡†å¤‡æ•…äº‹å¯¹è±¡
                currentStory = {
                    world: worldSetting,
                    character: characterName,
                    log: storyLog, 
                    timestamp: Date.now()
                };

                // å¦‚æœå·²ç™»å½•ï¼Œæ˜¾ç¤ºä¿å­˜æŒ‰é’®
                if (isLoggedIn) {
                    currentStory.userId = auth.currentUser.uid;
                    saveStoryBtn.classList.remove('hidden');
                } else {
                    saveStoryBtn.classList.add('hidden');
                }
                
            } catch (error) {
                console.error("Gemini AI é”™è¯¯:", error);
                // å°è¯•æ˜¾ç¤ºæ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                const errorMessage = error.message.includes("API å¯†é’¥æœªé…ç½®") ? 
                                     "AI æ•…äº‹ç”Ÿæˆå¤±è´¥ã€‚è¯·ç¡®ä¿æ‚¨çš„ Vercel ç¯å¢ƒå˜é‡å·²æ­£ç¡®é…ç½®ã€‚" : 
                                     `AI æ•…äº‹ç”Ÿæˆå¤±è´¥ã€‚é”™è¯¯ä¿¡æ¯: ${error.message}`;
                appendLog('error', errorMessage);
                submitActionBtn.disabled = false;
                submitActionBtn.textContent = 'â–¶ï¸ è¡ŒåŠ¨';
                startStoryBtn.disabled = false;
            }
        };

        // ç»§ç»­æ•…äº‹
        const continueStory = async (userAction) => {
            if (!storyLog.length) return; 

            appendLog('user', userAction);
            
            // æ·»åŠ ç”¨æˆ·è¡ŒåŠ¨åˆ°æ—¥å¿—
            storyLog.push({ role: "user", parts: [{ text: userAction }] });
            
            try {
                submitActionBtn.disabled = true;
                submitActionBtn.textContent = 'AI æ€è€ƒä¸­...';
                
                // ä½¿ç”¨å®‰å…¨çš„ API è°ƒç”¨å‡½æ•°
                const aiText = await callGeminiApi(storyLog, systemInstruction);
                
                appendLog('ai', aiText);
                
                // å°†AIå“åº”æ·»åŠ åˆ°æ—¥å¿—
                storyLog.push({ role: "model", parts: [{ text: aiText }] });
                
                // å¦‚æœæ•…äº‹å·²åˆå§‹åŒ–ï¼Œæ›´æ–° log å­—æ®µ
                if (currentStory) {
                    currentStory.log = storyLog;
                }

                document.getElementById('user-action').value = ''; 
                submitActionBtn.disabled = false;
                submitActionBtn.textContent = 'â–¶ï¸ è¡ŒåŠ¨';

            } catch (error) {
                console.error("Gemini AI é”™è¯¯:", error);
                const errorMessage = error.message.includes("API å¯†é’¥æœªé…ç½®") ? 
                                     "AI æ•…äº‹ç”Ÿæˆå¤±è´¥ã€‚è¯·ç¡®ä¿æ‚¨çš„ Vercel ç¯å¢ƒå˜é‡å·²æ­£ç¡®é…ç½®ã€‚" : 
                                     `AI æ•…äº‹ç”Ÿæˆå¤±è´¥ã€‚é”™è¯¯ä¿¡æ¯: ${error.message}`;
                appendLog('error', errorMessage);
                submitActionBtn.disabled = false;
                submitActionBtn.textContent = 'â–¶ï¸ è¡ŒåŠ¨';
            }
        };

        // ä¿å­˜æ•…äº‹
        const handleSaveStory = async () => {
            if (!currentStory || !isLoggedIn || !auth.currentUser) {
                showModal('ä¿å­˜å¤±è´¥', 'è¯·å…ˆç™»å½•æˆ–ç¡®ä¿ Firebase å·²æ­£ç¡®é…ç½®æ‰èƒ½ä¿å­˜æ•…äº‹ã€‚');
                return;
            }
            
            try {
                const userId = auth.currentUser.uid;
                const collectionRef = collection(db, getCollectionPath(userId));

                if (currentStory.id) {
                    // æ›´æ–°ç°æœ‰æ•…äº‹
                    const storyRef = doc(db, getCollectionPath(userId), currentStory.id);
                    await updateDoc(storyRef, { 
                        log: currentStory.log, 
                        timestamp: Date.now() 
                    });
                    showModal('ä¿å­˜æˆåŠŸ', 'æ‚¨çš„å†’é™©å·²æ›´æ–°ï¼');
                } else {
                    // é¦–æ¬¡ä¿å­˜
                    const newDoc = await addDoc(collectionRef, {
                        userId: userId,
                        world: currentStory.world,
                        character: currentStory.character,
                        log: currentStory.log,
                        timestamp: Date.now()
                    });
                    currentStory.id = newDoc.id; // ä¿å­˜IDä»¥ä¾¿åç»­æ›´æ–°
                    showModal('ä¿å­˜æˆåŠŸ', 'æ‚¨çš„æ–°å†’é™©å·²ä¿å­˜ï¼');
                    saveStoryBtn.classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('ä¿å­˜æ•…äº‹å¤±è´¥:', error);
                showModal('ä¿å­˜å¤±è´¥', `æ— æ³•ä¿å­˜æ•…äº‹: ${error.message}`);
            }
        };

        // åŠ è½½æ•…äº‹åˆ—è¡¨ (ä½¿ç”¨ onSnapshot ç›‘å¬ç”¨æˆ·æ•…äº‹)
        const handleLoadStory = () => {
            if (!isLoggedIn || !auth.currentUser) {
                showModal('åŠ è½½å¤±è´¥', 'è¯·å…ˆç™»å½•æˆ–ç¡®ä¿ Firebase å·²æ­£ç¡®é…ç½®æ‰èƒ½æŸ¥çœ‹å·²ä¿å­˜çš„æ•…äº‹ã€‚');
                return;
            }

            const userId = auth.currentUser.uid;
            const storiesRef = collection(db, getCollectionPath(userId));
            const q = query(storiesRef);

            // ç›‘å¬æ–‡æ¡£å˜åŒ–
            const unsubscribe = onSnapshot(q, (snapshot) => {
                let storyListHTML = `
                    <p class="mb-4 text-gray-600">é€‰æ‹©ä¸€ä¸ªæ‚¨æƒ³ç»§ç»­çš„å†’é™©ï¼š</p>
                    <div class="space-y-3 max-h-64 overflow-y-auto p-2 border rounded-lg bg-gray-50" id="actual-story-list">
                `;
                
                if (snapshot.empty) {
                    storyListHTML += '<p class="text-center py-4 text-gray-500">æ²¡æœ‰å·²ä¿å­˜çš„æ•…äº‹ã€‚</p>';
                } else {
                    snapshot.docs.forEach(doc => {
                        const story = doc.data();
                        const date = new Date(story.timestamp).toLocaleDateString();
                        // æ³¨æ„ï¼šä¸ºäº†é¿å… JSON.stringify/parse åµŒå¥—é—®é¢˜ï¼Œè¿™é‡Œç›´æ¥ä» doc.data() è·å–ï¼Œå¹¶åœ¨äº‹ä»¶ç›‘å¬ä¸­è§£æ
                        storyListHTML += `
                            <button data-id="${doc.id}" data-log='${JSON.stringify(story.log)}' data-world="${story.world}" data-character="${story.character}" 
                                    class="load-story-item w-full text-left p-3 bg-white hover:bg-useful/10 border border-gray-200 rounded-lg transition duration-150">
                                <span class="font-bold text-lg text-primary-blue">${story.world}</span> - 
                                <span class="text-sm text-ai-sparkle">${story.character}</span>
                                <span class="block text-xs text-gray-500">ä¸Šæ¬¡ä¿å­˜: ${date}</span>
                            </button>
                        `;
                    });
                }
                
                storyListHTML += '</div>';

                // æ›¿æ¢æ¨¡æ€æ¡†å†…å®¹å¹¶æ˜¾ç¤º
                showModal('ğŸ“š åŠ è½½æ•…äº‹', storyListHTML);
                
                // ç»‘å®šåŠ è½½äº‹ä»¶
                document.querySelectorAll('.load-story-item').forEach(btn => {
                    btn.onclick = () => {
                        const storyId = btn.dataset.id;
                        // è§£ææ•…äº‹æ—¥å¿—
                        let logData;
                        try {
                            logData = JSON.parse(btn.dataset.log);
                        } catch (e) {
                            console.error("æ•…äº‹æ—¥å¿—è§£æå¤±è´¥", e);
                            logData = [];
                        }
                        const world = btn.dataset.world;
                        const character = btn.dataset.character;

                        // è®¾ç½®å½“å‰æ•…äº‹çŠ¶æ€
                        currentStory = {
                            id: storyId,
                            userId: auth.currentUser.uid,
                            world: world,
                            character: character,
                            log: logData,
                            timestamp: Date.now()
                        };
                        storyLog = logData;
                        
                        // æ›´æ–°UI
                        document.getElementById('modal-backdrop').classList.add('hidden');
                        setupContainer.classList.add('hidden');
                        interactionContainer.classList.remove('hidden');
                        saveStoryBtn.classList.remove('hidden');
                        renderStoryLog(storyLog);
                        
                        unsubscribe(); // åœæ­¢ç›‘å¬
                    };
                });
            }, (error) => {
                console.error("åŠ è½½æ•…äº‹åˆ—è¡¨å¤±è´¥:", error);
                showModal('åŠ è½½å¤±è´¥', `æ— æ³•è·å–æ•…äº‹åˆ—è¡¨: ${error.message}`);
                unsubscribe();
            });
            
            // ç¡®ä¿å…³é—­æ¨¡æ€æ¡†æ—¶åœæ­¢ç›‘å¬
            const originalModalCloseHandler = document.getElementById('modal-close-btn').onclick;
            document.getElementById('modal-close-btn').onclick = () => {
                document.getElementById('modal-backdrop').classList.add('hidden');
                unsubscribe();
                document.getElementById('modal-close-btn').onclick = originalModalCloseHandler; // æ¢å¤åŸå§‹è¡Œä¸º
            };
        };

       // T&C æ¨¡æ€æ¡†æ£€æŸ¥
const checkTermsAndConditions = () => {
    const accepted = sessionStorage.getItem('T&C_Accepted') === 'true';
    const termsModalBackdrop = document.getElementById('terms-and-conditions-modal');
    const acceptBtn = termsModalBackdrop.querySelector('#accept-terms-btn');
    const declineBtn = termsModalBackdrop.querySelector('#decline-terms-btn');

    if (accepted) {
        termsModalBackdrop.classList.add('hidden');
        document.getElementById('loading-indicator').classList.remove('hidden'); 
        initializeFirebase();
    } else {
        termsModalBackdrop.classList.remove('hidden');
        
        // Handle Accept
        acceptBtn.addEventListener('click', () => {
            sessionStorage.setItem('T&C_Accepted', 'true');
            termsModalBackdrop.classList.add('hidden');
            document.getElementById('loading-indicator').classList.remove('hidden');
            initializeFirebase();
        }, { once: true });
        
        // Handle Decline - è·³è½¬åˆ°é¦–é¡µ
        declineBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        }, { once: true });
    }
};


        // --- åˆå§‹åŒ–å’Œäº‹ä»¶ç»‘å®š ---

        document.addEventListener('DOMContentLoaded', () => {
            // â€¼ï¸ å…³é”®å˜æ›´ï¼šä¸å†åœ¨æ­¤å¤„åˆå§‹åŒ– Firebaseï¼Œè€Œæ˜¯äº¤ç»™ checkTermsAndConditions å¤„ç†
            // initializeFirebase(); 

            // 1. æ•…äº‹è®¾å®šè¡¨å• (å¯åŠ¨æ•…äº‹)
            document.getElementById('setup-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const world = document.getElementById('world-setting').value.trim();
                const character = document.getElementById('character-name').value.trim();
                const action = document.getElementById('opening-action').value.trim();
                startNewStory(world, character, action);
            });
            
            // 2. ç”¨æˆ·è¡ŒåŠ¨è¡¨å• (ç»§ç»­æ•…äº‹)
            document.getElementById('action-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const userAction = document.getElementById('user-action').value.trim();
                if (userAction && storyLog.length > 0) {
                    // æ¸…ç©ºè¾“å…¥æ¡†å†…å®¹
                    document.getElementById('user-action').value = '';
                    continueStory(userAction);
                }
            });
            
            // 3. é‡æ–°å¼€å§‹æŒ‰é’®
            document.getElementById('new-game-btn').addEventListener('click', () => {
                interactionContainer.classList.add('hidden');
                setupContainer.classList.remove('hidden');
                document.getElementById('story-log').innerHTML = '<p class="text-gray-500 italic">åœ¨æ­¤è¾“å…¥æ‚¨çš„æ•…äº‹è®¾å®šä»¥ä¸Šæ–¹å¼€å§‹å†’é™©...</p>';
                document.getElementById('setup-form').reset();
                currentStory = null;
                storyLog = [];
                saveStoryBtn.classList.add('hidden');
            });
            
            // 4. ä¿å­˜æ•…äº‹æŒ‰é’®
            saveStoryBtn.addEventListener('click', handleSaveStory);
            
            // 5. åŠ è½½æ•…äº‹æŒ‰é’®
            loadStoryBtn.addEventListener('click', handleLoadStory);
            
            // 6. æ¨¡æ€æ¡†å…³é—­ (é€šç”¨å…³é—­é€»è¾‘)
            document.getElementById('modal-close-btn').onclick = () => {
                document.getElementById('modal-backdrop').classList.add('hidden');
            };

            // 7. æ£€æŸ¥ T&C çŠ¶æ€å¹¶å¼€å§‹æµç¨‹
            checkTermsAndConditions();
        });
    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans flex flex-col">

    <!-- é¡¶å±‚æ¨¡æ€æ¡† (T&C) -->
    <div id="terms-and-conditions-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 m-4">
            <h1 class="text-3xl font-bold text-center text-ai-sparkle border-b-2 pb-2 mb-4">AIå†’é™©æ¨¡æ‹Ÿå™¨æœåŠ¡æ¡æ¬¾</h1>
            
            <!-- æ ¸å¿ƒå…è´£å£°æ˜ (ä¸ food_recommendations ä¿æŒä¸€è‡´çš„é£æ ¼å’Œå†…å®¹) -->
            <p class="font-medium text-red-600 border-l-4 border-red-500 pl-3 py-1 bg-red-50/50 mb-4">
                **æ ¸å¿ƒå…è´£å£°æ˜:** æœ¬ç½‘ç«™æ‰€æœ‰æ•…äº‹å†…å®¹å‡ç”± **Gemini AI æ¨¡å‹å®æ—¶ç”Ÿæˆ**ï¼Œå¹¶åŸºäºç”¨æˆ·è¾“å…¥çš„â€œä¸–ç•Œè§‚â€å’Œâ€œè¡ŒåŠ¨â€ã€‚
                æˆ‘ä»¬ä¸å¯¹ AI ç”Ÿæˆå†…å®¹ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºæš´åŠ›ã€æƒŠæ‚šã€ä¸å‡†ç¡®æˆ–å†’çŠ¯æ€§å†…å®¹ï¼‰çš„çœŸå®æ€§ã€é€‚å®œæ€§æˆ–æ³•å¾‹åæœæ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚
                **ğŸš¨ é£é™©æç¤º:** æ‚¨çš„ Gemini API Key å°†åœ¨å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰ä¸­å…¬å¼€ã€‚è¯·ä»…ä½¿ç”¨ä¸€ä¸ªä¸“ç”¨äºæ­¤é¡¹ç›®çš„ API Keyï¼Œå¹¶å®æ–½ IP é™åˆ¶ä»¥é™ä½é£é™©ã€‚
                ç”¨æˆ·å¿…é¡»å¯¹è‡ªå·±çš„è¾“å…¥å’Œç”Ÿæˆçš„è¾“å‡ºå†…å®¹è´Ÿè´£ã€‚æ‚¨å¿…é¡»æ¥å—æ­¤æ¡æ¬¾æ‰èƒ½ç»§ç»­ä½¿ç”¨æœ¬ç½‘ç«™ã€‚
            </p>

            <div class="space-y-3 text-sm text-gray-700 max-h-60 overflow-y-auto pr-2">
                <h3 class="font-bold text-base mt-2">1. è®¸å¯ä¸é™åˆ¶</h3>
                <p>æ‚¨è¢«æˆäºˆä½¿ç”¨æœ¬ AI æ¨¡æ‹Ÿå™¨çš„éæ’ä»–æ€§ã€ä¸å¯è½¬è®©çš„è®¸å¯ã€‚ç¦æ­¢å¯¹æœ¬ç½‘ç«™ä»£ç è¿›è¡Œé€†å‘å·¥ç¨‹ã€å¤åˆ¶æˆ–åˆ†å‘ã€‚æ‰€æœ‰ AI æ¨¡å‹å’Œåº•å±‚æŠ€æœ¯å‡ä¸º Google æˆ–å…¶è®¸å¯æ–¹çš„è´¢äº§ã€‚</p>
                <h3 class="font-bold text-base mt-2">2. å†…å®¹æ‰€æœ‰æƒ</h3>
                <p>æ‚¨å¯¹æ‚¨çš„è¾“å…¥å†…å®¹ï¼ˆä¸–ç•Œè§‚ã€è§’è‰²ã€è¡ŒåŠ¨ï¼‰æ‹¥æœ‰æ‰€æœ‰æƒã€‚æ‚¨åŒæ„æˆ‘ä»¬ä¸ºæä¾›æœåŠ¡ã€æ”¹è¿›æ¨¡å‹å’Œè¿›è¡Œæ•°æ®åˆ†æè€Œå¤„ç†å’Œå­˜å‚¨è¿™äº›å†…å®¹ã€‚</p>
                <h3 class="font-bold text-base mt-2">3. ç”¨æˆ·è¡Œä¸º</h3>
                <p>ç¦æ­¢è¾“å…¥æˆ–è¦æ±‚ç”Ÿæˆä»»ä½•éæ³•ã€æœ‰å®³ã€è¯½è°¤æˆ–ä»‡æ¨è¨€è®ºçš„å†…å®¹ã€‚æˆ‘ä»¬å°†å¯¹æ¶æ„æ»¥ç”¨è¡Œä¸ºä¿ç•™åœæ­¢æœåŠ¡çš„æƒåˆ©ï¼Œå¹¶å¯èƒ½å‘ç›¸å…³éƒ¨é—¨æŠ¥å‘Šã€‚</p>
                <h3 class="font-bold text-base mt-2">4. æ•°æ®ä¿å­˜</h3>
                <p>ç™»å½•ç”¨æˆ·ï¼ˆé€šè¿‡ Firebase è®¤è¯ï¼‰çš„æ•…äº‹å°†è¢«ä¿å­˜è‡³ Firebase Firestoreã€‚åŒ¿åç”¨æˆ·çš„æ•…äº‹åœ¨ä¼šè¯ç»“æŸåå°†ä¸ä¼šè¢«ä¿å­˜ã€‚æ‰€æœ‰ä¿å­˜çš„æ•°æ®å‡éµå¾ª Firebase å’Œæœ¬æœåŠ¡çš„éšç§æ”¿ç­–ã€‚</p>
                <h3 class="font-bold text-base mt-2">5. æœåŠ¡å…è´£</h3>
                <p>æœ¬æœåŠ¡æŒ‰â€œåŸæ ·â€æä¾›ã€‚æˆ‘ä»¬ä¸ä¿è¯æœåŠ¡çš„è¿ç»­æ€§æˆ– AI ç”Ÿæˆå†…å®¹çš„å‡†ç¡®æ€§ã€‚ä½¿ç”¨æœ¬æœåŠ¡å³è¡¨ç¤ºæ‚¨ç†è§£å¹¶æ‰¿æ‹…æ‰€æœ‰é£é™©ã€‚åœ¨ä»»ä½•æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸æ‰¿æ‹…å› ä½¿ç”¨æœ¬æœåŠ¡è€Œäº§ç”Ÿçš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥æŸå®³ã€‚</p>
            </div>

            <div class="flex justify-between mt-6">
                <!-- ğŸš¨ ID å·²ä» not-accept-terms-btn æ›´æ”¹ä¸º decline-terms-btn -->
                <button id="decline-terms-btn" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition font-semibold">
                    æ‹’ç» (è¿”å›é¦–é¡µ)
                </button>
                <button id="accept-terms-btn" class="px-6 py-2 bg-ai-sparkle text-white rounded-lg hover:bg-orange-600 transition font-semibold">
                    æˆ‘æ¥å— (å¼€å§‹å†’é™©)
                </button>
            </div>
        </div>
    </div>

    <!-- é¡¶å±‚æ¨¡æ€æ¡† (é€šç”¨æ¶ˆæ¯) -->
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 m-4">
            <h2 id="modal-title" class="text-2xl font-bold text-primary-blue mb-3">æ¶ˆæ¯</h2>
            <p id="modal-message" class="text-gray-700 whitespace-pre-wrap"></p>
            <div class="mt-4 flex justify-end">
                <button id="modal-close-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- é¡µé¢å†…å®¹ -->
    <div class="container mx-auto p-4 md:p-8 max-w-3xl flex-grow">

        <!-- å¤´éƒ¨å¯¼èˆªå’Œè®¤è¯ä¿¡æ¯ -->
        <header class="flex flex-col sm:flex-row justify-between items-center pb-6 border-b border-gray-200">
            <div class="mb-4 sm:mb-0 text-center sm:text-left">
                <h1 class="text-4xl font-extrabold text-gray-900">AI å†’é™©æ¨¡æ‹Ÿå™¨</h1>
                <p class="text-lg text-ai-sparkle mt-1">
                    ç”± Gemini é©±åŠ¨çš„äº¤äº’å¼ Text-RPG
                </p>
            </div>
            
            <div class="text-right text-sm space-y-1">
                <p id="welcome-text" class="text-gray-800 font-medium">åŠ è½½ä¸­...</p>
                <div id="auth-section" class="flex items-center justify-end">
                    <!-- Auth UI will be rendered here -->
                </div>
            </div>
        </header>

        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
        <div id="loading-indicator" class="flex justify-center items-center h-48">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary-blue"></div>
            <p class="ml-4 text-primary-blue">æ­£åœ¨è¿æ¥ Firebase å’Œ AI æ¨¡å‹...</p>
        </div>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div id="main-content" class="hidden mt-8">
            
            <!-- æ•…äº‹åˆ›å»º/è¾“å…¥åŒºåŸŸ -->
            <div id="story-setup-container" class="p-6 bg-white shadow-xl rounded-xl border border-ai-sparkle/30">
                <h2 class="text-2xl font-semibold mb-4 text-ai-sparkle">ğŸŒ æ•…äº‹ä¸–ç•Œè§‚è®¾å®š</h2>
                <p class="text-sm text-gray-600 mb-4">è¾“å…¥æ‚¨çš„ä¸–ç•Œå’Œè§’è‰²ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆå¼€åœºæ•…äº‹ã€‚</p>
                <form id="setup-form" class="space-y-4">
                    <input type="text" id="world-setting" placeholder="ä¸–ç•Œè§‚ (ä¾‹å¦‚: èµ›åšæœ‹å…‹éƒ½å¸‚, é­”æ³•ä¸­ä¸–çºª, æœ«ä¸–åºŸåœŸ)" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-ai-sparkle focus:border-ai-sparkle transition" value="ä¸€ä¸ªå……æ»¡é¾™ä¸é­”æ³•çš„ä¼ ç»Ÿå¥‡å¹»ä¸–ç•Œ">
                    <input type="text" id="character-name" placeholder="æ‚¨çš„è§’è‰² (ä¾‹å¦‚: æ¸¸ä¾ , è§ä¹ é­”æ³•å¸ˆ, å •è½éª‘å£«)" required 
                           class="w-full p-3 border border-gray-300 rounded-lg focus:ring-ai-sparkle focus:border-ai-sparkle transition" value="ä¸€ååˆå‡ºèŒ…åºçš„å¹´è½»æˆ˜å£«">
                    <textarea id="opening-action" placeholder="æ•…äº‹å¼€å¤´è¡ŒåŠ¨ (ä¾‹å¦‚: æˆ‘èµ°è¿›ä¸€å®¶åä¸º'è“æœˆäº®'çš„é…’é¦†, æˆ‘åœ¨æ£®æ—ä¸­é†’æ¥)" rows="2" required 
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-ai-sparkle focus:border-ai-sparkle transition">æˆ‘æ¥åˆ°ä¸€ä¸ªåä¸ºâ€œé£æš´ä¹‹å¢™â€çš„å°æ‘åº„ï¼Œå‡†å¤‡å¯»æ‰¾ä¸€ä¸ªä»»åŠ¡ã€‚</textarea>
                    
                    <button type="submit" id="start-story-btn" class="w-full py-3 bg-ai-sparkle text-white font-bold rounded-lg hover:bg-orange-600 transition duration-150 shadow-md">
                        ğŸš€ å¼€å§‹æ–°æ•…äº‹
                    </button>
                    <button type="button" id="load-story-btn" class="w-full py-3 bg-useful text-white font-bold rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md hidden">
                        ğŸ“š åŠ è½½å·²ä¿å­˜çš„æ•…äº‹
                    </button>
                </form>
            </div>
            
            <!-- æ•…äº‹äº’åŠ¨åŒºåŸŸ -->
            <div id="story-interaction-container" class="p-6 bg-white shadow-xl rounded-xl border border-gray-300 hidden mt-6">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">ğŸ“– æ•…äº‹æ—¥å¿—</h2>
                <div id="story-log" class="space-y-4 max-h-[60vh] h-[400px] overflow-y-auto p-3 no-scrollbar border border-gray-200 rounded-lg bg-gray-50 mb-4 flex flex-col">
                    <!-- AIç”Ÿæˆçš„æ•…äº‹å’Œç”¨æˆ·è¡ŒåŠ¨å°†åœ¨æ­¤å¤„æ¸²æŸ“ -->
                    <p class="text-gray-500 italic">åœ¨æ­¤è¾“å…¥æ‚¨çš„æ•…äº‹è®¾å®šä»¥ä¸Šæ–¹å¼€å§‹å†’é™©...</p>
                </div>

                <form id="action-form" class="flex space-x-2">
                    <input type="text" id="user-action" placeholder="è¾“å…¥æ‚¨çš„è¡ŒåŠ¨å¹¶æŒ‰å›è½¦ (ä¾‹å¦‚: æˆ‘æ‹”å‡ºå‰‘æ”»å‡»ä»–, æˆ‘é€‰æ‹©ä¼‘æ¯)" required 
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-primary-blue focus:border-primary-blue transition">
                    <button type="submit" id="submit-action-btn" class="px-6 py-3 bg-primary-blue text-white font-bold rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                        â–¶ï¸ è¡ŒåŠ¨
                    </button>
                </form>

                <div class="mt-4 flex justify-between">
                    <button type="button" id="new-game-btn" class="px-4 py-2 bg-admin-red text-white rounded-lg hover:bg-red-700 transition duration-150 shadow-sm">
                        ğŸ”„ é‡æ–°å¼€å§‹
                    </button>
                    <button type="button" id="save-story-btn" class="px-4 py-2 bg-useful text-white rounded-lg hover:bg-indigo-600 transition duration-150 shadow-sm hidden">
                        ğŸ’¾ ä¿å­˜æ•…äº‹
                    </button>
                </div>
            </div>

            
                
 <!-- å¹¿å‘Šå®¹å™¨ (ç½‘ç«™æœ€ä¸‹æ–¹) -->
        <div class="max-w-4xl mx-auto p-4 sm:p-8 mt-12">
            <div class="ads-container p-4 bg-gray-100 rounded-xl text-center">
                <p class="text-sm text-gray-500 mb-2">å¹¿å‘ŠèµåŠ©å•†å†…å®¹</p>
                <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9923429709566940"
                    crossorigin="anonymous"></script>
                <ins class="adsbygoogle"
                    style="display:block; min-height: 100px;"
                    data-ad-format="autorelaxed"
                    data-ad-client="ca-pub-9923429709566940"
                    data-ad-slot="7327876978"></ins>
                <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                </script>
            </div>
        </div>
    </div>

    <!-- åœ¨å¹¿å‘Šå®¹å™¨åæ·»åŠ è¿™ä¸ªé¡µè„š -->
<footer class="max-w-4xl mx-auto p-4 mt-8 border-t border-gray-200">
    <div class="text-center text-sm text-gray-500">
        <div class="flex justify-center space-x-6 mb-4">
            <a href="privacy-policy.html" class="hover:text-primary-blue transition">éšç§æ”¿ç­–</a>
            <a href="terms-of-service.html" class="hover:text-primary-blue transition">æœåŠ¡æ¡æ¬¾</a>
            <a href="contact.html" class="hover:text-primary-blue transition">è”ç³»æˆ‘ä»¬</a>
        </div>
        <p>&copy; 2025 abyss_123. ä¿ç•™æ‰€æœ‰æƒåˆ©.</p>
    </div>
</footer>
</body>
</html>


